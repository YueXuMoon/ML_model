<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.25">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Netflix User Churn Prediction Project</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" integrity="sha384-ZvpUoO/+PpLXR1lu4jmpXWu80pZlYUAfxl5NsBMWOEPSjUn/6Z/hRTt8+pR6L4N2" crossorigin="anonymous"></script><script src="random_forest_files/libs/clipboard/clipboard.min.js"></script>
<script src="random_forest_files/libs/quarto-html/quarto.js" type="module"></script>
<script src="random_forest_files/libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="random_forest_files/libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="random_forest_files/libs/quarto-html/popper.min.js"></script>
<script src="random_forest_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="random_forest_files/libs/quarto-html/anchor.min.js"></script>
<link href="random_forest_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="random_forest_files/libs/quarto-html/quarto-syntax-highlighting-7b89279ff1a6dce999919e0e67d4d9ec.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="random_forest_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="random_forest_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="random_forest_files/libs/bootstrap/bootstrap-d6a003b94517c951b2d65075d42fb01b.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script src="https://cdn.jsdelivr.net/npm/requirejs@2.3.6/require.min.js" integrity="sha384-c9c+LnTbwQ3aujuU7ULEPVvgLs+Fn6fJUvIGTsuu1ZcCf11fiEubah0ttpca4ntM sha384-6V1/AdqZRWk1KAlWbKBlGhN7VG4iE/yAZcO6NZPMF8od0vukrvr0tg4qY6NSrItx" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


</head>

<body class="fullcontent quarto-light">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Netflix User Churn Prediction Project</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="objective" class="level2">
<h2 class="anchored" data-anchor-id="objective">Objective</h2>
<p>Predict whether a user will remain active (<code>is_active</code>) using recent watch patterns, engagement metrics, demographics, and subscription plan information. Identify the most influential drivers of churn.</p>
</section>
<section id="dataset-overview" class="level2">
<h2 class="anchored" data-anchor-id="dataset-overview">Dataset Overview</h2>
<ul>
<li><strong>Source</strong>: Netflix 2025: User Behavior Dataset (210K+ Records)</li>
<li><strong>Target Variable</strong>: <code>is_active</code> (binary) from users.csv</li>
<li><strong>Features</strong>: Demographics, subscription info, watch patterns, engagement metrics</li>
<li><strong>Data Files</strong>: users.csv, movies.csv, watch_history.csv, recommendation_logs.csv, search_logs.csv, reviews.csv</li>
</ul>
<div id="d533f3bb" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Import Required Libraries</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> train_test_split, cross_val_score</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.ensemble <span class="im">import</span> RandomForestClassifier, GradientBoostingClassifier</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> LabelEncoder, StandardScaler</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> classification_report, confusion_matrix, accuracy_score, roc_auc_score, roc_curve</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>warnings.filterwarnings(<span class="st">'ignore'</span>)</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Set display options</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>pd.set_option(<span class="st">'display.max_columns'</span>, <span class="va">None</span>)</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>pd.set_option(<span class="st">'display.max_rows'</span>, <span class="dv">100</span>)</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>plt.style.use(<span class="st">'seaborn-v0_8-darkgrid'</span>)</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>sns.set_palette(<span class="st">"husl"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="data-loading-and-initial-exploration" class="level2">
<h2 class="anchored" data-anchor-id="data-loading-and-initial-exploration">1. Data Loading and Initial Exploration</h2>
<div id="09f8fad1" class="cell" data-execution_count="2">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load all datasets</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>users <span class="op">=</span> pd.read_csv(<span class="st">'archive/users.csv'</span>)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>movies <span class="op">=</span> pd.read_csv(<span class="st">'archive/movies.csv'</span>)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>watch_history <span class="op">=</span> pd.read_csv(<span class="st">'archive/watch_history.csv'</span>)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>recommendation_logs <span class="op">=</span> pd.read_csv(<span class="st">'archive/recommendation_logs.csv'</span>)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>search_logs <span class="op">=</span> pd.read_csv(<span class="st">'archive/search_logs.csv'</span>)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>reviews <span class="op">=</span> pd.read_csv(<span class="st">'archive/reviews.csv'</span>)</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Dataset Shapes:"</span>)</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Users: </span><span class="sc">{</span>users<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Movies: </span><span class="sc">{</span>movies<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Watch History: </span><span class="sc">{</span>watch_history<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Recommendation Logs: </span><span class="sc">{</span>recommendation_logs<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Search Logs: </span><span class="sc">{</span>search_logs<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Reviews: </span><span class="sc">{</span>reviews<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Display first few rows of users table (contains target variable)</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Users Table Sample (Target: is_active):"</span>)</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>users.head()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Dataset Shapes:
Users: (10300, 16)
Movies: (1040, 18)
Watch History: (105000, 12)
Recommendation Logs: (52000, 11)
Search Logs: (26500, 11)
Reviews: (15450, 12)

================================================================================
Users Table Sample (Target: is_active):
================================================================================</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="2">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">user_id</th>
<th data-quarto-table-cell-role="th">email</th>
<th data-quarto-table-cell-role="th">first_name</th>
<th data-quarto-table-cell-role="th">last_name</th>
<th data-quarto-table-cell-role="th">age</th>
<th data-quarto-table-cell-role="th">gender</th>
<th data-quarto-table-cell-role="th">country</th>
<th data-quarto-table-cell-role="th">state_province</th>
<th data-quarto-table-cell-role="th">city</th>
<th data-quarto-table-cell-role="th">subscription_plan</th>
<th data-quarto-table-cell-role="th">subscription_start_date</th>
<th data-quarto-table-cell-role="th">is_active</th>
<th data-quarto-table-cell-role="th">monthly_spend</th>
<th data-quarto-table-cell-role="th">primary_device</th>
<th data-quarto-table-cell-role="th">household_size</th>
<th data-quarto-table-cell-role="th">created_at</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>user_00001</td>
<td>figueroajohn@example.org</td>
<td>Erica</td>
<td>Garza</td>
<td>43.0</td>
<td>Male</td>
<td>USA</td>
<td>Massachusetts</td>
<td>North Jefferyhaven</td>
<td>Basic</td>
<td>2024-04-08</td>
<td>True</td>
<td>36.06</td>
<td>Laptop</td>
<td>1.0</td>
<td>2023-04-01 14:40:50.540242</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>user_00002</td>
<td>blakeerik@example.com</td>
<td>Joshua</td>
<td>Bernard</td>
<td>38.0</td>
<td>Male</td>
<td>USA</td>
<td>Texas</td>
<td>North Noahstad</td>
<td>Premium+</td>
<td>2024-05-24</td>
<td>True</td>
<td>14.59</td>
<td>Desktop</td>
<td>2.0</td>
<td>2024-10-10 15:39:11.030515</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>user_00003</td>
<td>smiller@example.net</td>
<td>Barbara</td>
<td>Williams</td>
<td>32.0</td>
<td>Female</td>
<td>USA</td>
<td>Michigan</td>
<td>Traciebury</td>
<td>Standard</td>
<td>2023-09-22</td>
<td>False</td>
<td>11.71</td>
<td>Desktop</td>
<td>3.0</td>
<td>2024-06-29 14:27:49.560875</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>user_00004</td>
<td>mitchellclark@example.com</td>
<td>Chelsea</td>
<td>Ferguson</td>
<td>11.0</td>
<td>Male</td>
<td>USA</td>
<td>Ohio</td>
<td>South Noah</td>
<td>Standard</td>
<td>2024-08-21</td>
<td>True</td>
<td>28.56</td>
<td>Laptop</td>
<td>2.0</td>
<td>2023-04-11 01:01:59.614841</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>user_00005</td>
<td>richard13@example.net</td>
<td>Jason</td>
<td>Foster</td>
<td>21.0</td>
<td>Female</td>
<td>USA</td>
<td>Arizona</td>
<td>West Donald</td>
<td>Standard</td>
<td>2024-10-28</td>
<td>True</td>
<td>9.54</td>
<td>Desktop</td>
<td>6.0</td>
<td>2025-04-12 19:59:30.137806</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="652eb1e3" class="cell" data-execution_count="3">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Check data info and target distribution</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Users Table Info:"</span>)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(users.info())</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Target Variable Distribution:"</span>)</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>target_dist <span class="op">=</span> users[<span class="st">'is_active'</span>].value_counts()</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(target_dist)</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Churn Rate: </span><span class="sc">{</span>(<span class="dv">1</span> <span class="op">-</span> target_dist[<span class="va">True</span>] <span class="op">/</span> <span class="bu">len</span>(users)) <span class="op">*</span> <span class="dv">100</span><span class="sc">:.2f}</span><span class="ss">%"</span>)</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize target distribution</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">4</span>))</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>users[<span class="st">'is_active'</span>].value_counts().plot(kind<span class="op">=</span><span class="st">'bar'</span>, ax<span class="op">=</span>axes[<span class="dv">0</span>], color<span class="op">=</span>[<span class="st">'#ff6b6b'</span>, <span class="st">'#4ecdc4'</span>])</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_title(<span class="st">'User Activity Status Distribution'</span>, fontsize<span class="op">=</span><span class="dv">14</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_xlabel(<span class="st">'Is Active'</span>)</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_ylabel(<span class="st">'Count'</span>)</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_xticklabels([<span class="st">'Inactive'</span>, <span class="st">'Active'</span>], rotation<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Pie chart</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>colors <span class="op">=</span> [<span class="st">'#ff6b6b'</span>, <span class="st">'#4ecdc4'</span>]</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].pie(target_dist, labels<span class="op">=</span>[<span class="st">'Active'</span>, <span class="st">'Inactive'</span>], autopct<span class="op">=</span><span class="st">'</span><span class="sc">%1.1f%%</span><span class="st">'</span>, </span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>            colors<span class="op">=</span>colors, startangle<span class="op">=</span><span class="dv">90</span>)</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_title(<span class="st">'User Activity Proportion'</span>, fontsize<span class="op">=</span><span class="dv">14</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Users Table Info:
&lt;class 'pandas.core.frame.DataFrame'&gt;
RangeIndex: 10300 entries, 0 to 10299
Data columns (total 16 columns):
 #   Column                   Non-Null Count  Dtype  
---  ------                   --------------  -----  
 0   user_id                  10300 non-null  object 
 1   email                    10300 non-null  object 
 2   first_name               10300 non-null  object 
 3   last_name                10300 non-null  object 
 4   age                      9071 non-null   float64
 5   gender                   9476 non-null   object 
 6   country                  10300 non-null  object 
 7   state_province           10300 non-null  object 
 8   city                     10300 non-null  object 
 9   subscription_plan        10300 non-null  object 
 10  subscription_start_date  10300 non-null  object 
 11  is_active                10300 non-null  bool   
 12  monthly_spend            9283 non-null   float64
 13  primary_device           10300 non-null  object 
 14  household_size           8755 non-null   float64
 15  created_at               10300 non-null  object 
dtypes: bool(1), float64(3), object(12)
memory usage: 1.2+ MB
None

================================================================================
Target Variable Distribution:
================================================================================
is_active
True     8776
False    1524
Name: count, dtype: int64

Churn Rate: 14.80%</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="random_forest_files/figure-html/cell-4-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="data-quality-assessment" class="level2">
<h2 class="anchored" data-anchor-id="data-quality-assessment">2. Data Quality Assessment</h2>
<div id="48f8b484" class="cell" data-execution_count="4">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Check for missing values and duplicates</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"DATA QUALITY ASSESSMENT"</span>)</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">1. MISSING VALUES:"</span>)</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">80</span>)</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>missing_users <span class="op">=</span> users.isnull().<span class="bu">sum</span>()</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>missing_pct <span class="op">=</span> (missing_users <span class="op">/</span> <span class="bu">len</span>(users) <span class="op">*</span> <span class="dv">100</span>).<span class="bu">round</span>(<span class="dv">2</span>)</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>missing_df <span class="op">=</span> pd.DataFrame({<span class="st">'Missing Count'</span>: missing_users, <span class="st">'Percentage'</span>: missing_pct})</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>missing_df <span class="op">=</span> missing_df[missing_df[<span class="st">'Missing Count'</span>] <span class="op">&gt;</span> <span class="dv">0</span>].sort_values(<span class="st">'Missing Count'</span>, ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(missing_df)</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">2. DUPLICATE RECORDS:"</span>)</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">80</span>)</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Users duplicates: </span><span class="sc">{</span>users<span class="sc">.</span>duplicated()<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span>users<span class="sc">.</span>duplicated()<span class="sc">.</span><span class="bu">sum</span>() <span class="op">/</span> <span class="bu">len</span>(users) <span class="op">*</span> <span class="dv">100</span><span class="sc">:.2f}</span><span class="ss">%)"</span>)</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Watch history duplicates: </span><span class="sc">{</span>watch_history<span class="sc">.</span>duplicated()<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span>watch_history<span class="sc">.</span>duplicated()<span class="sc">.</span><span class="bu">sum</span>() <span class="op">/</span> <span class="bu">len</span>(watch_history) <span class="op">*</span> <span class="dv">100</span><span class="sc">:.2f}</span><span class="ss">%)"</span>)</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">3. DATA TYPES:"</span>)</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">80</span>)</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(users.dtypes)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>================================================================================
DATA QUALITY ASSESSMENT
================================================================================

1. MISSING VALUES:
--------------------------------------------------------------------------------
                Missing Count  Percentage
household_size           1545       15.00
age                      1229       11.93
monthly_spend            1017        9.87
gender                    824        8.00

2. DUPLICATE RECORDS:
--------------------------------------------------------------------------------
Users duplicates: 300 (2.91%)
Watch history duplicates: 5000 (4.76%)

3. DATA TYPES:
--------------------------------------------------------------------------------
user_id                     object
email                       object
first_name                  object
last_name                   object
age                        float64
gender                      object
country                     object
state_province              object
city                        object
subscription_plan           object
subscription_start_date     object
is_active                     bool
monthly_spend              float64
primary_device              object
household_size             float64
created_at                  object
dtype: object</code></pre>
</div>
</div>
<div id="4ae1a09b" class="cell" data-execution_count="5">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize missing data patterns</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="dv">5</span>))</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Missing values heatmap</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> axes[<span class="dv">0</span>]</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>missing_matrix <span class="op">=</span> users.isnull()</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> missing_matrix.<span class="bu">sum</span>().<span class="bu">sum</span>() <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>    sns.heatmap(missing_matrix, cbar<span class="op">=</span><span class="va">True</span>, yticklabels<span class="op">=</span><span class="va">False</span>, cmap<span class="op">=</span><span class="st">'YlOrRd'</span>, ax<span class="op">=</span>ax)</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>    ax.set_title(<span class="st">'Missing Values Pattern (Yellow = Missing)'</span>, fontsize<span class="op">=</span><span class="dv">12</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>    ax.set_xlabel(<span class="st">'Features'</span>)</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>    ax.text(<span class="fl">0.5</span>, <span class="fl">0.5</span>, <span class="st">'No Missing Values'</span>, ha<span class="op">=</span><span class="st">'center'</span>, va<span class="op">=</span><span class="st">'center'</span>, fontsize<span class="op">=</span><span class="dv">14</span>)</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>    ax.set_title(<span class="st">'Missing Values Pattern'</span>, fontsize<span class="op">=</span><span class="dv">12</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Missing percentage by column</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> axes[<span class="dv">1</span>]</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> missing_df.shape[<span class="dv">0</span>] <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>    ax.barh(missing_df.index, missing_df[<span class="st">'Percentage'</span>], color<span class="op">=</span><span class="st">'coral'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>    ax.set_xlabel(<span class="st">'Missing Percentage (%)'</span>, fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>    ax.set_title(<span class="st">'Missing Values by Feature'</span>, fontsize<span class="op">=</span><span class="dv">12</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>    ax.invert_yaxis()</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>    ax.grid(axis<span class="op">=</span><span class="st">'x'</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>    ax.text(<span class="fl">0.5</span>, <span class="fl">0.5</span>, <span class="st">'No Missing Values'</span>, ha<span class="op">=</span><span class="st">'center'</span>, va<span class="op">=</span><span class="st">'center'</span>, fontsize<span class="op">=</span><span class="dv">14</span>)</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>    ax.set_title(<span class="st">'Missing Values by Feature'</span>, fontsize<span class="op">=</span><span class="dv">12</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="random_forest_files/figure-html/cell-6-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<section id="handling-duplicates-strategy" class="level3">
<h3 class="anchored" data-anchor-id="handling-duplicates-strategy">Handling Duplicates Strategy</h3>
<p><strong>Order of Operations</strong>: Handle duplicates BEFORE missing value imputation to avoid artificially inflating patterns.</p>
<p>Duplicate records can arise from: - <strong>Data collection errors</strong>: Same user recorded multiple times - <strong>System issues</strong>: Double recording of transactions - <strong>Natural duplicates</strong>: Multiple people with same characteristics</p>
<p><strong>Strategy</strong>: - Identify duplicates based on unique identifier (user_id) - Keep first occurrence (most recent or complete record) - Remove exact duplicates across all columns</p>
<div id="97b9a7d7" class="cell" data-execution_count="6">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># STEP 1: Handle duplicates FIRST</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"STEP 1: DUPLICATE HANDLING"</span>)</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Check for duplicates based on user_id (should be unique)</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">1. USER_ID DUPLICATES:"</span>)</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>user_id_duplicates <span class="op">=</span> users[users.duplicated(subset<span class="op">=</span>[<span class="st">'user_id'</span>], keep<span class="op">=</span><span class="va">False</span>)]</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"   Records with duplicate user_id: </span><span class="sc">{</span><span class="bu">len</span>(user_id_duplicates)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>users_clean <span class="op">=</span> users.copy()</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="bu">len</span>(user_id_duplicates) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"   Unique users with duplicates: </span><span class="sc">{</span>user_id_duplicates[<span class="st">'user_id'</span>]<span class="sc">.</span>nunique()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Keep first occurrence</span></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>    users_clean <span class="op">=</span> users_clean.drop_duplicates(subset<span class="op">=</span>[<span class="st">'user_id'</span>], keep<span class="op">=</span><span class="st">'first'</span>)</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"   Strategy: Keep first occurrence"</span>)</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"   Removed: </span><span class="sc">{</span><span class="bu">len</span>(users) <span class="op">-</span> <span class="bu">len</span>(users_clean)<span class="sc">}</span><span class="ss"> records"</span>)</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"   No user_id duplicates found!"</span>)</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Check for exact duplicates (all columns identical)</span></span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">2. EXACT DUPLICATES (all columns):"</span>)</span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>exact_duplicates <span class="op">=</span> users_clean.duplicated()</span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"   Exact duplicate records: </span><span class="sc">{</span>exact_duplicates<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> exact_duplicates.<span class="bu">sum</span>() <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>    users_clean <span class="op">=</span> users_clean.drop_duplicates(keep<span class="op">=</span><span class="st">'first'</span>)</span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"   Strategy: Keep first occurrence"</span>)</span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"   Removed: </span><span class="sc">{</span>exact_duplicates<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss"> records"</span>)</span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"   No exact duplicates found!"</span>)</span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Handle duplicates in watch_history</span></span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">3. WATCH HISTORY DUPLICATES:"</span>)</span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a>watch_dup <span class="op">=</span> watch_history.duplicated()</span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"   Exact duplicate sessions: </span><span class="sc">{</span>watch_dup<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span>watch_dup<span class="sc">.</span><span class="bu">sum</span>()<span class="op">/</span><span class="bu">len</span>(watch_history)<span class="op">*</span><span class="dv">100</span><span class="sc">:.2f}</span><span class="ss">%)"</span>)</span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> watch_dup.<span class="bu">sum</span>() <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a>    watch_history_clean <span class="op">=</span> watch_history.drop_duplicates(keep<span class="op">=</span><span class="st">'first'</span>)</span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"   Strategy: Remove exact duplicates, keep first"</span>)</span>
<span id="cb9-42"><a href="#cb9-42" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"   Removed: </span><span class="sc">{</span>watch_dup<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss"> records"</span>)</span>
<span id="cb9-43"><a href="#cb9-43" aria-hidden="true" tabindex="-1"></a>    watch_history <span class="op">=</span> watch_history_clean</span>
<span id="cb9-44"><a href="#cb9-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-45"><a href="#cb9-45" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">80</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb9-46"><a href="#cb9-46" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Users before:        </span><span class="sc">{</span><span class="bu">len</span>(users)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb9-47"><a href="#cb9-47" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Users after:         </span><span class="sc">{</span><span class="bu">len</span>(users_clean)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb9-48"><a href="#cb9-48" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Records removed:     </span><span class="sc">{</span><span class="bu">len</span>(users) <span class="op">-</span> <span class="bu">len</span>(users_clean)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb9-49"><a href="#cb9-49" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Data retention rate: </span><span class="sc">{</span><span class="bu">len</span>(users_clean)<span class="op">/</span><span class="bu">len</span>(users)<span class="op">*</span><span class="dv">100</span><span class="sc">:.2f}</span><span class="ss">%"</span>)</span>
<span id="cb9-50"><a href="#cb9-50" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">80</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb9-51"><a href="#cb9-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-52"><a href="#cb9-52" aria-hidden="true" tabindex="-1"></a><span class="co"># Update users dataframe for next step</span></span>
<span id="cb9-53"><a href="#cb9-53" aria-hidden="true" tabindex="-1"></a>users <span class="op">=</span> users_clean</span>
<span id="cb9-54"><a href="#cb9-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-55"><a href="#cb9-55" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb9-56"><a href="#cb9-56" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"STEP 2: MISSING VALUE IMPUTATION STRATEGY"</span>)</span>
<span id="cb9-57"><a href="#cb9-57" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb9-58"><a href="#cb9-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-59"><a href="#cb9-59" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Age - DO NOT CHANGE (keep missing as is or will be handled later)</span></span>
<span id="cb9-60"><a href="#cb9-60" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> users[<span class="st">'age'</span>].isnull().<span class="bu">sum</span>() <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb9-61"><a href="#cb9-61" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">1. AGE:"</span>)</span>
<span id="cb9-62"><a href="#cb9-62" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"   Missing: </span><span class="sc">{</span>users[<span class="st">'age'</span>]<span class="sc">.</span>isnull()<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span>users[<span class="st">'age'</span>]<span class="sc">.</span>isnull()<span class="sc">.</span><span class="bu">sum</span>()<span class="op">/</span><span class="bu">len</span>(users)<span class="op">*</span><span class="dv">100</span><span class="sc">:.2f}</span><span class="ss">%)"</span>)</span>
<span id="cb9-63"><a href="#cb9-63" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"   Strategy: NO CHANGE - Keep missing values as is"</span>)</span>
<span id="cb9-64"><a href="#cb9-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-65"><a href="#cb9-65" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Gender - categorical, use 'Prefer not to say'</span></span>
<span id="cb9-66"><a href="#cb9-66" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> users[<span class="st">'gender'</span>].isnull().<span class="bu">sum</span>() <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb9-67"><a href="#cb9-67" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">2. GENDER:"</span>)</span>
<span id="cb9-68"><a href="#cb9-68" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"   Missing: </span><span class="sc">{</span>users[<span class="st">'gender'</span>]<span class="sc">.</span>isnull()<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span>users[<span class="st">'gender'</span>]<span class="sc">.</span>isnull()<span class="sc">.</span><span class="bu">sum</span>()<span class="op">/</span><span class="bu">len</span>(users)<span class="op">*</span><span class="dv">100</span><span class="sc">:.2f}</span><span class="ss">%)"</span>)</span>
<span id="cb9-69"><a href="#cb9-69" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"   Strategy: Fill with 'Prefer not to say' category"</span>)</span>
<span id="cb9-70"><a href="#cb9-70" aria-hidden="true" tabindex="-1"></a>    users[<span class="st">'gender'</span>] <span class="op">=</span> users[<span class="st">'gender'</span>].fillna(<span class="st">'Prefer not to say'</span>)</span>
<span id="cb9-71"><a href="#cb9-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-72"><a href="#cb9-72" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Monthly spend - 0 for inactive accounts (assuming free users or inactive)</span></span>
<span id="cb9-73"><a href="#cb9-73" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> users[<span class="st">'monthly_spend'</span>].isnull().<span class="bu">sum</span>() <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb9-74"><a href="#cb9-74" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">3. MONTHLY SPEND:"</span>)</span>
<span id="cb9-75"><a href="#cb9-75" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"   Missing: </span><span class="sc">{</span>users[<span class="st">'monthly_spend'</span>]<span class="sc">.</span>isnull()<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span>users[<span class="st">'monthly_spend'</span>]<span class="sc">.</span>isnull()<span class="sc">.</span><span class="bu">sum</span>()<span class="op">/</span><span class="bu">len</span>(users)<span class="op">*</span><span class="dv">100</span><span class="sc">:.2f}</span><span class="ss">%)"</span>)</span>
<span id="cb9-76"><a href="#cb9-76" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"   Strategy: Fill with 0 (assuming free users or inactive accounts)"</span>)</span>
<span id="cb9-77"><a href="#cb9-77" aria-hidden="true" tabindex="-1"></a>    users[<span class="st">'monthly_spend'</span>] <span class="op">=</span> users[<span class="st">'monthly_spend'</span>].fillna(<span class="dv">0</span>)</span>
<span id="cb9-78"><a href="#cb9-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-79"><a href="#cb9-79" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. Household size - use median by country</span></span>
<span id="cb9-80"><a href="#cb9-80" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> users[<span class="st">'household_size'</span>].isnull().<span class="bu">sum</span>() <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb9-81"><a href="#cb9-81" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">4. HOUSEHOLD SIZE:"</span>)</span>
<span id="cb9-82"><a href="#cb9-82" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"   Missing: </span><span class="sc">{</span>users[<span class="st">'household_size'</span>]<span class="sc">.</span>isnull()<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span>users[<span class="st">'household_size'</span>]<span class="sc">.</span>isnull()<span class="sc">.</span><span class="bu">sum</span>()<span class="op">/</span><span class="bu">len</span>(users)<span class="op">*</span><span class="dv">100</span><span class="sc">:.2f}</span><span class="ss">%)"</span>)</span>
<span id="cb9-83"><a href="#cb9-83" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"   Strategy: Fill with median by country"</span>)</span>
<span id="cb9-84"><a href="#cb9-84" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-85"><a href="#cb9-85" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate median household size by country</span></span>
<span id="cb9-86"><a href="#cb9-86" aria-hidden="true" tabindex="-1"></a>    country_medians <span class="op">=</span> users.groupby(<span class="st">'country'</span>)[<span class="st">'household_size'</span>].median()</span>
<span id="cb9-87"><a href="#cb9-87" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"   Countries with data: </span><span class="sc">{</span><span class="bu">len</span>(country_medians)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb9-88"><a href="#cb9-88" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-89"><a href="#cb9-89" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Fill missing values with country-specific median (fallback to overall median if country median is NaN)</span></span>
<span id="cb9-90"><a href="#cb9-90" aria-hidden="true" tabindex="-1"></a>    users[<span class="st">'household_size'</span>] <span class="op">=</span> users.<span class="bu">apply</span>(</span>
<span id="cb9-91"><a href="#cb9-91" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span> row: country_medians.get(row[<span class="st">'country'</span>], users[<span class="st">'household_size'</span>].median()) </span>
<span id="cb9-92"><a href="#cb9-92" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> pd.isnull(row[<span class="st">'household_size'</span>]) <span class="cf">else</span> row[<span class="st">'household_size'</span>],</span>
<span id="cb9-93"><a href="#cb9-93" aria-hidden="true" tabindex="-1"></a>        axis<span class="op">=</span><span class="dv">1</span></span>
<span id="cb9-94"><a href="#cb9-94" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb9-95"><a href="#cb9-95" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"   Applied country-specific medians"</span>)</span>
<span id="cb9-96"><a href="#cb9-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-97"><a href="#cb9-97" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">80</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb9-98"><a href="#cb9-98" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"IMPUTATION COMPLETE"</span>)</span>
<span id="cb9-99"><a href="#cb9-99" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">80</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb9-100"><a href="#cb9-100" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Total missing values after imputation: </span><span class="sc">{</span>users<span class="sc">.</span>isnull()<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb9-101"><a href="#cb9-101" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> users.isnull().<span class="bu">sum</span>().<span class="bu">sum</span>() <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb9-102"><a href="#cb9-102" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Remaining missing values by column:"</span>)</span>
<span id="cb9-103"><a href="#cb9-103" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(users.isnull().<span class="bu">sum</span>()[users.isnull().<span class="bu">sum</span>() <span class="op">&gt;</span> <span class="dv">0</span>])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>================================================================================
STEP 1: DUPLICATE HANDLING
================================================================================

1. USER_ID DUPLICATES:
   Records with duplicate user_id: 595
   Unique users with duplicates: 295
   Strategy: Keep first occurrence
   Removed: 300 records

2. EXACT DUPLICATES (all columns):
   Exact duplicate records: 0
   No exact duplicates found!

3. WATCH HISTORY DUPLICATES:
   Exact duplicate sessions: 5000 (4.76%)
   Strategy: Remove exact duplicates, keep first
   Removed: 5000 records

================================================================================
Users before:        10300
Users after:         10000
Records removed:     300
Data retention rate: 97.09%
================================================================================

================================================================================
STEP 2: MISSING VALUE IMPUTATION STRATEGY
================================================================================

1. AGE:
   Missing: 1194 (11.94%)
   Strategy: NO CHANGE - Keep missing values as is

2. GENDER:
   Missing: 800 (8.00%)
   Strategy: Fill with 'Prefer not to say' category

3. MONTHLY SPEND:
   Missing: 993 (9.93%)
   Strategy: Fill with 0 (assuming free users or inactive accounts)

4. HOUSEHOLD SIZE:
   Missing: 1500 (15.00%)
   Strategy: Fill with median by country
   Countries with data: 2
   Applied country-specific medians

================================================================================
IMPUTATION COMPLETE
================================================================================
Total missing values after imputation: 1194

Remaining missing values by column:
age    1194
dtype: int64</code></pre>
</div>
</div>
</section>
<section id="handling-outliers" class="level3">
<h3 class="anchored" data-anchor-id="handling-outliers">Handling Outliers</h3>
<p>Outliers can significantly impact model performance. Common approaches: - <strong>Capping/Clipping</strong>: Set min/max thresholds (e.g., age 18-100) - <strong>IQR Method</strong>: Remove/cap values beyond Q1 - 1.5IQR or Q3 + 1.5IQR - <strong>Z-score</strong>: Remove values with |z-score| &gt; 3 - <strong>Domain knowledge</strong>: Use business logic (e.g., monthly spend caps)</p>
<div id="89187246" class="cell" data-execution_count="7">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Identify and handle outliers</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"OUTLIER DETECTION AND TREATMENT"</span>)</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to detect outliers using IQR method</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> detect_outliers_iqr(data, column, multiplier<span class="op">=</span><span class="fl">1.5</span>):</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>    Q1 <span class="op">=</span> data[column].quantile(<span class="fl">0.25</span>)</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>    Q3 <span class="op">=</span> data[column].quantile(<span class="fl">0.75</span>)</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>    IQR <span class="op">=</span> Q3 <span class="op">-</span> Q1</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>    lower_bound <span class="op">=</span> Q1 <span class="op">-</span> multiplier <span class="op">*</span> IQR</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>    upper_bound <span class="op">=</span> Q3 <span class="op">+</span> multiplier <span class="op">*</span> IQR</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>    outliers <span class="op">=</span> data[(data[column] <span class="op">&lt;</span> lower_bound) <span class="op">|</span> (data[column] <span class="op">&gt;</span> upper_bound)]</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> outliers, lower_bound, upper_bound</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Age outliers</span></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">1. AGE OUTLIERS:"</span>)</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>age_outliers, age_lower, age_upper <span class="op">=</span> detect_outliers_iqr(users, <span class="st">'age'</span>)</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"   Outliers detected: </span><span class="sc">{</span><span class="bu">len</span>(age_outliers)<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span><span class="bu">len</span>(age_outliers)<span class="op">/</span><span class="bu">len</span>(users)<span class="op">*</span><span class="dv">100</span><span class="sc">:.2f}</span><span class="ss">%)"</span>)</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"   IQR bounds: [</span><span class="sc">{</span>age_lower<span class="sc">:.1f}</span><span class="ss">, </span><span class="sc">{</span>age_upper<span class="sc">:.1f}</span><span class="ss">]"</span>)</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"   Actual range: [</span><span class="sc">{</span>users[<span class="st">'age'</span>]<span class="sc">.</span><span class="bu">min</span>()<span class="sc">:.1f}</span><span class="ss">, </span><span class="sc">{</span>users[<span class="st">'age'</span>]<span class="sc">.</span><span class="bu">max</span>()<span class="sc">:.1f}</span><span class="ss">]"</span>)</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"   Strategy: Cap at [18, 100] based on domain knowledge"</span>)</span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>users[<span class="st">'age'</span>] <span class="op">=</span> users[<span class="st">'age'</span>].clip(<span class="dv">18</span>, <span class="dv">100</span>)</span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"   After capping: [</span><span class="sc">{</span>users[<span class="st">'age'</span>]<span class="sc">.</span><span class="bu">min</span>()<span class="sc">:.1f}</span><span class="ss">, </span><span class="sc">{</span>users[<span class="st">'age'</span>]<span class="sc">.</span><span class="bu">max</span>()<span class="sc">:.1f}</span><span class="ss">]"</span>)</span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Monthly spend outliers</span></span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">2. MONTHLY SPEND OUTLIERS:"</span>)</span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>spend_outliers, spend_lower, spend_upper <span class="op">=</span> detect_outliers_iqr(users, <span class="st">'monthly_spend'</span>, multiplier<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"   Outliers detected: </span><span class="sc">{</span><span class="bu">len</span>(spend_outliers)<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span><span class="bu">len</span>(spend_outliers)<span class="op">/</span><span class="bu">len</span>(users)<span class="op">*</span><span class="dv">100</span><span class="sc">:.2f}</span><span class="ss">%)"</span>)</span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"   IQR bounds (3IQR): [$</span><span class="sc">{</span>spend_lower<span class="sc">:.2f}</span><span class="ss">, $</span><span class="sc">{</span>spend_upper<span class="sc">:.2f}</span><span class="ss">]"</span>)</span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"   Actual range: [$</span><span class="sc">{</span>users[<span class="st">'monthly_spend'</span>]<span class="sc">.</span><span class="bu">min</span>()<span class="sc">:.2f}</span><span class="ss">, $</span><span class="sc">{</span>users[<span class="st">'monthly_spend'</span>]<span class="sc">.</span><span class="bu">max</span>()<span class="sc">:.2f}</span><span class="ss">]"</span>)</span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"   Strategy: Cap at 3IQR bounds (conservative approach)"</span>)</span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>users[<span class="st">'monthly_spend'</span>] <span class="op">=</span> users[<span class="st">'monthly_spend'</span>].clip(spend_lower, spend_upper)</span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"   After capping: [$</span><span class="sc">{</span>users[<span class="st">'monthly_spend'</span>]<span class="sc">.</span><span class="bu">min</span>()<span class="sc">:.2f}</span><span class="ss">, $</span><span class="sc">{</span>users[<span class="st">'monthly_spend'</span>]<span class="sc">.</span><span class="bu">max</span>()<span class="sc">:.2f}</span><span class="ss">]"</span>)</span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Household size outliers</span></span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">3. HOUSEHOLD SIZE OUTLIERS:"</span>)</span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a>household_outliers, household_lower, household_upper <span class="op">=</span> detect_outliers_iqr(users, <span class="st">'household_size'</span>)</span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"   Outliers detected: </span><span class="sc">{</span><span class="bu">len</span>(household_outliers)<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span><span class="bu">len</span>(household_outliers)<span class="op">/</span><span class="bu">len</span>(users)<span class="op">*</span><span class="dv">100</span><span class="sc">:.2f}</span><span class="ss">%)"</span>)</span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"   IQR bounds: [</span><span class="sc">{</span>household_lower<span class="sc">:.1f}</span><span class="ss">, </span><span class="sc">{</span>household_upper<span class="sc">:.1f}</span><span class="ss">]"</span>)</span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"   Actual range: [</span><span class="sc">{</span>users[<span class="st">'household_size'</span>]<span class="sc">.</span><span class="bu">min</span>()<span class="sc">:.0f}</span><span class="ss">, </span><span class="sc">{</span>users[<span class="st">'household_size'</span>]<span class="sc">.</span><span class="bu">max</span>()<span class="sc">:.0f}</span><span class="ss">]"</span>)</span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"   Strategy: Cap at reasonable limit [1, 10]"</span>)</span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true" tabindex="-1"></a>users[<span class="st">'household_size'</span>] <span class="op">=</span> users[<span class="st">'household_size'</span>].clip(<span class="dv">1</span>, <span class="dv">10</span>)</span>
<span id="cb11-44"><a href="#cb11-44" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"   After capping: [</span><span class="sc">{</span>users[<span class="st">'household_size'</span>]<span class="sc">.</span><span class="bu">min</span>()<span class="sc">:.0f}</span><span class="ss">, </span><span class="sc">{</span>users[<span class="st">'household_size'</span>]<span class="sc">.</span><span class="bu">max</span>()<span class="sc">:.0f}</span><span class="ss">]"</span>)</span>
<span id="cb11-45"><a href="#cb11-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-46"><a href="#cb11-46" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">80</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb11-47"><a href="#cb11-47" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"OUTLIER TREATMENT COMPLETE"</span>)</span>
<span id="cb11-48"><a href="#cb11-48" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">80</span><span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>================================================================================
OUTLIER DETECTION AND TREATMENT
================================================================================

1. AGE OUTLIERS:
   Outliers detected: 83 (0.83%)
   IQR bounds: [3.0, 67.0]
   Actual range: [-7.0, 109.0]
   Strategy: Cap at [18, 100] based on domain knowledge
   After capping: [18.0, 100.0]

2. MONTHLY SPEND OUTLIERS:
   Outliers detected: 127 (1.27%)
   IQR bounds (3IQR): [$-37.58, $63.92]
   Actual range: [$0.00, $997.80]
   Strategy: Cap at 3IQR bounds (conservative approach)
   After capping: [$0.00, $63.92]

3. HOUSEHOLD SIZE OUTLIERS:
   Outliers detected: 70 (0.70%)
   IQR bounds: [-1.0, 7.0]
   Actual range: [1, 8]
   Strategy: Cap at reasonable limit [1, 10]
   After capping: [1, 8]

================================================================================
OUTLIER TREATMENT COMPLETE
================================================================================</code></pre>
</div>
</div>
<div id="592e252e" class="cell" data-execution_count="8">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize data distributions before and after cleaning</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">3</span>, figsize<span class="op">=</span>(<span class="dv">16</span>, <span class="dv">10</span>))</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Age distribution</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> axes[<span class="dv">0</span>, <span class="dv">0</span>]</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>ax.hist(users[<span class="st">'age'</span>], bins<span class="op">=</span><span class="dv">30</span>, color<span class="op">=</span><span class="st">'steelblue'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>)</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">'Age'</span>, fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">'Frequency'</span>, fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">'Age Distribution (After Cleaning)'</span>, fontsize<span class="op">=</span><span class="dv">12</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>ax.axvline(users[<span class="st">'age'</span>].median(), color<span class="op">=</span><span class="st">'red'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, label<span class="op">=</span><span class="ss">f"Median: </span><span class="sc">{</span>users[<span class="st">'age'</span>]<span class="sc">.</span>median()<span class="sc">:.1f}</span><span class="ss">"</span>)</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>ax.legend()</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>ax.grid(alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Monthly spend distribution</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> axes[<span class="dv">0</span>, <span class="dv">1</span>]</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>ax.hist(users[<span class="st">'monthly_spend'</span>], bins<span class="op">=</span><span class="dv">30</span>, color<span class="op">=</span><span class="st">'coral'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>)</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">'Monthly Spend ($)'</span>, fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">'Frequency'</span>, fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">'Monthly Spend Distribution (After Cleaning)'</span>, fontsize<span class="op">=</span><span class="dv">12</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>ax.axvline(users[<span class="st">'monthly_spend'</span>].median(), color<span class="op">=</span><span class="st">'red'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, </span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>          label<span class="op">=</span><span class="ss">f"Median: $</span><span class="sc">{</span>users[<span class="st">'monthly_spend'</span>]<span class="sc">.</span>median()<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>ax.legend()</span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>ax.grid(alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Household size distribution</span></span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> axes[<span class="dv">0</span>, <span class="dv">2</span>]</span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>household_counts <span class="op">=</span> users[<span class="st">'household_size'</span>].value_counts().sort_index()</span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a>ax.bar(household_counts.index, household_counts.values, color<span class="op">=</span><span class="st">'lightgreen'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>)</span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">'Household Size'</span>, fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">'Count'</span>, fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">'Household Size Distribution (After Cleaning)'</span>, fontsize<span class="op">=</span><span class="dv">12</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a>ax.grid(axis<span class="op">=</span><span class="st">'y'</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Gender distribution</span></span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> axes[<span class="dv">1</span>, <span class="dv">0</span>]</span>
<span id="cb13-36"><a href="#cb13-36" aria-hidden="true" tabindex="-1"></a>gender_counts <span class="op">=</span> users[<span class="st">'gender'</span>].value_counts()</span>
<span id="cb13-37"><a href="#cb13-37" aria-hidden="true" tabindex="-1"></a>ax.pie(gender_counts, labels<span class="op">=</span>gender_counts.index, autopct<span class="op">=</span><span class="st">'</span><span class="sc">%1.1f%%</span><span class="st">'</span>, startangle<span class="op">=</span><span class="dv">90</span>, </span>
<span id="cb13-38"><a href="#cb13-38" aria-hidden="true" tabindex="-1"></a>       colors<span class="op">=</span>plt.cm.Set3(<span class="bu">range</span>(<span class="bu">len</span>(gender_counts))))</span>
<span id="cb13-39"><a href="#cb13-39" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">'Gender Distribution'</span>, fontsize<span class="op">=</span><span class="dv">12</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb13-40"><a href="#cb13-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-41"><a href="#cb13-41" aria-hidden="true" tabindex="-1"></a><span class="co"># Subscription plan distribution</span></span>
<span id="cb13-42"><a href="#cb13-42" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> axes[<span class="dv">1</span>, <span class="dv">1</span>]</span>
<span id="cb13-43"><a href="#cb13-43" aria-hidden="true" tabindex="-1"></a>plan_counts <span class="op">=</span> users[<span class="st">'subscription_plan'</span>].value_counts()</span>
<span id="cb13-44"><a href="#cb13-44" aria-hidden="true" tabindex="-1"></a>ax.bar(<span class="bu">range</span>(<span class="bu">len</span>(plan_counts)), plan_counts.values, color<span class="op">=</span><span class="st">'purple'</span>, alpha<span class="op">=</span><span class="fl">0.6</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>)</span>
<span id="cb13-45"><a href="#cb13-45" aria-hidden="true" tabindex="-1"></a>ax.set_xticks(<span class="bu">range</span>(<span class="bu">len</span>(plan_counts)))</span>
<span id="cb13-46"><a href="#cb13-46" aria-hidden="true" tabindex="-1"></a>ax.set_xticklabels(plan_counts.index, rotation<span class="op">=</span><span class="dv">45</span>, ha<span class="op">=</span><span class="st">'right'</span>)</span>
<span id="cb13-47"><a href="#cb13-47" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">'Subscription Plan'</span>, fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb13-48"><a href="#cb13-48" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">'Count'</span>, fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb13-49"><a href="#cb13-49" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">'Subscription Plan Distribution'</span>, fontsize<span class="op">=</span><span class="dv">12</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb13-50"><a href="#cb13-50" aria-hidden="true" tabindex="-1"></a>ax.grid(axis<span class="op">=</span><span class="st">'y'</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb13-51"><a href="#cb13-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-52"><a href="#cb13-52" aria-hidden="true" tabindex="-1"></a><span class="co"># Active vs Inactive users</span></span>
<span id="cb13-53"><a href="#cb13-53" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> axes[<span class="dv">1</span>, <span class="dv">2</span>]</span>
<span id="cb13-54"><a href="#cb13-54" aria-hidden="true" tabindex="-1"></a>active_counts <span class="op">=</span> users[<span class="st">'is_active'</span>].value_counts()</span>
<span id="cb13-55"><a href="#cb13-55" aria-hidden="true" tabindex="-1"></a>colors_active <span class="op">=</span> [<span class="st">'#ff6b6b'</span>, <span class="st">'#4ecdc4'</span>]</span>
<span id="cb13-56"><a href="#cb13-56" aria-hidden="true" tabindex="-1"></a>bars <span class="op">=</span> ax.bar([<span class="st">'Inactive'</span>, <span class="st">'Active'</span>], [active_counts[<span class="va">False</span>], active_counts[<span class="va">True</span>]], </span>
<span id="cb13-57"><a href="#cb13-57" aria-hidden="true" tabindex="-1"></a>              color<span class="op">=</span>colors_active, alpha<span class="op">=</span><span class="fl">0.7</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>)</span>
<span id="cb13-58"><a href="#cb13-58" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">'Count'</span>, fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb13-59"><a href="#cb13-59" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">'User Activity Status (Target)'</span>, fontsize<span class="op">=</span><span class="dv">12</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb13-60"><a href="#cb13-60" aria-hidden="true" tabindex="-1"></a>ax.grid(axis<span class="op">=</span><span class="st">'y'</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb13-61"><a href="#cb13-61" aria-hidden="true" tabindex="-1"></a><span class="co"># Add value labels on bars</span></span>
<span id="cb13-62"><a href="#cb13-62" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> bar <span class="kw">in</span> bars:</span>
<span id="cb13-63"><a href="#cb13-63" aria-hidden="true" tabindex="-1"></a>    height <span class="op">=</span> bar.get_height()</span>
<span id="cb13-64"><a href="#cb13-64" aria-hidden="true" tabindex="-1"></a>    ax.text(bar.get_x() <span class="op">+</span> bar.get_width()<span class="op">/</span><span class="fl">2.</span>, height,</span>
<span id="cb13-65"><a href="#cb13-65" aria-hidden="true" tabindex="-1"></a>            <span class="ss">f'</span><span class="sc">{</span><span class="bu">int</span>(height)<span class="sc">}</span><span class="ch">\n</span><span class="ss">(</span><span class="sc">{</span>height<span class="op">/</span><span class="bu">len</span>(users)<span class="op">*</span><span class="dv">100</span><span class="sc">:.1f}</span><span class="ss">%)'</span>,</span>
<span id="cb13-66"><a href="#cb13-66" aria-hidden="true" tabindex="-1"></a>            ha<span class="op">=</span><span class="st">'center'</span>, va<span class="op">=</span><span class="st">'bottom'</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb13-67"><a href="#cb13-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-68"><a href="#cb13-68" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb13-69"><a href="#cb13-69" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb13-70"><a href="#cb13-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-71"><a href="#cb13-71" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb13-72"><a href="#cb13-72" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"DATA QUALITY SUMMARY AFTER CLEANING"</span>)</span>
<span id="cb13-73"><a href="#cb13-73" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb13-74"><a href="#cb13-74" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Total users: </span><span class="sc">{</span><span class="bu">len</span>(users)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb13-75"><a href="#cb13-75" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Total features: </span><span class="sc">{</span>users<span class="sc">.</span>shape[<span class="dv">1</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb13-76"><a href="#cb13-76" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Missing values: </span><span class="sc">{</span>users<span class="sc">.</span>isnull()<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb13-77"><a href="#cb13-77" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Duplicate records: </span><span class="sc">{</span>users<span class="sc">.</span>duplicated()<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb13-78"><a href="#cb13-78" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Data is ready for feature engineering!"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="random_forest_files/figure-html/cell-9-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>================================================================================
DATA QUALITY SUMMARY AFTER CLEANING
================================================================================
Total users: 10000
Total features: 16
Missing values: 1194
Duplicate records: 0

Data is ready for feature engineering!</code></pre>
</div>
</div>
</section>
</section>
<section id="feature-engineering---create-engagement-metrics" class="level2">
<h2 class="anchored" data-anchor-id="feature-engineering---create-engagement-metrics">3. Feature Engineering - Create Engagement Metrics</h2>
<div id="ee62be65" class="cell" data-execution_count="9">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create user-level engagement features from watch history</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Creating engagement features from watch history..."</span>)</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Aggregate watch history per user</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>watch_features <span class="op">=</span> watch_history.groupby(<span class="st">'user_id'</span>).agg({</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">'session_id'</span>: <span class="st">'count'</span>,  <span class="co"># Total sessions</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">'watch_duration_minutes'</span>: [<span class="st">'sum'</span>, <span class="st">'mean'</span>, <span class="st">'std'</span>],  <span class="co"># Watch duration stats</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">'progress_percentage'</span>: [<span class="st">'mean'</span>, <span class="st">'std'</span>],  <span class="co"># Completion stats</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">'is_download'</span>: <span class="st">'sum'</span>,  <span class="co"># Downloads count</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">'user_rating'</span>: <span class="st">'count'</span>  <span class="co"># Number of ratings given</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>}).reset_index()</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Flatten column names</span></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>watch_features.columns <span class="op">=</span> [<span class="st">'user_id'</span>, <span class="st">'total_sessions'</span>, <span class="st">'total_watch_minutes'</span>, </span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>                         <span class="st">'avg_watch_minutes'</span>, <span class="st">'std_watch_minutes'</span>,</span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>                         <span class="st">'avg_progress'</span>, <span class="st">'std_progress'</span>, <span class="st">'total_downloads'</span>, <span class="st">'total_ratings'</span>]</span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Fill NaN std values with 0 (for users with single session)</span></span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>watch_features[<span class="st">'std_watch_minutes'</span>] <span class="op">=</span> watch_features[<span class="st">'std_watch_minutes'</span>].fillna(<span class="dv">0</span>)</span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>watch_features[<span class="st">'std_progress'</span>] <span class="op">=</span> watch_features[<span class="st">'std_progress'</span>].fillna(<span class="dv">0</span>)</span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Count unique actions per user</span></span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>action_counts <span class="op">=</span> watch_history.groupby([<span class="st">'user_id'</span>, <span class="st">'action'</span>]).size().unstack(fill_value<span class="op">=</span><span class="dv">0</span>).reset_index()</span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a>action_counts.columns <span class="op">=</span> [<span class="st">'user_id'</span>] <span class="op">+</span> [<span class="ss">f'action_</span><span class="sc">{</span>col<span class="sc">}</span><span class="ss">'</span> <span class="cf">for</span> col <span class="kw">in</span> action_counts.columns[<span class="dv">1</span>:]]</span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge action counts</span></span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a>watch_features <span class="op">=</span> watch_features.merge(action_counts, on<span class="op">=</span><span class="st">'user_id'</span>, how<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Watch features shape: </span><span class="sc">{</span>watch_features<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Sample watch features:"</span>)</span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a>watch_features.head()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Creating engagement features from watch history...
Watch features shape: (10000, 13)

Sample watch features:</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="9">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">user_id</th>
<th data-quarto-table-cell-role="th">total_sessions</th>
<th data-quarto-table-cell-role="th">total_watch_minutes</th>
<th data-quarto-table-cell-role="th">avg_watch_minutes</th>
<th data-quarto-table-cell-role="th">std_watch_minutes</th>
<th data-quarto-table-cell-role="th">avg_progress</th>
<th data-quarto-table-cell-role="th">std_progress</th>
<th data-quarto-table-cell-role="th">total_downloads</th>
<th data-quarto-table-cell-role="th">total_ratings</th>
<th data-quarto-table-cell-role="th">action_completed</th>
<th data-quarto-table-cell-role="th">action_paused</th>
<th data-quarto-table-cell-role="th">action_started</th>
<th data-quarto-table-cell-role="th">action_stopped</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>user_00001</td>
<td>12</td>
<td>529.9</td>
<td>66.237500</td>
<td>41.207071</td>
<td>65.854545</td>
<td>24.633772</td>
<td>4</td>
<td>4</td>
<td>6</td>
<td>2</td>
<td>2</td>
<td>2</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>user_00002</td>
<td>15</td>
<td>713.4</td>
<td>50.957143</td>
<td>27.359873</td>
<td>57.669231</td>
<td>35.839373</td>
<td>4</td>
<td>6</td>
<td>5</td>
<td>2</td>
<td>2</td>
<td>6</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>user_00003</td>
<td>8</td>
<td>594.2</td>
<td>74.275000</td>
<td>25.437641</td>
<td>42.528571</td>
<td>27.632090</td>
<td>2</td>
<td>1</td>
<td>3</td>
<td>2</td>
<td>1</td>
<td>2</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>user_00004</td>
<td>14</td>
<td>1146.7</td>
<td>88.207692</td>
<td>36.532211</td>
<td>38.764286</td>
<td>31.063548</td>
<td>3</td>
<td>3</td>
<td>4</td>
<td>6</td>
<td>1</td>
<td>3</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>user_00005</td>
<td>9</td>
<td>358.2</td>
<td>71.640000</td>
<td>61.048120</td>
<td>55.025000</td>
<td>28.044034</td>
<td>2</td>
<td>1</td>
<td>2</td>
<td>2</td>
<td>3</td>
<td>2</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="f43f9c91" class="cell" data-execution_count="10">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create recommendation engagement features</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Creating recommendation features..."</span>)</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>rec_features <span class="op">=</span> recommendation_logs.groupby(<span class="st">'user_id'</span>).agg({</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">'recommendation_id'</span>: <span class="st">'count'</span>,  <span class="co"># Total recommendations</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">'was_clicked'</span>: <span class="st">'sum'</span>  <span class="co"># Total clicks (was_clicked is boolean, sum gives count of True)</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>}).reset_index()</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>rec_features.columns <span class="op">=</span> [<span class="st">'user_id'</span>, <span class="st">'total_recommendations'</span>, <span class="st">'total_clicks'</span>]</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate click-through rate (avoid division by zero)</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>rec_features[<span class="st">'click_through_rate'</span>] <span class="op">=</span> rec_features.<span class="bu">apply</span>(</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> row: row[<span class="st">'total_clicks'</span>] <span class="op">/</span> row[<span class="st">'total_recommendations'</span>] <span class="cf">if</span> row[<span class="st">'total_recommendations'</span>] <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span>,</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>    axis<span class="op">=</span><span class="dv">1</span></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Recommendation features shape: </span><span class="sc">{</span>rec_features<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Sample recommendation features:"</span>)</span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(rec_features.head())</span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Create search engagement features  </span></span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Creating search features..."</span>)</span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>search_features <span class="op">=</span> search_logs.groupby(<span class="st">'user_id'</span>).agg({</span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>    <span class="st">'search_id'</span>: <span class="st">'count'</span>,  <span class="co"># Total searches</span></span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>    <span class="st">'results_returned'</span>: <span class="st">'mean'</span>,  <span class="co"># Average results</span></span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a>    <span class="st">'search_query'</span>: <span class="kw">lambda</span> x: x.<span class="bu">str</span>.<span class="bu">len</span>().mean()  <span class="co"># Average query length</span></span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a>}).reset_index()</span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a>search_features.columns <span class="op">=</span> [<span class="st">'user_id'</span>, <span class="st">'total_searches'</span>, <span class="st">'avg_results'</span>, <span class="st">'avg_query_length'</span>]</span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Search features shape: </span><span class="sc">{</span>search_features<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Sample search features:"</span>)</span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(search_features.head())</span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-36"><a href="#cb17-36" aria-hidden="true" tabindex="-1"></a><span class="co"># Create review engagement features</span></span>
<span id="cb17-37"><a href="#cb17-37" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Creating review features..."</span>)</span>
<span id="cb17-38"><a href="#cb17-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-39"><a href="#cb17-39" aria-hidden="true" tabindex="-1"></a>review_features <span class="op">=</span> reviews.groupby(<span class="st">'user_id'</span>).agg({</span>
<span id="cb17-40"><a href="#cb17-40" aria-hidden="true" tabindex="-1"></a>    <span class="st">'review_id'</span>: <span class="st">'count'</span>,  <span class="co"># Total reviews</span></span>
<span id="cb17-41"><a href="#cb17-41" aria-hidden="true" tabindex="-1"></a>    <span class="st">'rating'</span>: <span class="st">'mean'</span>,  <span class="co"># Average rating given</span></span>
<span id="cb17-42"><a href="#cb17-42" aria-hidden="true" tabindex="-1"></a>    <span class="st">'helpful_votes'</span>: <span class="st">'sum'</span>  <span class="co"># Total helpful votes</span></span>
<span id="cb17-43"><a href="#cb17-43" aria-hidden="true" tabindex="-1"></a>}).reset_index()</span>
<span id="cb17-44"><a href="#cb17-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-45"><a href="#cb17-45" aria-hidden="true" tabindex="-1"></a>review_features.columns <span class="op">=</span> [<span class="st">'user_id'</span>, <span class="st">'total_reviews'</span>, <span class="st">'avg_rating_given'</span>, <span class="st">'total_helpful_votes'</span>]</span>
<span id="cb17-46"><a href="#cb17-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-47"><a href="#cb17-47" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Review features shape: </span><span class="sc">{</span>review_features<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb17-48"><a href="#cb17-48" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Sample review features:"</span>)</span>
<span id="cb17-49"><a href="#cb17-49" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(review_features.head())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Creating recommendation features...
Recommendation features shape: (9921, 4)
Sample recommendation features:
      user_id  total_recommendations  total_clicks  click_through_rate
0  user_00001                      3             0            0.000000
1  user_00003                      6             2            0.333333
2  user_00004                      4             0            0.000000
3  user_00005                      1             0            0.000000
4  user_00006                      8             0            0.000000

Creating search features...
Search features shape: (9186, 4)
Sample search features:
      user_id  total_searches  avg_results  avg_query_length
0  user_00001               1         50.0         13.000000
1  user_00002               3         59.0         18.333333
2  user_00004               2         72.5         15.000000
3  user_00005               2         66.0         19.000000
4  user_00006               1         41.0         15.000000

Creating review features...
Review features shape: (7761, 4)
Sample review features:
      user_id  total_reviews  avg_rating_given  total_helpful_votes
0  user_00001              1          4.000000                  0.0
1  user_00002              4          3.500000                 10.0
2  user_00003              1          4.000000                  0.0
3  user_00004              4          2.250000                 13.0
4  user_00005              3          3.333333                  8.0
Search features shape: (9186, 4)
Sample search features:
      user_id  total_searches  avg_results  avg_query_length
0  user_00001               1         50.0         13.000000
1  user_00002               3         59.0         18.333333
2  user_00004               2         72.5         15.000000
3  user_00005               2         66.0         19.000000
4  user_00006               1         41.0         15.000000

Creating review features...
Review features shape: (7761, 4)
Sample review features:
      user_id  total_reviews  avg_rating_given  total_helpful_votes
0  user_00001              1          4.000000                  0.0
1  user_00002              4          3.500000                 10.0
2  user_00003              1          4.000000                  0.0
3  user_00004              4          2.250000                 13.0
4  user_00005              3          3.333333                  8.0</code></pre>
</div>
</div>
</section>
<section id="merge-features-and-data-preprocessing" class="level2">
<h2 class="anchored" data-anchor-id="merge-features-and-data-preprocessing">4. Merge Features and Data Preprocessing</h2>
<section id="feature-summary-and-visualization" class="level3">
<h3 class="anchored" data-anchor-id="feature-summary-and-visualization">Feature Summary and Visualization</h3>
<p>Lets examine all the features weve created from different data sources and visualize their distributions and statistics.</p>
<div id="ee90190c" class="cell" data-execution_count="11">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Feature Summary Tables</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"FEATURE ENGINEERING SUMMARY"</span>)</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Watch History Features</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">1. WATCH HISTORY FEATURES"</span>)</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">80</span>)</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Number of features: </span><span class="sc">{</span><span class="bu">len</span>(watch_features.columns) <span class="op">-</span> <span class="dv">1</span><span class="sc">}</span><span class="ss">"</span>)  <span class="co"># excluding user_id</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Users with watch history: </span><span class="sc">{</span><span class="bu">len</span>(watch_features)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Feature list:"</span>)</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> col <span class="kw">in</span> watch_features.columns[<span class="dv">1</span>:]:</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  - </span><span class="sc">{</span>col<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Watch Features Statistics:"</span>)</span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>watch_stats <span class="op">=</span> watch_features.drop(<span class="st">'user_id'</span>, axis<span class="op">=</span><span class="dv">1</span>).describe().<span class="bu">round</span>(<span class="dv">2</span>)</span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(watch_stats)</span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Recommendation Features</span></span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"2. RECOMMENDATION FEATURES"</span>)</span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">80</span>)</span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Number of features: </span><span class="sc">{</span><span class="bu">len</span>(rec_features.columns) <span class="op">-</span> <span class="dv">1</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Users with recommendations: </span><span class="sc">{</span><span class="bu">len</span>(rec_features)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Feature list:"</span>)</span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> col <span class="kw">in</span> rec_features.columns[<span class="dv">1</span>:]:</span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  - </span><span class="sc">{</span>col<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Recommendation Features Statistics:"</span>)</span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a>rec_stats <span class="op">=</span> rec_features.drop(<span class="st">'user_id'</span>, axis<span class="op">=</span><span class="dv">1</span>).describe().<span class="bu">round</span>(<span class="dv">2</span>)</span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(rec_stats)</span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Search Features</span></span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"3. SEARCH FEATURES"</span>)</span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">80</span>)</span>
<span id="cb19-37"><a href="#cb19-37" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Number of features: </span><span class="sc">{</span><span class="bu">len</span>(search_features.columns) <span class="op">-</span> <span class="dv">1</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb19-38"><a href="#cb19-38" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Users with search history: </span><span class="sc">{</span><span class="bu">len</span>(search_features)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb19-39"><a href="#cb19-39" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Feature list:"</span>)</span>
<span id="cb19-40"><a href="#cb19-40" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> col <span class="kw">in</span> search_features.columns[<span class="dv">1</span>:]:</span>
<span id="cb19-41"><a href="#cb19-41" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  - </span><span class="sc">{</span>col<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb19-42"><a href="#cb19-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-43"><a href="#cb19-43" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Search Features Statistics:"</span>)</span>
<span id="cb19-44"><a href="#cb19-44" aria-hidden="true" tabindex="-1"></a>search_stats <span class="op">=</span> search_features.drop(<span class="st">'user_id'</span>, axis<span class="op">=</span><span class="dv">1</span>).describe().<span class="bu">round</span>(<span class="dv">2</span>)</span>
<span id="cb19-45"><a href="#cb19-45" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(search_stats)</span>
<span id="cb19-46"><a href="#cb19-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-47"><a href="#cb19-47" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. Review Features</span></span>
<span id="cb19-48"><a href="#cb19-48" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb19-49"><a href="#cb19-49" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"4. REVIEW FEATURES"</span>)</span>
<span id="cb19-50"><a href="#cb19-50" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">80</span>)</span>
<span id="cb19-51"><a href="#cb19-51" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Number of features: </span><span class="sc">{</span><span class="bu">len</span>(review_features.columns) <span class="op">-</span> <span class="dv">1</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb19-52"><a href="#cb19-52" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Users with reviews: </span><span class="sc">{</span><span class="bu">len</span>(review_features)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb19-53"><a href="#cb19-53" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Feature list:"</span>)</span>
<span id="cb19-54"><a href="#cb19-54" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> col <span class="kw">in</span> review_features.columns[<span class="dv">1</span>:]:</span>
<span id="cb19-55"><a href="#cb19-55" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  - </span><span class="sc">{</span>col<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb19-56"><a href="#cb19-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-57"><a href="#cb19-57" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Review Features Statistics:"</span>)</span>
<span id="cb19-58"><a href="#cb19-58" aria-hidden="true" tabindex="-1"></a>review_stats <span class="op">=</span> review_features.drop(<span class="st">'user_id'</span>, axis<span class="op">=</span><span class="dv">1</span>).describe().<span class="bu">round</span>(<span class="dv">2</span>)</span>
<span id="cb19-59"><a href="#cb19-59" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(review_stats)</span>
<span id="cb19-60"><a href="#cb19-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-61"><a href="#cb19-61" aria-hidden="true" tabindex="-1"></a><span class="co"># Overall summary</span></span>
<span id="cb19-62"><a href="#cb19-62" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb19-63"><a href="#cb19-63" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"OVERALL FEATURE SUMMARY"</span>)</span>
<span id="cb19-64"><a href="#cb19-64" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb19-65"><a href="#cb19-65" aria-hidden="true" tabindex="-1"></a>total_features <span class="op">=</span> (<span class="bu">len</span>(watch_features.columns) <span class="op">-</span> <span class="dv">1</span> <span class="op">+</span> <span class="bu">len</span>(rec_features.columns) <span class="op">-</span> <span class="dv">1</span> <span class="op">+</span> </span>
<span id="cb19-66"><a href="#cb19-66" aria-hidden="true" tabindex="-1"></a>                  <span class="bu">len</span>(search_features.columns) <span class="op">-</span> <span class="dv">1</span> <span class="op">+</span> <span class="bu">len</span>(review_features.columns) <span class="op">-</span> <span class="dv">1</span>)</span>
<span id="cb19-67"><a href="#cb19-67" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Total engineered features: </span><span class="sc">{</span>total_features<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb19-68"><a href="#cb19-68" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  - Watch history: </span><span class="sc">{</span><span class="bu">len</span>(watch_features.columns) <span class="op">-</span> <span class="dv">1</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb19-69"><a href="#cb19-69" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  - Recommendations: </span><span class="sc">{</span><span class="bu">len</span>(rec_features.columns) <span class="op">-</span> <span class="dv">1</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb19-70"><a href="#cb19-70" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  - Search: </span><span class="sc">{</span><span class="bu">len</span>(search_features.columns) <span class="op">-</span> <span class="dv">1</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb19-71"><a href="#cb19-71" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  - Reviews: </span><span class="sc">{</span><span class="bu">len</span>(review_features.columns) <span class="op">-</span> <span class="dv">1</span><span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>================================================================================
FEATURE ENGINEERING SUMMARY
================================================================================

1. WATCH HISTORY FEATURES
--------------------------------------------------------------------------------
Number of features: 12
Users with watch history: 10000

Feature list:
  - total_sessions
  - total_watch_minutes
  - avg_watch_minutes
  - std_watch_minutes
  - avg_progress
  - std_progress
  - total_downloads
  - total_ratings
  - action_completed
  - action_paused
  - action_started
  - action_stopped

Watch Features Statistics:
       total_sessions  total_watch_minutes  avg_watch_minutes  \
count        10000.00             10000.00           10000.00   
mean            10.00               579.67              65.79   
std              3.16               278.70              24.63   
min              2.00                 5.50               2.75   
25%              8.00               383.98              50.55   
50%             10.00               533.95              60.80   
75%             12.00               721.95              73.84   
max             23.00              2433.50             254.68   

       std_watch_minutes  avg_progress  std_progress  total_downloads  \
count           10000.00      10000.00      10000.00         10000.00   
mean               52.18         49.95         28.23             2.01   
std                44.38         10.22          5.77             1.44   
min                 0.00          1.95          0.00             0.00   
25%                30.19         43.19         24.98             1.00   
50%                39.66         49.98         28.57             2.00   
75%                52.74         56.70         31.90             3.00   
max               370.61         95.36         56.29             9.00   

       total_ratings  action_completed  action_paused  action_started  \
count       10000.00          10000.00       10000.00        10000.00   
mean            2.01              2.48           2.50            2.52   
std             1.41              1.58           1.58            1.59   
min             0.00              0.00           0.00            0.00   
25%             1.00              1.00           1.00            1.00   
50%             2.00              2.00           2.00            2.00   
75%             3.00              3.00           3.00            4.00   
max             8.00             10.00          12.00           11.00   

       action_stopped  
count        10000.00  
mean             2.50  
std              1.58  
min              0.00  
25%              1.00  
50%              2.00  
75%              3.00  
max             10.00  

================================================================================
2. RECOMMENDATION FEATURES
--------------------------------------------------------------------------------
Number of features: 3
Users with recommendations: 9921

Feature list:
  - total_recommendations
  - total_clicks
  - click_through_rate

Recommendation Features Statistics:
       total_recommendations  total_clicks  click_through_rate
count                9921.00       9921.00             9921.00
mean                    5.24          0.79                0.15
std                     2.33          0.94                0.18
min                     1.00          0.00                0.00
25%                     4.00          0.00                0.00
50%                     5.00          1.00                0.12
75%                     7.00          1.00                0.25
max                    17.00          6.00                1.00

================================================================================
3. SEARCH FEATURES
--------------------------------------------------------------------------------
Number of features: 3
Users with search history: 9186

Feature list:
  - total_searches
  - avg_results
  - avg_query_length

Search Features Statistics:
       total_searches  avg_results  avg_query_length
count         9186.00      9186.00           9186.00
mean             2.88        50.11             14.93
std              1.61        20.73              3.62
min              1.00         0.00              6.00
25%              2.00        36.33             12.75
50%              3.00        50.25             14.25
75%              4.00        64.00             16.33
max             10.00       100.00             31.00

================================================================================
4. REVIEW FEATURES
--------------------------------------------------------------------------------
Number of features: 3
Users with reviews: 7761

Feature list:
  - total_reviews
  - avg_rating_given
  - total_helpful_votes

Review Features Statistics:
       total_reviews  avg_rating_given  total_helpful_votes
count        7761.00           7761.00              7761.00
mean            1.99              3.66                 5.27
std             1.11              0.91                 4.05
min             1.00              1.00                 0.00
25%             1.00              3.00                 2.00
50%             2.00              4.00                 4.00
75%             3.00              4.00                 7.00
max             8.00              5.00                29.00

================================================================================
OVERALL FEATURE SUMMARY
================================================================================
Total engineered features: 21
  - Watch history: 12
  - Recommendations: 3
  - Search: 3
  - Reviews: 3</code></pre>
</div>
</div>
<div id="e379324a" class="cell" data-execution_count="12">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize feature distributions</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">3</span>, <span class="dv">4</span>, figsize<span class="op">=</span>(<span class="dv">18</span>, <span class="dv">14</span>))</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>fig.suptitle(<span class="st">'Engineered Features Distribution'</span>, fontsize<span class="op">=</span><span class="dv">16</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>, y<span class="op">=</span><span class="fl">0.995</span>)</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Watch History Features (top 4)</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> axes[<span class="dv">0</span>, <span class="dv">0</span>]</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>ax.hist(watch_features[<span class="st">'total_sessions'</span>], bins<span class="op">=</span><span class="dv">30</span>, color<span class="op">=</span><span class="st">'steelblue'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>)</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">'Total Sessions'</span>, fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">'Frequency'</span>, fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">'Watch: Total Sessions'</span>, fontsize<span class="op">=</span><span class="dv">11</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>ax.grid(alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> axes[<span class="dv">0</span>, <span class="dv">1</span>]</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>ax.hist(watch_features[<span class="st">'total_watch_minutes'</span>], bins<span class="op">=</span><span class="dv">30</span>, color<span class="op">=</span><span class="st">'steelblue'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>)</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">'Total Watch Minutes'</span>, fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">'Frequency'</span>, fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">'Watch: Total Minutes'</span>, fontsize<span class="op">=</span><span class="dv">11</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>ax.grid(alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> axes[<span class="dv">0</span>, <span class="dv">2</span>]</span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>ax.hist(watch_features[<span class="st">'avg_progress'</span>], bins<span class="op">=</span><span class="dv">30</span>, color<span class="op">=</span><span class="st">'steelblue'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>)</span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">'Average Progress (%)'</span>, fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">'Frequency'</span>, fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">'Watch: Avg Progress'</span>, fontsize<span class="op">=</span><span class="dv">11</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a>ax.grid(alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> axes[<span class="dv">0</span>, <span class="dv">3</span>]</span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a>ax.hist(watch_features[<span class="st">'total_downloads'</span>], bins<span class="op">=</span><span class="dv">30</span>, color<span class="op">=</span><span class="st">'steelblue'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>)</span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">'Total Downloads'</span>, fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">'Frequency'</span>, fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">'Watch: Downloads'</span>, fontsize<span class="op">=</span><span class="dv">11</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a>ax.grid(alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb21-33"><a href="#cb21-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-34"><a href="#cb21-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Recommendation Features</span></span>
<span id="cb21-35"><a href="#cb21-35" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> axes[<span class="dv">1</span>, <span class="dv">0</span>]</span>
<span id="cb21-36"><a href="#cb21-36" aria-hidden="true" tabindex="-1"></a>ax.hist(rec_features[<span class="st">'total_recommendations'</span>], bins<span class="op">=</span><span class="dv">30</span>, color<span class="op">=</span><span class="st">'coral'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>)</span>
<span id="cb21-37"><a href="#cb21-37" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">'Total Recommendations'</span>, fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb21-38"><a href="#cb21-38" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">'Frequency'</span>, fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb21-39"><a href="#cb21-39" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">'Rec: Total Recommendations'</span>, fontsize<span class="op">=</span><span class="dv">11</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb21-40"><a href="#cb21-40" aria-hidden="true" tabindex="-1"></a>ax.grid(alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb21-41"><a href="#cb21-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-42"><a href="#cb21-42" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> axes[<span class="dv">1</span>, <span class="dv">1</span>]</span>
<span id="cb21-43"><a href="#cb21-43" aria-hidden="true" tabindex="-1"></a>ax.hist(rec_features[<span class="st">'total_clicks'</span>], bins<span class="op">=</span><span class="dv">30</span>, color<span class="op">=</span><span class="st">'coral'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>)</span>
<span id="cb21-44"><a href="#cb21-44" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">'Total Clicks'</span>, fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb21-45"><a href="#cb21-45" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">'Frequency'</span>, fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb21-46"><a href="#cb21-46" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">'Rec: Total Clicks'</span>, fontsize<span class="op">=</span><span class="dv">11</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb21-47"><a href="#cb21-47" aria-hidden="true" tabindex="-1"></a>ax.grid(alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb21-48"><a href="#cb21-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-49"><a href="#cb21-49" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> axes[<span class="dv">1</span>, <span class="dv">2</span>]</span>
<span id="cb21-50"><a href="#cb21-50" aria-hidden="true" tabindex="-1"></a>ax.hist(rec_features[<span class="st">'click_through_rate'</span>], bins<span class="op">=</span><span class="dv">30</span>, color<span class="op">=</span><span class="st">'coral'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>)</span>
<span id="cb21-51"><a href="#cb21-51" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">'Click-Through Rate'</span>, fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb21-52"><a href="#cb21-52" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">'Frequency'</span>, fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb21-53"><a href="#cb21-53" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">'Rec: Click-Through Rate'</span>, fontsize<span class="op">=</span><span class="dv">11</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb21-54"><a href="#cb21-54" aria-hidden="true" tabindex="-1"></a>ax.grid(alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb21-55"><a href="#cb21-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-56"><a href="#cb21-56" aria-hidden="true" tabindex="-1"></a><span class="co"># Search Features</span></span>
<span id="cb21-57"><a href="#cb21-57" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> axes[<span class="dv">1</span>, <span class="dv">3</span>]</span>
<span id="cb21-58"><a href="#cb21-58" aria-hidden="true" tabindex="-1"></a>ax.hist(search_features[<span class="st">'total_searches'</span>], bins<span class="op">=</span><span class="dv">30</span>, color<span class="op">=</span><span class="st">'lightgreen'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>)</span>
<span id="cb21-59"><a href="#cb21-59" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">'Total Searches'</span>, fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb21-60"><a href="#cb21-60" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">'Frequency'</span>, fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb21-61"><a href="#cb21-61" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">'Search: Total Searches'</span>, fontsize<span class="op">=</span><span class="dv">11</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb21-62"><a href="#cb21-62" aria-hidden="true" tabindex="-1"></a>ax.grid(alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb21-63"><a href="#cb21-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-64"><a href="#cb21-64" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> axes[<span class="dv">2</span>, <span class="dv">0</span>]</span>
<span id="cb21-65"><a href="#cb21-65" aria-hidden="true" tabindex="-1"></a>ax.hist(search_features[<span class="st">'avg_results'</span>], bins<span class="op">=</span><span class="dv">30</span>, color<span class="op">=</span><span class="st">'lightgreen'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>)</span>
<span id="cb21-66"><a href="#cb21-66" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">'Avg Results'</span>, fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb21-67"><a href="#cb21-67" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">'Frequency'</span>, fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb21-68"><a href="#cb21-68" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">'Search: Avg Results'</span>, fontsize<span class="op">=</span><span class="dv">11</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb21-69"><a href="#cb21-69" aria-hidden="true" tabindex="-1"></a>ax.grid(alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb21-70"><a href="#cb21-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-71"><a href="#cb21-71" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> axes[<span class="dv">2</span>, <span class="dv">1</span>]</span>
<span id="cb21-72"><a href="#cb21-72" aria-hidden="true" tabindex="-1"></a>ax.hist(search_features[<span class="st">'avg_query_length'</span>], bins<span class="op">=</span><span class="dv">30</span>, color<span class="op">=</span><span class="st">'lightgreen'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>)</span>
<span id="cb21-73"><a href="#cb21-73" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">'Avg Query Length'</span>, fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb21-74"><a href="#cb21-74" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">'Frequency'</span>, fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb21-75"><a href="#cb21-75" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">'Search: Avg Query Length'</span>, fontsize<span class="op">=</span><span class="dv">11</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb21-76"><a href="#cb21-76" aria-hidden="true" tabindex="-1"></a>ax.grid(alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb21-77"><a href="#cb21-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-78"><a href="#cb21-78" aria-hidden="true" tabindex="-1"></a><span class="co"># Review Features</span></span>
<span id="cb21-79"><a href="#cb21-79" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> axes[<span class="dv">2</span>, <span class="dv">2</span>]</span>
<span id="cb21-80"><a href="#cb21-80" aria-hidden="true" tabindex="-1"></a>ax.hist(review_features[<span class="st">'total_reviews'</span>], bins<span class="op">=</span><span class="dv">30</span>, color<span class="op">=</span><span class="st">'mediumpurple'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>)</span>
<span id="cb21-81"><a href="#cb21-81" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">'Total Reviews'</span>, fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb21-82"><a href="#cb21-82" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">'Frequency'</span>, fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb21-83"><a href="#cb21-83" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">'Review: Total Reviews'</span>, fontsize<span class="op">=</span><span class="dv">11</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb21-84"><a href="#cb21-84" aria-hidden="true" tabindex="-1"></a>ax.grid(alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb21-85"><a href="#cb21-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-86"><a href="#cb21-86" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> axes[<span class="dv">2</span>, <span class="dv">3</span>]</span>
<span id="cb21-87"><a href="#cb21-87" aria-hidden="true" tabindex="-1"></a>ax.hist(review_features[<span class="st">'avg_rating_given'</span>], bins<span class="op">=</span><span class="dv">30</span>, color<span class="op">=</span><span class="st">'mediumpurple'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>)</span>
<span id="cb21-88"><a href="#cb21-88" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">'Avg Rating Given'</span>, fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb21-89"><a href="#cb21-89" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">'Frequency'</span>, fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb21-90"><a href="#cb21-90" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">'Review: Avg Rating'</span>, fontsize<span class="op">=</span><span class="dv">11</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb21-91"><a href="#cb21-91" aria-hidden="true" tabindex="-1"></a>ax.grid(alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb21-92"><a href="#cb21-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-93"><a href="#cb21-93" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb21-94"><a href="#cb21-94" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="random_forest_files/figure-html/cell-13-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="5af4f875" class="cell" data-execution_count="13">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Feature correlation heatmap (top features)</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"FEATURE CORRELATION ANALYSIS"</span>)</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Select key features for correlation analysis</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>key_features <span class="op">=</span> pd.DataFrame()</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>key_features[<span class="st">'total_sessions'</span>] <span class="op">=</span> watch_features[<span class="st">'total_sessions'</span>]</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>key_features[<span class="st">'total_watch_minutes'</span>] <span class="op">=</span> watch_features[<span class="st">'total_watch_minutes'</span>]</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>key_features[<span class="st">'avg_progress'</span>] <span class="op">=</span> watch_features[<span class="st">'avg_progress'</span>]</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>key_features[<span class="st">'total_downloads'</span>] <span class="op">=</span> watch_features[<span class="st">'total_downloads'</span>]</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>key_features[<span class="st">'total_recommendations'</span>] <span class="op">=</span> rec_features[<span class="st">'total_recommendations'</span>]</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>key_features[<span class="st">'click_through_rate'</span>] <span class="op">=</span> rec_features[<span class="st">'click_through_rate'</span>]</span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>key_features[<span class="st">'total_searches'</span>] <span class="op">=</span> search_features[<span class="st">'total_searches'</span>]</span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>key_features[<span class="st">'total_reviews'</span>] <span class="op">=</span> review_features[<span class="st">'total_reviews'</span>]</span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>key_features[<span class="st">'avg_rating_given'</span>] <span class="op">=</span> review_features[<span class="st">'avg_rating_given'</span>]</span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate correlation matrix</span></span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>correlation_matrix <span class="op">=</span> key_features.corr()</span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot correlation heatmap</span></span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">10</span>))</span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a>sns.heatmap(correlation_matrix, annot<span class="op">=</span><span class="va">True</span>, fmt<span class="op">=</span><span class="st">'.2f'</span>, cmap<span class="op">=</span><span class="st">'coolwarm'</span>, center<span class="op">=</span><span class="dv">0</span>,</span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a>            square<span class="op">=</span><span class="va">True</span>, linewidths<span class="op">=</span><span class="dv">1</span>, cbar_kws<span class="op">=</span>{<span class="st">"shrink"</span>: <span class="fl">0.8</span>}, ax<span class="op">=</span>ax)</span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">'Feature Correlation Heatmap (Key Features)'</span>, fontsize<span class="op">=</span><span class="dv">14</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>, pad<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a>plt.xticks(rotation<span class="op">=</span><span class="dv">45</span>, ha<span class="op">=</span><span class="st">'right'</span>)</span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a>plt.yticks(rotation<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Print top correlations</span></span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Top Positive Correlations:"</span>)</span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">80</span>)</span>
<span id="cb22-34"><a href="#cb22-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Get upper triangle of correlation matrix</span></span>
<span id="cb22-35"><a href="#cb22-35" aria-hidden="true" tabindex="-1"></a>upper_triangle <span class="op">=</span> correlation_matrix.where(</span>
<span id="cb22-36"><a href="#cb22-36" aria-hidden="true" tabindex="-1"></a>    np.triu(np.ones(correlation_matrix.shape), k<span class="op">=</span><span class="dv">1</span>).astype(<span class="bu">bool</span>)</span>
<span id="cb22-37"><a href="#cb22-37" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb22-38"><a href="#cb22-38" aria-hidden="true" tabindex="-1"></a><span class="co"># Stack and sort</span></span>
<span id="cb22-39"><a href="#cb22-39" aria-hidden="true" tabindex="-1"></a>correlations <span class="op">=</span> upper_triangle.stack().sort_values(ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb22-40"><a href="#cb22-40" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(correlations.head(<span class="dv">10</span>))</span>
<span id="cb22-41"><a href="#cb22-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-42"><a href="#cb22-42" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Top Negative Correlations:"</span>)</span>
<span id="cb22-43"><a href="#cb22-43" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">80</span>)</span>
<span id="cb22-44"><a href="#cb22-44" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(correlations.tail(<span class="dv">10</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>================================================================================
FEATURE CORRELATION ANALYSIS
================================================================================</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="random_forest_files/figure-html/cell-14-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
Top Positive Correlations:
--------------------------------------------------------------------------------
total_sessions         total_watch_minutes      0.649198
                       total_downloads          0.457779
total_watch_minutes    total_downloads          0.315268
total_recommendations  avg_rating_given         0.024331
avg_progress           total_searches           0.019868
click_through_rate     total_reviews            0.014118
total_recommendations  total_reviews            0.012613
total_reviews          avg_rating_given         0.009376
total_sessions         avg_progress             0.008175
                       total_recommendations    0.007426
dtype: float64

Top Negative Correlations:
--------------------------------------------------------------------------------
click_through_rate   total_searches          -0.004329
total_downloads      total_searches          -0.004967
total_watch_minutes  total_recommendations   -0.005490
                     total_searches          -0.007013
total_downloads      click_through_rate      -0.012415
avg_progress         total_reviews           -0.013141
total_searches       total_reviews           -0.014057
total_sessions       click_through_rate      -0.015257
                     total_searches          -0.015599
total_watch_minutes  click_through_rate      -0.026420
dtype: float64</code></pre>
</div>
</div>
<div id="96a7d1a2" class="cell" data-execution_count="14">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Feature comparison by user activity status</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"FEATURE COMPARISON: ACTIVE vs INACTIVE USERS"</span>)</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge features with user activity status for comparison</span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>feature_comparison <span class="op">=</span> users[[<span class="st">'user_id'</span>, <span class="st">'is_active'</span>]].copy()</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>feature_comparison <span class="op">=</span> feature_comparison.merge(watch_features, on<span class="op">=</span><span class="st">'user_id'</span>, how<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>feature_comparison <span class="op">=</span> feature_comparison.merge(rec_features, on<span class="op">=</span><span class="st">'user_id'</span>, how<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>feature_comparison <span class="op">=</span> feature_comparison.merge(search_features, on<span class="op">=</span><span class="st">'user_id'</span>, how<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>feature_comparison <span class="op">=</span> feature_comparison.merge(review_features, on<span class="op">=</span><span class="st">'user_id'</span>, how<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Fill NaN with 0 for users with no activity</span></span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>feature_comparison <span class="op">=</span> feature_comparison.fillna(<span class="dv">0</span>)</span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare key metrics between active and inactive users</span></span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Key Metrics Comparison:"</span>)</span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">80</span>)</span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a>comparison_metrics <span class="op">=</span> [<span class="st">'total_sessions'</span>, <span class="st">'total_watch_minutes'</span>, <span class="st">'avg_progress'</span>, </span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a>                     <span class="st">'total_recommendations'</span>, <span class="st">'click_through_rate'</span>, </span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a>                     <span class="st">'total_searches'</span>, <span class="st">'total_reviews'</span>, <span class="st">'avg_rating_given'</span>]</span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a>comparison_table <span class="op">=</span> []</span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> metric <span class="kw">in</span> comparison_metrics:</span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> metric <span class="kw">in</span> feature_comparison.columns:</span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a>        active_mean <span class="op">=</span> feature_comparison[feature_comparison[<span class="st">'is_active'</span>] <span class="op">==</span> <span class="va">True</span>][metric].mean()</span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true" tabindex="-1"></a>        inactive_mean <span class="op">=</span> feature_comparison[feature_comparison[<span class="st">'is_active'</span>] <span class="op">==</span> <span class="va">False</span>][metric].mean()</span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true" tabindex="-1"></a>        difference <span class="op">=</span> active_mean <span class="op">-</span> inactive_mean</span>
<span id="cb25-30"><a href="#cb25-30" aria-hidden="true" tabindex="-1"></a>        pct_diff <span class="op">=</span> (difference <span class="op">/</span> inactive_mean <span class="op">*</span> <span class="dv">100</span>) <span class="cf">if</span> inactive_mean <span class="op">!=</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb25-31"><a href="#cb25-31" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb25-32"><a href="#cb25-32" aria-hidden="true" tabindex="-1"></a>        comparison_table.append({</span>
<span id="cb25-33"><a href="#cb25-33" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Feature'</span>: metric,</span>
<span id="cb25-34"><a href="#cb25-34" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Active (mean)'</span>: <span class="ss">f'</span><span class="sc">{</span>active_mean<span class="sc">:.2f}</span><span class="ss">'</span>,</span>
<span id="cb25-35"><a href="#cb25-35" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Inactive (mean)'</span>: <span class="ss">f'</span><span class="sc">{</span>inactive_mean<span class="sc">:.2f}</span><span class="ss">'</span>,</span>
<span id="cb25-36"><a href="#cb25-36" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Difference'</span>: <span class="ss">f'</span><span class="sc">{</span>difference<span class="sc">:.2f}</span><span class="ss">'</span>,</span>
<span id="cb25-37"><a href="#cb25-37" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Change (%)'</span>: <span class="ss">f'</span><span class="sc">{</span>pct_diff<span class="sc">:.1f}</span><span class="ss">%'</span></span>
<span id="cb25-38"><a href="#cb25-38" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb25-39"><a href="#cb25-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-40"><a href="#cb25-40" aria-hidden="true" tabindex="-1"></a>comparison_df <span class="op">=</span> pd.DataFrame(comparison_table)</span>
<span id="cb25-41"><a href="#cb25-41" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(comparison_df.to_string(index<span class="op">=</span><span class="va">False</span>))</span>
<span id="cb25-42"><a href="#cb25-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-43"><a href="#cb25-43" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize comparison</span></span>
<span id="cb25-44"><a href="#cb25-44" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">4</span>, figsize<span class="op">=</span>(<span class="dv">18</span>, <span class="dv">8</span>))</span>
<span id="cb25-45"><a href="#cb25-45" aria-hidden="true" tabindex="-1"></a>fig.suptitle(<span class="st">'Feature Comparison: Active vs Inactive Users'</span>, fontsize<span class="op">=</span><span class="dv">16</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb25-46"><a href="#cb25-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-47"><a href="#cb25-47" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> idx, metric <span class="kw">in</span> <span class="bu">enumerate</span>(comparison_metrics[:<span class="dv">8</span>]):</span>
<span id="cb25-48"><a href="#cb25-48" aria-hidden="true" tabindex="-1"></a>    row <span class="op">=</span> idx <span class="op">//</span> <span class="dv">4</span></span>
<span id="cb25-49"><a href="#cb25-49" aria-hidden="true" tabindex="-1"></a>    col <span class="op">=</span> idx <span class="op">%</span> <span class="dv">4</span></span>
<span id="cb25-50"><a href="#cb25-50" aria-hidden="true" tabindex="-1"></a>    ax <span class="op">=</span> axes[row, col]</span>
<span id="cb25-51"><a href="#cb25-51" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-52"><a href="#cb25-52" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> metric <span class="kw">in</span> feature_comparison.columns:</span>
<span id="cb25-53"><a href="#cb25-53" aria-hidden="true" tabindex="-1"></a>        active_data <span class="op">=</span> feature_comparison[feature_comparison[<span class="st">'is_active'</span>] <span class="op">==</span> <span class="va">True</span>][metric]</span>
<span id="cb25-54"><a href="#cb25-54" aria-hidden="true" tabindex="-1"></a>        inactive_data <span class="op">=</span> feature_comparison[feature_comparison[<span class="st">'is_active'</span>] <span class="op">==</span> <span class="va">False</span>][metric]</span>
<span id="cb25-55"><a href="#cb25-55" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb25-56"><a href="#cb25-56" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Box plot</span></span>
<span id="cb25-57"><a href="#cb25-57" aria-hidden="true" tabindex="-1"></a>        box_data <span class="op">=</span> [active_data, inactive_data]</span>
<span id="cb25-58"><a href="#cb25-58" aria-hidden="true" tabindex="-1"></a>        bp <span class="op">=</span> ax.boxplot(box_data, labels<span class="op">=</span>[<span class="st">'Active'</span>, <span class="st">'Inactive'</span>], patch_artist<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb25-59"><a href="#cb25-59" aria-hidden="true" tabindex="-1"></a>        bp[<span class="st">'boxes'</span>][<span class="dv">0</span>].set_facecolor(<span class="st">'#4ecdc4'</span>)</span>
<span id="cb25-60"><a href="#cb25-60" aria-hidden="true" tabindex="-1"></a>        bp[<span class="st">'boxes'</span>][<span class="dv">1</span>].set_facecolor(<span class="st">'#ff6b6b'</span>)</span>
<span id="cb25-61"><a href="#cb25-61" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb25-62"><a href="#cb25-62" aria-hidden="true" tabindex="-1"></a>        ax.set_ylabel(metric.replace(<span class="st">'_'</span>, <span class="st">' '</span>).title(), fontsize<span class="op">=</span><span class="dv">9</span>)</span>
<span id="cb25-63"><a href="#cb25-63" aria-hidden="true" tabindex="-1"></a>        ax.set_title(metric.replace(<span class="st">'_'</span>, <span class="st">' '</span>).title(), fontsize<span class="op">=</span><span class="dv">10</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb25-64"><a href="#cb25-64" aria-hidden="true" tabindex="-1"></a>        ax.grid(axis<span class="op">=</span><span class="st">'y'</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb25-65"><a href="#cb25-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-66"><a href="#cb25-66" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb25-67"><a href="#cb25-67" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>================================================================================
FEATURE COMPARISON: ACTIVE vs INACTIVE USERS
================================================================================

Key Metrics Comparison:
--------------------------------------------------------------------------------
              Feature Active (mean) Inactive (mean) Difference Change (%)
       total_sessions         10.00           10.01      -0.02      -0.2%
  total_watch_minutes        579.60          580.09      -0.48      -0.1%
         avg_progress         49.97           49.81       0.16       0.3%
total_recommendations          5.20            5.20       0.00       0.1%
   click_through_rate          0.15            0.15       0.00       1.3%
       total_searches          2.65            2.67      -0.03      -1.0%
        total_reviews          1.54            1.58      -0.04      -2.5%
     avg_rating_given          2.83            2.86      -0.03      -1.1%</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="random_forest_files/figure-html/cell-15-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="0fe66614" class="cell" data-execution_count="15">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge all features with users table</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Merging all features..."</span>)</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> users.copy()</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df.merge(watch_features, on<span class="op">=</span><span class="st">'user_id'</span>, how<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df.merge(rec_features, on<span class="op">=</span><span class="st">'user_id'</span>, how<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df.merge(search_features, on<span class="op">=</span><span class="st">'user_id'</span>, how<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df.merge(review_features, on<span class="op">=</span><span class="st">'user_id'</span>, how<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Merged dataset shape: </span><span class="sc">{</span>df<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Columns: </span><span class="sc">{</span>df<span class="sc">.</span>columns<span class="sc">.</span>tolist()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Handle missing values from merges (users with no activity in certain tables)</span></span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Filling missing values from left joins with 0..."</span>)</span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>activity_columns <span class="op">=</span> watch_features.columns.tolist()[<span class="dv">1</span>:] <span class="op">+</span> rec_features.columns.tolist()[<span class="dv">1</span>:] <span class="op">+</span> <span class="op">\</span></span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>                   search_features.columns.tolist()[<span class="dv">1</span>:] <span class="op">+</span> review_features.columns.tolist()[<span class="dv">1</span>:]</span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>                   </span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> col <span class="kw">in</span> activity_columns:</span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> col <span class="kw">in</span> df.columns:</span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a>        df[col] <span class="op">=</span> df[col].fillna(<span class="dv">0</span>)</span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Missing values after filling activity metrics:"</span>)</span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(df.isnull().<span class="bu">sum</span>().<span class="bu">sum</span>())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Merging all features...
Merged dataset shape: (10000, 37)

Columns: ['user_id', 'email', 'first_name', 'last_name', 'age', 'gender', 'country', 'state_province', 'city', 'subscription_plan', 'subscription_start_date', 'is_active', 'monthly_spend', 'primary_device', 'household_size', 'created_at', 'total_sessions', 'total_watch_minutes', 'avg_watch_minutes', 'std_watch_minutes', 'avg_progress', 'std_progress', 'total_downloads', 'total_ratings', 'action_completed', 'action_paused', 'action_started', 'action_stopped', 'total_recommendations', 'total_clicks', 'click_through_rate', 'total_searches', 'avg_results', 'avg_query_length', 'total_reviews', 'avg_rating_given', 'total_helpful_votes']

Filling missing values from left joins with 0...

Missing values after filling activity metrics:
1194</code></pre>
</div>
</div>
<div id="5810a5ee" class="cell" data-execution_count="16">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Prepare features for modeling</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"FEATURE PREPARATION FOR MODELING"</span>)</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Select features for modeling</span></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Exclude: user_id, email, names, dates, text fields</span></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>exclude_cols <span class="op">=</span> [<span class="st">'user_id'</span>, <span class="st">'email'</span>, <span class="st">'first_name'</span>, <span class="st">'last_name'</span>, <span class="st">'subscription_start_date'</span>, <span class="st">'created_at'</span>]</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Separate target variable</span></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> df[<span class="st">'is_active'</span>].astype(<span class="bu">int</span>)</span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> df.drop(columns<span class="op">=</span>exclude_cols <span class="op">+</span> [<span class="st">'is_active'</span>])</span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Target variable shape: </span><span class="sc">{</span>y<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Features shape: </span><span class="sc">{</span>X<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Features to be used (</span><span class="sc">{</span><span class="bu">len</span>(X.columns)<span class="sc">}</span><span class="ss">):"</span>)</span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(X.columns.tolist())</span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Identify categorical and numerical columns</span></span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a>categorical_cols <span class="op">=</span> X.select_dtypes(include<span class="op">=</span>[<span class="st">'object'</span>]).columns.tolist()</span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a>numerical_cols <span class="op">=</span> X.select_dtypes(include<span class="op">=</span>[<span class="st">'int64'</span>, <span class="st">'float64'</span>]).columns.tolist()</span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Categorical features (</span><span class="sc">{</span><span class="bu">len</span>(categorical_cols)<span class="sc">}</span><span class="ss">): </span><span class="sc">{</span>categorical_cols<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Numerical features (</span><span class="sc">{</span><span class="bu">len</span>(numerical_cols)<span class="sc">}</span><span class="ss">): </span><span class="sc">{</span><span class="bu">len</span>(numerical_cols)<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>================================================================================
FEATURE PREPARATION FOR MODELING
================================================================================

Target variable shape: (10000,)
Features shape: (10000, 30)

Features to be used (30):
['age', 'gender', 'country', 'state_province', 'city', 'subscription_plan', 'monthly_spend', 'primary_device', 'household_size', 'total_sessions', 'total_watch_minutes', 'avg_watch_minutes', 'std_watch_minutes', 'avg_progress', 'std_progress', 'total_downloads', 'total_ratings', 'action_completed', 'action_paused', 'action_started', 'action_stopped', 'total_recommendations', 'total_clicks', 'click_through_rate', 'total_searches', 'avg_results', 'avg_query_length', 'total_reviews', 'avg_rating_given', 'total_helpful_votes']

Categorical features (6): ['gender', 'country', 'state_province', 'city', 'subscription_plan', 'primary_device']
Numerical features (24): 24</code></pre>
</div>
</div>
<div id="5c88baca" class="cell" data-execution_count="17">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Check categorical values before encoding</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"CATEGORICAL FEATURE VALUES CHECK"</span>)</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> col <span class="kw">in</span> categorical_cols:</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span>col<span class="sc">.</span>upper()<span class="sc">}</span><span class="ss">:"</span>)</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">80</span>)</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>    value_counts <span class="op">=</span> X[col].value_counts()</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Total unique values: </span><span class="sc">{</span><span class="bu">len</span>(value_counts)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Value distribution:"</span>)</span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(value_counts)</span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Check for any unusual values</span></span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Gender value lengths:"</span>)</span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> val <span class="kw">in</span> X[<span class="st">'gender'</span>].unique():</span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  '</span><span class="sc">{</span>val<span class="sc">}</span><span class="ss">': length = </span><span class="sc">{</span><span class="bu">len</span>(<span class="bu">str</span>(val))<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>================================================================================
CATEGORICAL FEATURE VALUES CHECK
================================================================================

GENDER:
--------------------------------------------------------------------------------
Total unique values: 4
Value distribution:
gender
Female               4203
Male                 4096
Prefer not to say    1256
Other                 445
Name: count, dtype: int64

COUNTRY:
--------------------------------------------------------------------------------
Total unique values: 2
Value distribution:
country
USA       6993
Canada    3007
Name: count, dtype: int64

STATE_PROVINCE:
--------------------------------------------------------------------------------
Total unique values: 30
Value distribution:
state_province
North Carolina               397
Tennessee                    380
Texas                        369
Indiana                      361
Michigan                     353
Arizona                      350
Virginia                     349
Wisconsin                    349
California                   348
Maryland                     346
Illinois                     343
Pennsylvania                 342
Georgia                      342
New Jersey                   341
Ohio                         341
Florida                      340
New York                     340
Missouri                     339
Massachusetts                339
Nova Scotia                  336
Washington                   324
Ontario                      312
Quebec                       310
Prince Edward Island         306
Alberta                      300
Newfoundland and Labrador    298
British Columbia             298
Manitoba                     289
New Brunswick                283
Saskatchewan                 275
Name: count, dtype: int64

CITY:
--------------------------------------------------------------------------------
Total unique values: 7762
Value distribution:
city
North Michael     14
West Michael      10
North Jennifer     9
Lake Michael       9
East Jennifer      8
                  ..
Mccarthymouth      1
Kingland           1
Myersmouth         1
Shannonborough     1
Reyestown          1
Name: count, Length: 7762, dtype: int64

SUBSCRIPTION_PLAN:
--------------------------------------------------------------------------------
Total unique values: 4
Value distribution:
subscription_plan
Standard    3522
Premium     3507
Basic       1966
Premium+    1005
Name: count, dtype: int64

PRIMARY_DEVICE:
--------------------------------------------------------------------------------
Total unique values: 6
Value distribution:
primary_device
Desktop           1751
Tablet            1685
Smart TV          1667
Laptop            1662
Gaming Console    1626
Mobile            1609
Name: count, dtype: int64

Gender value lengths:
  'Male': length = 4
  'Female': length = 6
  'Prefer not to say': length = 17
  'Other': length = 5</code></pre>
</div>
</div>
<div id="58a689a8" class="cell" data-execution_count="18">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Encode categorical variables</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Encoding categorical variables..."</span>)</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>label_encoders <span class="op">=</span> {}</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>X_encoded <span class="op">=</span> X.copy()</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> col <span class="kw">in</span> categorical_cols:</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>    le <span class="op">=</span> LabelEncoder()</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>    X_encoded[col] <span class="op">=</span> le.fit_transform(X_encoded[col].astype(<span class="bu">str</span>))</span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>    label_encoders[col] <span class="op">=</span> le</span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>col<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span><span class="bu">len</span>(le.classes_)<span class="sc">}</span><span class="ss"> unique values"</span>)</span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Encoded features shape: </span><span class="sc">{</span>X_encoded<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Sample of encoded data:"</span>)</span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>X_encoded.head()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Encoding categorical variables...
  gender: 4 unique values
  country: 2 unique values
  state_province: 30 unique values
  city: 7762 unique values
  subscription_plan: 4 unique values
  primary_device: 6 unique values

Encoded features shape: (10000, 30)

Sample of encoded data:</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="18">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">age</th>
<th data-quarto-table-cell-role="th">gender</th>
<th data-quarto-table-cell-role="th">country</th>
<th data-quarto-table-cell-role="th">state_province</th>
<th data-quarto-table-cell-role="th">city</th>
<th data-quarto-table-cell-role="th">subscription_plan</th>
<th data-quarto-table-cell-role="th">monthly_spend</th>
<th data-quarto-table-cell-role="th">primary_device</th>
<th data-quarto-table-cell-role="th">household_size</th>
<th data-quarto-table-cell-role="th">total_sessions</th>
<th data-quarto-table-cell-role="th">total_watch_minutes</th>
<th data-quarto-table-cell-role="th">avg_watch_minutes</th>
<th data-quarto-table-cell-role="th">std_watch_minutes</th>
<th data-quarto-table-cell-role="th">avg_progress</th>
<th data-quarto-table-cell-role="th">std_progress</th>
<th data-quarto-table-cell-role="th">total_downloads</th>
<th data-quarto-table-cell-role="th">total_ratings</th>
<th data-quarto-table-cell-role="th">action_completed</th>
<th data-quarto-table-cell-role="th">action_paused</th>
<th data-quarto-table-cell-role="th">action_started</th>
<th data-quarto-table-cell-role="th">action_stopped</th>
<th data-quarto-table-cell-role="th">total_recommendations</th>
<th data-quarto-table-cell-role="th">total_clicks</th>
<th data-quarto-table-cell-role="th">click_through_rate</th>
<th data-quarto-table-cell-role="th">total_searches</th>
<th data-quarto-table-cell-role="th">avg_results</th>
<th data-quarto-table-cell-role="th">avg_query_length</th>
<th data-quarto-table-cell-role="th">total_reviews</th>
<th data-quarto-table-cell-role="th">avg_rating_given</th>
<th data-quarto-table-cell-role="th">total_helpful_votes</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>43.0</td>
<td>1</td>
<td>1</td>
<td>10</td>
<td>4590</td>
<td>0</td>
<td>36.06</td>
<td>2</td>
<td>1.0</td>
<td>12</td>
<td>529.9</td>
<td>66.237500</td>
<td>41.207071</td>
<td>65.854545</td>
<td>24.633772</td>
<td>4</td>
<td>4</td>
<td>6</td>
<td>2</td>
<td>2</td>
<td>2</td>
<td>3.0</td>
<td>0.0</td>
<td>0.000000</td>
<td>1.0</td>
<td>50.0</td>
<td>13.000000</td>
<td>1.0</td>
<td>4.000000</td>
<td>0.0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>38.0</td>
<td>1</td>
<td>1</td>
<td>26</td>
<td>4761</td>
<td>2</td>
<td>14.59</td>
<td>0</td>
<td>2.0</td>
<td>15</td>
<td>713.4</td>
<td>50.957143</td>
<td>27.359873</td>
<td>57.669231</td>
<td>35.839373</td>
<td>4</td>
<td>6</td>
<td>5</td>
<td>2</td>
<td>2</td>
<td>6</td>
<td>0.0</td>
<td>0.0</td>
<td>0.000000</td>
<td>3.0</td>
<td>59.0</td>
<td>18.333333</td>
<td>4.0</td>
<td>3.500000</td>
<td>10.0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>32.0</td>
<td>0</td>
<td>1</td>
<td>11</td>
<td>6902</td>
<td>3</td>
<td>11.71</td>
<td>0</td>
<td>3.0</td>
<td>8</td>
<td>594.2</td>
<td>74.275000</td>
<td>25.437641</td>
<td>42.528571</td>
<td>27.632090</td>
<td>2</td>
<td>1</td>
<td>3</td>
<td>2</td>
<td>1</td>
<td>2</td>
<td>6.0</td>
<td>2.0</td>
<td>0.333333</td>
<td>0.0</td>
<td>0.0</td>
<td>0.000000</td>
<td>1.0</td>
<td>4.000000</td>
<td>0.0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>18.0</td>
<td>1</td>
<td>1</td>
<td>19</td>
<td>6536</td>
<td>3</td>
<td>28.56</td>
<td>2</td>
<td>2.0</td>
<td>14</td>
<td>1146.7</td>
<td>88.207692</td>
<td>36.532211</td>
<td>38.764286</td>
<td>31.063548</td>
<td>3</td>
<td>3</td>
<td>4</td>
<td>6</td>
<td>1</td>
<td>3</td>
<td>4.0</td>
<td>0.0</td>
<td>0.000000</td>
<td>2.0</td>
<td>72.5</td>
<td>15.000000</td>
<td>4.0</td>
<td>2.250000</td>
<td>13.0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>21.0</td>
<td>0</td>
<td>1</td>
<td>1</td>
<td>7249</td>
<td>3</td>
<td>9.54</td>
<td>0</td>
<td>6.0</td>
<td>9</td>
<td>358.2</td>
<td>71.640000</td>
<td>61.048120</td>
<td>55.025000</td>
<td>28.044034</td>
<td>2</td>
<td>1</td>
<td>2</td>
<td>2</td>
<td>3</td>
<td>2</td>
<td>1.0</td>
<td>0.0</td>
<td>0.000000</td>
<td>2.0</td>
<td>66.0</td>
<td>19.000000</td>
<td>3.0</td>
<td>3.333333</td>
<td>8.0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="26197729" class="cell" data-execution_count="20">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Check for NaN values before train-test split</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"DATA VALIDATION"</span>)</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Checking for NaN values in encoded features..."</span>)</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>nan_count <span class="op">=</span> X_encoded.isnull().<span class="bu">sum</span>().<span class="bu">sum</span>()</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Total NaN values: </span><span class="sc">{</span>nan_count<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> nan_count <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">NaN values found per column:"</span>)</span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>    nan_cols <span class="op">=</span> X_encoded.isnull().<span class="bu">sum</span>()[X_encoded.isnull().<span class="bu">sum</span>() <span class="op">&gt;</span> <span class="dv">0</span>]</span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(nan_cols)</span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Filling NaN values with 0 (after encoding, NaN typically means missing category)..."</span>)</span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>    X_encoded <span class="op">=</span> X_encoded.fillna(<span class="dv">0</span>)</span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"NaN values filled successfully."</span>)</span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"No NaN values found. Data is clean."</span>)</span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">80</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb35-20"><a href="#cb35-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-21"><a href="#cb35-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Train-test split</span></span>
<span id="cb35-22"><a href="#cb35-22" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"TRAIN-TEST SPLIT"</span>)</span>
<span id="cb35-23"><a href="#cb35-23" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb35-24"><a href="#cb35-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-25"><a href="#cb35-25" aria-hidden="true" tabindex="-1"></a>X_train, X_test, y_train, y_test <span class="op">=</span> train_test_split(</span>
<span id="cb35-26"><a href="#cb35-26" aria-hidden="true" tabindex="-1"></a>    X_encoded, y, test_size<span class="op">=</span><span class="fl">0.2</span>, random_state<span class="op">=</span><span class="dv">42</span>, stratify<span class="op">=</span>y</span>
<span id="cb35-27"><a href="#cb35-27" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb35-28"><a href="#cb35-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-29"><a href="#cb35-29" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Training set: </span><span class="sc">{</span>X_train<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb35-30"><a href="#cb35-30" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Test set: </span><span class="sc">{</span>X_test<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb35-31"><a href="#cb35-31" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Training set target distribution:"</span>)</span>
<span id="cb35-32"><a href="#cb35-32" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(y_train.value_counts())</span>
<span id="cb35-33"><a href="#cb35-33" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Test set target distribution:"</span>)</span>
<span id="cb35-34"><a href="#cb35-34" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(y_test.value_counts())</span>
<span id="cb35-35"><a href="#cb35-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-36"><a href="#cb35-36" aria-hidden="true" tabindex="-1"></a><span class="co"># Store number of features for mtry calculations</span></span>
<span id="cb35-37"><a href="#cb35-37" aria-hidden="true" tabindex="-1"></a>n_features <span class="op">=</span> X_train.shape[<span class="dv">1</span>]</span>
<span id="cb35-38"><a href="#cb35-38" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">80</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb35-39"><a href="#cb35-39" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Total number of features (p): </span><span class="sc">{</span>n_features<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb35-40"><a href="#cb35-40" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  - sqrt(p) = </span><span class="sc">{</span><span class="bu">int</span>(np.sqrt(n_features))<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb35-41"><a href="#cb35-41" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  - p/3  </span><span class="sc">{</span><span class="bu">int</span>(n_features<span class="op">/</span><span class="dv">3</span>)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb35-42"><a href="#cb35-42" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">80</span><span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>================================================================================
DATA VALIDATION
================================================================================

Checking for NaN values in encoded features...
Total NaN values: 1194

NaN values found per column:
age    1194
dtype: int64

Filling NaN values with 0 (after encoding, NaN typically means missing category)...
NaN values filled successfully.

================================================================================
TRAIN-TEST SPLIT
================================================================================

Training set: (8000, 30)
Test set: (2000, 30)

Training set target distribution:
is_active
1    6815
0    1185
Name: count, dtype: int64

Test set target distribution:
is_active
1    1704
0     296
Name: count, dtype: int64

================================================================================
Total number of features (p): 30
  - sqrt(p) = 5
  - p/3  10
================================================================================</code></pre>
</div>
</div>
</section>
</section>
<section id="random-forest-with-different-m-values" class="level2">
<h2 class="anchored" data-anchor-id="random-forest-with-different-m-values">5. Random Forest with Different m Values</h2>
<p>Well train Random Forest models with three different values of m (max_features): 1. <strong>m = sqrt(p)</strong>: Default for classification (most common) 2. <strong>m = p/2 = 15</strong>: Half of the features at each split 3. <strong>m = p = 30</strong> (Bagging): Uses all features at each split</p>
<div id="de6dd55e" class="cell" data-execution_count="25">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define different m values to test</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>m_values <span class="op">=</span> {</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">'m = sqrt(p)'</span>: <span class="bu">int</span>(np.sqrt(n_features)),</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">'m = p/2'</span>: n_features <span class="op">//</span> <span class="dv">2</span>,  <span class="co"># p/2 = 15</span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">'m = p (Bagging)'</span>: n_features  <span class="co"># p = 30</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Store results</span></span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>rf_results <span class="op">=</span> {}</span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"TRAINING RANDOM FOREST MODELS WITH DIFFERENT m VALUES"</span>)</span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name, m_val <span class="kw">in</span> m_values.items():</span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">80</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Training Random Forest with </span><span class="sc">{</span>name<span class="sc">}</span><span class="ss"> = </span><span class="sc">{</span>m_val<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">80</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Train Random Forest</span></span>
<span id="cb37-21"><a href="#cb37-21" aria-hidden="true" tabindex="-1"></a>    rf_model <span class="op">=</span> RandomForestClassifier(</span>
<span id="cb37-22"><a href="#cb37-22" aria-hidden="true" tabindex="-1"></a>        n_estimators<span class="op">=</span><span class="dv">500</span>,</span>
<span id="cb37-23"><a href="#cb37-23" aria-hidden="true" tabindex="-1"></a>        max_features<span class="op">=</span>m_val,</span>
<span id="cb37-24"><a href="#cb37-24" aria-hidden="true" tabindex="-1"></a>        random_state<span class="op">=</span><span class="dv">42</span>,</span>
<span id="cb37-25"><a href="#cb37-25" aria-hidden="true" tabindex="-1"></a>        n_jobs<span class="op">=-</span><span class="dv">1</span>,</span>
<span id="cb37-26"><a href="#cb37-26" aria-hidden="true" tabindex="-1"></a>        min_samples_split<span class="op">=</span><span class="dv">5</span>,</span>
<span id="cb37-27"><a href="#cb37-27" aria-hidden="true" tabindex="-1"></a>        min_samples_leaf<span class="op">=</span><span class="dv">2</span></span>
<span id="cb37-28"><a href="#cb37-28" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb37-29"><a href="#cb37-29" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb37-30"><a href="#cb37-30" aria-hidden="true" tabindex="-1"></a>    rf_model.fit(X_train, y_train)</span>
<span id="cb37-31"><a href="#cb37-31" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb37-32"><a href="#cb37-32" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Predictions</span></span>
<span id="cb37-33"><a href="#cb37-33" aria-hidden="true" tabindex="-1"></a>    y_train_pred <span class="op">=</span> rf_model.predict(X_train)</span>
<span id="cb37-34"><a href="#cb37-34" aria-hidden="true" tabindex="-1"></a>    y_test_pred <span class="op">=</span> rf_model.predict(X_test)</span>
<span id="cb37-35"><a href="#cb37-35" aria-hidden="true" tabindex="-1"></a>    y_test_proba <span class="op">=</span> rf_model.predict_proba(X_test)[:, <span class="dv">1</span>]</span>
<span id="cb37-36"><a href="#cb37-36" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb37-37"><a href="#cb37-37" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate metrics</span></span>
<span id="cb37-38"><a href="#cb37-38" aria-hidden="true" tabindex="-1"></a>    train_accuracy <span class="op">=</span> accuracy_score(y_train, y_train_pred)</span>
<span id="cb37-39"><a href="#cb37-39" aria-hidden="true" tabindex="-1"></a>    test_accuracy <span class="op">=</span> accuracy_score(y_test, y_test_pred)</span>
<span id="cb37-40"><a href="#cb37-40" aria-hidden="true" tabindex="-1"></a>    train_error <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> train_accuracy</span>
<span id="cb37-41"><a href="#cb37-41" aria-hidden="true" tabindex="-1"></a>    test_error <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> test_accuracy</span>
<span id="cb37-42"><a href="#cb37-42" aria-hidden="true" tabindex="-1"></a>    auc_score <span class="op">=</span> roc_auc_score(y_test, y_test_proba)</span>
<span id="cb37-43"><a href="#cb37-43" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb37-44"><a href="#cb37-44" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Store results</span></span>
<span id="cb37-45"><a href="#cb37-45" aria-hidden="true" tabindex="-1"></a>    rf_results[name] <span class="op">=</span> {</span>
<span id="cb37-46"><a href="#cb37-46" aria-hidden="true" tabindex="-1"></a>        <span class="st">'model'</span>: rf_model,</span>
<span id="cb37-47"><a href="#cb37-47" aria-hidden="true" tabindex="-1"></a>        <span class="st">'train_accuracy'</span>: train_accuracy,</span>
<span id="cb37-48"><a href="#cb37-48" aria-hidden="true" tabindex="-1"></a>        <span class="st">'test_accuracy'</span>: test_accuracy,</span>
<span id="cb37-49"><a href="#cb37-49" aria-hidden="true" tabindex="-1"></a>        <span class="st">'train_error'</span>: train_error,</span>
<span id="cb37-50"><a href="#cb37-50" aria-hidden="true" tabindex="-1"></a>        <span class="st">'test_error'</span>: test_error,</span>
<span id="cb37-51"><a href="#cb37-51" aria-hidden="true" tabindex="-1"></a>        <span class="st">'auc'</span>: auc_score,</span>
<span id="cb37-52"><a href="#cb37-52" aria-hidden="true" tabindex="-1"></a>        <span class="st">'predictions'</span>: y_test_pred,</span>
<span id="cb37-53"><a href="#cb37-53" aria-hidden="true" tabindex="-1"></a>        <span class="st">'probabilities'</span>: y_test_proba,</span>
<span id="cb37-54"><a href="#cb37-54" aria-hidden="true" tabindex="-1"></a>        <span class="st">'confusion_matrix'</span>: confusion_matrix(y_test, y_test_pred)</span>
<span id="cb37-55"><a href="#cb37-55" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb37-56"><a href="#cb37-56" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb37-57"><a href="#cb37-57" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Results:"</span>)</span>
<span id="cb37-58"><a href="#cb37-58" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Training Accuracy: </span><span class="sc">{</span>train_accuracy<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb37-59"><a href="#cb37-59" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Training Error:    </span><span class="sc">{</span>train_error<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb37-60"><a href="#cb37-60" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Test Accuracy:     </span><span class="sc">{</span>test_accuracy<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb37-61"><a href="#cb37-61" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Test Error:        </span><span class="sc">{</span>test_error<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb37-62"><a href="#cb37-62" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  AUC Score:         </span><span class="sc">{</span>auc_score<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb37-63"><a href="#cb37-63" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb37-64"><a href="#cb37-64" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">80</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb37-65"><a href="#cb37-65" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"All Random Forest models trained successfully!"</span>)</span>
<span id="cb37-66"><a href="#cb37-66" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">80</span><span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>================================================================================
TRAINING RANDOM FOREST MODELS WITH DIFFERENT m VALUES
================================================================================

================================================================================
Training Random Forest with m = sqrt(p) = 5
================================================================================

Results:
  Training Accuracy: 0.9840
  Training Error:    0.0160
  Test Accuracy:     0.8520
  Test Error:        0.1480
  AUC Score:         0.4802

================================================================================
Training Random Forest with m = p/2 = 15
================================================================================

Results:
  Training Accuracy: 0.9840
  Training Error:    0.0160
  Test Accuracy:     0.8520
  Test Error:        0.1480
  AUC Score:         0.4802

================================================================================
Training Random Forest with m = p/2 = 15
================================================================================

Results:
  Training Accuracy: 0.9964
  Training Error:    0.0036
  Test Accuracy:     0.8520
  Test Error:        0.1480
  AUC Score:         0.4877

================================================================================
Training Random Forest with m = p (Bagging) = 30
================================================================================

Results:
  Training Accuracy: 0.9964
  Training Error:    0.0036
  Test Accuracy:     0.8520
  Test Error:        0.1480
  AUC Score:         0.4877

================================================================================
Training Random Forest with m = p (Bagging) = 30
================================================================================

Results:
  Training Accuracy: 0.9980
  Training Error:    0.0020
  Test Accuracy:     0.8520
  Test Error:        0.1480
  AUC Score:         0.4961

================================================================================
All Random Forest models trained successfully!
================================================================================

Results:
  Training Accuracy: 0.9980
  Training Error:    0.0020
  Test Accuracy:     0.8520
  Test Error:        0.1480
  AUC Score:         0.4961

================================================================================
All Random Forest models trained successfully!
================================================================================</code></pre>
</div>
</div>
<div id="fc160abd" class="cell" data-execution_count="26">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare Random Forest models</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>comparison_df <span class="op">=</span> pd.DataFrame({</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Model'</span>: <span class="bu">list</span>(rf_results.keys()),</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">'m_value'</span>: [m_values[k] <span class="cf">for</span> k <span class="kw">in</span> rf_results.keys()],</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Train_Accuracy'</span>: [rf_results[k][<span class="st">'train_accuracy'</span>] <span class="cf">for</span> k <span class="kw">in</span> rf_results.keys()],</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Test_Accuracy'</span>: [rf_results[k][<span class="st">'test_accuracy'</span>] <span class="cf">for</span> k <span class="kw">in</span> rf_results.keys()],</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Train_Error'</span>: [rf_results[k][<span class="st">'train_error'</span>] <span class="cf">for</span> k <span class="kw">in</span> rf_results.keys()],</span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Test_Error'</span>: [rf_results[k][<span class="st">'test_error'</span>] <span class="cf">for</span> k <span class="kw">in</span> rf_results.keys()],</span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">'AUC'</span>: [rf_results[k][<span class="st">'auc'</span>] <span class="cf">for</span> k <span class="kw">in</span> rf_results.keys()]</span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"RANDOM FOREST MODEL COMPARISON"</span>)</span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(comparison_df.to_string(index<span class="op">=</span><span class="va">False</span>))</span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Find best model</span></span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true" tabindex="-1"></a>best_model_name <span class="op">=</span> comparison_df.loc[comparison_df[<span class="st">'Test_Error'</span>].idxmin(), <span class="st">'Model'</span>]</span>
<span id="cb39-19"><a href="#cb39-19" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">80</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb39-20"><a href="#cb39-20" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Best Random Forest Model: </span><span class="sc">{</span>best_model_name<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb39-21"><a href="#cb39-21" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Test Error: </span><span class="sc">{</span>rf_results[best_model_name][<span class="st">'test_error'</span>]<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb39-22"><a href="#cb39-22" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Test Accuracy: </span><span class="sc">{</span>rf_results[best_model_name][<span class="st">'test_accuracy'</span>]<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb39-23"><a href="#cb39-23" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  AUC: </span><span class="sc">{</span>rf_results[best_model_name][<span class="st">'auc'</span>]<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb39-24"><a href="#cb39-24" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">80</span><span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>================================================================================
RANDOM FOREST MODEL COMPARISON
================================================================================
          Model  m_value  Train_Accuracy  Test_Accuracy  Train_Error  Test_Error      AUC
    m = sqrt(p)        5        0.984000          0.852     0.016000       0.148 0.480197
        m = p/2       15        0.996375          0.852     0.003625       0.148 0.487691
m = p (Bagging)       30        0.998000          0.852     0.002000       0.148 0.496142

================================================================================
Best Random Forest Model: m = sqrt(p)
  Test Error: 0.1480
  Test Accuracy: 0.8520
  AUC: 0.4802
================================================================================</code></pre>
</div>
</div>
<div id="6b6f6700" class="cell" data-execution_count="27">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Feature Importance - Random Forest Models Comparison</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"FEATURE IMPORTANCE COMPARISON ACROSS RANDOM FOREST MODELS"</span>)</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Get feature importance from all Random Forest models</span></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>model_names <span class="op">=</span> <span class="bu">list</span>(rf_results.keys())</span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>n_models <span class="op">=</span> <span class="bu">len</span>(model_names)</span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Create subplot layout: 1x3 for 3 models</span></span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">3</span>, figsize<span class="op">=</span>(<span class="dv">20</span>, <span class="dv">6</span>))</span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a>fig.suptitle(<span class="st">'Random Forest: Feature Importance Comparison for Different m Values'</span>, </span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a>             fontsize<span class="op">=</span><span class="dv">16</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>, y<span class="op">=</span><span class="fl">1.02</span>)</span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a>colors <span class="op">=</span> [<span class="st">'steelblue'</span>, <span class="st">'forestgreen'</span>, <span class="st">'coral'</span>]</span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-17"><a href="#cb41-17" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> idx, name <span class="kw">in</span> <span class="bu">enumerate</span>(model_names):</span>
<span id="cb41-18"><a href="#cb41-18" aria-hidden="true" tabindex="-1"></a>    ax <span class="op">=</span> axes[idx]</span>
<span id="cb41-19"><a href="#cb41-19" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> rf_results[name][<span class="st">'model'</span>]</span>
<span id="cb41-20"><a href="#cb41-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb41-21"><a href="#cb41-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get feature importance</span></span>
<span id="cb41-22"><a href="#cb41-22" aria-hidden="true" tabindex="-1"></a>    importance_df <span class="op">=</span> pd.DataFrame({</span>
<span id="cb41-23"><a href="#cb41-23" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Feature'</span>: X_train.columns,</span>
<span id="cb41-24"><a href="#cb41-24" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Importance'</span>: model.feature_importances_</span>
<span id="cb41-25"><a href="#cb41-25" aria-hidden="true" tabindex="-1"></a>    }).sort_values(<span class="st">'Importance'</span>, ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb41-26"><a href="#cb41-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb41-27"><a href="#cb41-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot top 15 features</span></span>
<span id="cb41-28"><a href="#cb41-28" aria-hidden="true" tabindex="-1"></a>    top_15 <span class="op">=</span> importance_df.head(<span class="dv">15</span>)</span>
<span id="cb41-29"><a href="#cb41-29" aria-hidden="true" tabindex="-1"></a>    ax.barh(<span class="bu">range</span>(<span class="bu">len</span>(top_15)), top_15[<span class="st">'Importance'</span>], color<span class="op">=</span>colors[idx], alpha<span class="op">=</span><span class="fl">0.8</span>)</span>
<span id="cb41-30"><a href="#cb41-30" aria-hidden="true" tabindex="-1"></a>    ax.set_yticks(<span class="bu">range</span>(<span class="bu">len</span>(top_15)))</span>
<span id="cb41-31"><a href="#cb41-31" aria-hidden="true" tabindex="-1"></a>    ax.set_yticklabels(top_15[<span class="st">'Feature'</span>], fontsize<span class="op">=</span><span class="dv">9</span>)</span>
<span id="cb41-32"><a href="#cb41-32" aria-hidden="true" tabindex="-1"></a>    ax.set_xlabel(<span class="st">'Importance'</span>, fontsize<span class="op">=</span><span class="dv">11</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb41-33"><a href="#cb41-33" aria-hidden="true" tabindex="-1"></a>    ax.set_title(<span class="ss">f'</span><span class="sc">{</span>name<span class="sc">}</span><span class="ch">\n</span><span class="ss">Top 15 Features'</span>, fontsize<span class="op">=</span><span class="dv">12</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb41-34"><a href="#cb41-34" aria-hidden="true" tabindex="-1"></a>    ax.invert_yaxis()</span>
<span id="cb41-35"><a href="#cb41-35" aria-hidden="true" tabindex="-1"></a>    ax.grid(axis<span class="op">=</span><span class="st">'x'</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb41-36"><a href="#cb41-36" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb41-37"><a href="#cb41-37" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Print top 5 for this model</span></span>
<span id="cb41-38"><a href="#cb41-38" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss"> - Top 5 Features:"</span>)</span>
<span id="cb41-39"><a href="#cb41-39" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">80</span>)</span>
<span id="cb41-40"><a href="#cb41-40" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(importance_df.head(<span class="dv">5</span>).to_string(index<span class="op">=</span><span class="va">False</span>))</span>
<span id="cb41-41"><a href="#cb41-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-42"><a href="#cb41-42" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb41-43"><a href="#cb41-43" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>================================================================================
FEATURE IMPORTANCE COMPARISON ACROSS RANDOM FOREST MODELS
================================================================================

m = sqrt(p) - Top 5 Features:
--------------------------------------------------------------------------------
          Feature  Importance
             city    0.060539
std_watch_minutes    0.059590
     avg_progress    0.059368
     std_progress    0.059150
    monthly_spend    0.056804

m = p/2 - Top 5 Features:
--------------------------------------------------------------------------------
          Feature  Importance
             city    0.066276
     std_progress    0.065256
     avg_progress    0.064785
std_watch_minutes    0.062280
    monthly_spend    0.059587

m = p (Bagging) - Top 5 Features:
--------------------------------------------------------------------------------
          Feature  Importance
             city    0.068734
     std_progress    0.066866
     avg_progress    0.066196
std_watch_minutes    0.063178
    monthly_spend    0.063152</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="random_forest_files/figure-html/cell-23-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="c497b12d" class="cell" data-execution_count="28">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize Random Forest comparison - Confusion Matrices for all m values</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>model_names <span class="op">=</span> <span class="bu">list</span>(rf_results.keys())</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>n_models <span class="op">=</span> <span class="bu">len</span>(model_names)</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">3</span>, figsize<span class="op">=</span>(<span class="dv">18</span>, <span class="dv">5</span>))</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>fig.suptitle(<span class="st">'Random Forest: Confusion Matrices for Different m Values'</span>, </span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>             fontsize<span class="op">=</span><span class="dv">16</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>, y<span class="op">=</span><span class="fl">1.02</span>)</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>colors_maps <span class="op">=</span> [<span class="st">'Blues'</span>, <span class="st">'Greens'</span>, <span class="st">'Oranges'</span>]</span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> idx, name <span class="kw">in</span> <span class="bu">enumerate</span>(model_names):</span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a>    ax <span class="op">=</span> axes[idx]</span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a>    cm <span class="op">=</span> rf_results[name][<span class="st">'confusion_matrix'</span>]</span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create heatmap</span></span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a>    sns.heatmap(cm, annot<span class="op">=</span><span class="va">True</span>, fmt<span class="op">=</span><span class="st">'d'</span>, cmap<span class="op">=</span>colors_maps[idx], ax<span class="op">=</span>ax, </span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a>                cbar<span class="op">=</span><span class="va">False</span>, annot_kws<span class="op">=</span>{<span class="st">'fontsize'</span>: <span class="dv">14</span>, <span class="st">'fontweight'</span>: <span class="st">'bold'</span>})</span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Labels and title</span></span>
<span id="cb43-20"><a href="#cb43-20" aria-hidden="true" tabindex="-1"></a>    ax.set_xlabel(<span class="st">'Predicted'</span>, fontsize<span class="op">=</span><span class="dv">12</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb43-21"><a href="#cb43-21" aria-hidden="true" tabindex="-1"></a>    ax.set_ylabel(<span class="st">'Actual'</span>, fontsize<span class="op">=</span><span class="dv">12</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb43-22"><a href="#cb43-22" aria-hidden="true" tabindex="-1"></a>    ax.set_title(<span class="ss">f'</span><span class="sc">{</span>name<span class="sc">}</span><span class="ch">\n</span><span class="ss">Test Error: </span><span class="sc">{</span>rf_results[name][<span class="st">"test_error"</span>]<span class="sc">:.4f}</span><span class="ss"> | AUC: </span><span class="sc">{</span>rf_results[name][<span class="st">"auc"</span>]<span class="sc">:.4f}</span><span class="ss">'</span>, </span>
<span id="cb43-23"><a href="#cb43-23" aria-hidden="true" tabindex="-1"></a>                fontsize<span class="op">=</span><span class="dv">12</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>, pad<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb43-24"><a href="#cb43-24" aria-hidden="true" tabindex="-1"></a>    ax.set_xticklabels([<span class="st">'Inactive'</span>, <span class="st">'Active'</span>], fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb43-25"><a href="#cb43-25" aria-hidden="true" tabindex="-1"></a>    ax.set_yticklabels([<span class="st">'Inactive'</span>, <span class="st">'Active'</span>], fontsize<span class="op">=</span><span class="dv">11</span>, rotation<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb43-26"><a href="#cb43-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb43-27"><a href="#cb43-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate and display accuracy metrics</span></span>
<span id="cb43-28"><a href="#cb43-28" aria-hidden="true" tabindex="-1"></a>    tn, fp, fn, tp <span class="op">=</span> cm.ravel()</span>
<span id="cb43-29"><a href="#cb43-29" aria-hidden="true" tabindex="-1"></a>    accuracy <span class="op">=</span> (tp <span class="op">+</span> tn) <span class="op">/</span> (tp <span class="op">+</span> tn <span class="op">+</span> fp <span class="op">+</span> fn)</span>
<span id="cb43-30"><a href="#cb43-30" aria-hidden="true" tabindex="-1"></a>    precision <span class="op">=</span> tp <span class="op">/</span> (tp <span class="op">+</span> fp) <span class="cf">if</span> (tp <span class="op">+</span> fp) <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb43-31"><a href="#cb43-31" aria-hidden="true" tabindex="-1"></a>    recall <span class="op">=</span> tp <span class="op">/</span> (tp <span class="op">+</span> fn) <span class="cf">if</span> (tp <span class="op">+</span> fn) <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb43-32"><a href="#cb43-32" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb43-33"><a href="#cb43-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add text box with metrics</span></span>
<span id="cb43-34"><a href="#cb43-34" aria-hidden="true" tabindex="-1"></a>    textstr <span class="op">=</span> <span class="ss">f'Accuracy: </span><span class="sc">{</span>accuracy<span class="sc">:.4f}</span><span class="ch">\n</span><span class="ss">Precision: </span><span class="sc">{</span>precision<span class="sc">:.4f}</span><span class="ch">\n</span><span class="ss">Recall: </span><span class="sc">{</span>recall<span class="sc">:.4f}</span><span class="ss">'</span></span>
<span id="cb43-35"><a href="#cb43-35" aria-hidden="true" tabindex="-1"></a>    props <span class="op">=</span> <span class="bu">dict</span>(boxstyle<span class="op">=</span><span class="st">'round'</span>, facecolor<span class="op">=</span><span class="st">'white'</span>, alpha<span class="op">=</span><span class="fl">0.8</span>, edgecolor<span class="op">=</span><span class="st">'gray'</span>)</span>
<span id="cb43-36"><a href="#cb43-36" aria-hidden="true" tabindex="-1"></a>    ax.text(<span class="fl">0.02</span>, <span class="fl">0.98</span>, textstr, transform<span class="op">=</span>ax.transAxes, fontsize<span class="op">=</span><span class="dv">9</span>,</span>
<span id="cb43-37"><a href="#cb43-37" aria-hidden="true" tabindex="-1"></a>            verticalalignment<span class="op">=</span><span class="st">'top'</span>, bbox<span class="op">=</span>props)</span>
<span id="cb43-38"><a href="#cb43-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-39"><a href="#cb43-39" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb43-40"><a href="#cb43-40" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="random_forest_files/figure-html/cell-24-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<pre><code>&lt;Figure size 640x480 with 0 Axes&gt;</code></pre>
</div>
</div>
<div id="96806f34" class="cell" data-execution_count="29">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co"># test for different number of trees</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Test Classification Error vs Number of Trees</span></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"RANDOM FOREST: TEST ERROR vs NUMBER OF TREES"</span>)</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Train models with increasing number of trees to track error progression</span></span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>n_tree_values <span class="op">=</span> [<span class="dv">10</span>, <span class="dv">25</span>, <span class="dv">50</span>, <span class="dv">100</span>, <span class="dv">150</span>, <span class="dv">200</span>, <span class="dv">250</span>, <span class="dv">300</span>, <span class="dv">350</span>, <span class="dv">400</span>, <span class="dv">450</span>, <span class="dv">500</span>]</span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>error_progression <span class="op">=</span> {name: [] <span class="cf">for</span> name <span class="kw">in</span> m_values.keys()}</span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Training Random Forest models with varying tree counts..."</span>)</span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"This may take a moment...</span><span class="ch">\n</span><span class="st">"</span>)</span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> n_trees <span class="kw">in</span> n_tree_values:</span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Training with </span><span class="sc">{</span>n_trees<span class="sc">}</span><span class="ss"> trees..."</span>, end<span class="op">=</span><span class="st">' '</span>)</span>
<span id="cb45-16"><a href="#cb45-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> name, m_val <span class="kw">in</span> m_values.items():</span>
<span id="cb45-17"><a href="#cb45-17" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Train model with current number of trees</span></span>
<span id="cb45-18"><a href="#cb45-18" aria-hidden="true" tabindex="-1"></a>        rf_temp <span class="op">=</span> RandomForestClassifier(</span>
<span id="cb45-19"><a href="#cb45-19" aria-hidden="true" tabindex="-1"></a>            n_estimators<span class="op">=</span>n_trees,</span>
<span id="cb45-20"><a href="#cb45-20" aria-hidden="true" tabindex="-1"></a>            max_features<span class="op">=</span>m_val,</span>
<span id="cb45-21"><a href="#cb45-21" aria-hidden="true" tabindex="-1"></a>            random_state<span class="op">=</span><span class="dv">42</span>,</span>
<span id="cb45-22"><a href="#cb45-22" aria-hidden="true" tabindex="-1"></a>            n_jobs<span class="op">=-</span><span class="dv">1</span>,</span>
<span id="cb45-23"><a href="#cb45-23" aria-hidden="true" tabindex="-1"></a>            min_samples_split<span class="op">=</span><span class="dv">5</span>,</span>
<span id="cb45-24"><a href="#cb45-24" aria-hidden="true" tabindex="-1"></a>            min_samples_leaf<span class="op">=</span><span class="dv">2</span></span>
<span id="cb45-25"><a href="#cb45-25" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb45-26"><a href="#cb45-26" aria-hidden="true" tabindex="-1"></a>        rf_temp.fit(X_train, y_train)</span>
<span id="cb45-27"><a href="#cb45-27" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb45-28"><a href="#cb45-28" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate test error</span></span>
<span id="cb45-29"><a href="#cb45-29" aria-hidden="true" tabindex="-1"></a>        y_pred_temp <span class="op">=</span> rf_temp.predict(X_test)</span>
<span id="cb45-30"><a href="#cb45-30" aria-hidden="true" tabindex="-1"></a>        test_error <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> accuracy_score(y_test, y_pred_temp)</span>
<span id="cb45-31"><a href="#cb45-31" aria-hidden="true" tabindex="-1"></a>        error_progression[name].append(test_error)</span>
<span id="cb45-32"><a href="#cb45-32" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">""</span>)</span>
<span id="cb45-33"><a href="#cb45-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-34"><a href="#cb45-34" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Training complete!"</span>)</span>
<span id="cb45-35"><a href="#cb45-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-36"><a href="#cb45-36" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize error progression</span></span>
<span id="cb45-37"><a href="#cb45-37" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>, figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">7</span>))</span>
<span id="cb45-38"><a href="#cb45-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-39"><a href="#cb45-39" aria-hidden="true" tabindex="-1"></a>colors_line <span class="op">=</span> [<span class="st">'#ff6b6b'</span>, <span class="st">'#4ecdc4'</span>, <span class="st">'#45b7d1'</span>]</span>
<span id="cb45-40"><a href="#cb45-40" aria-hidden="true" tabindex="-1"></a>markers <span class="op">=</span> [<span class="st">'o'</span>, <span class="st">'s'</span>, <span class="st">'D'</span>]</span>
<span id="cb45-41"><a href="#cb45-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-42"><a href="#cb45-42" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> idx, (name, errors) <span class="kw">in</span> <span class="bu">enumerate</span>(error_progression.items()):</span>
<span id="cb45-43"><a href="#cb45-43" aria-hidden="true" tabindex="-1"></a>    ax.plot(n_tree_values, errors, </span>
<span id="cb45-44"><a href="#cb45-44" aria-hidden="true" tabindex="-1"></a>            marker<span class="op">=</span>markers[idx], </span>
<span id="cb45-45"><a href="#cb45-45" aria-hidden="true" tabindex="-1"></a>            linewidth<span class="op">=</span><span class="fl">2.5</span>, </span>
<span id="cb45-46"><a href="#cb45-46" aria-hidden="true" tabindex="-1"></a>            markersize<span class="op">=</span><span class="dv">8</span>,</span>
<span id="cb45-47"><a href="#cb45-47" aria-hidden="true" tabindex="-1"></a>            label<span class="op">=</span>name, </span>
<span id="cb45-48"><a href="#cb45-48" aria-hidden="true" tabindex="-1"></a>            color<span class="op">=</span>colors_line[idx],</span>
<span id="cb45-49"><a href="#cb45-49" aria-hidden="true" tabindex="-1"></a>            alpha<span class="op">=</span><span class="fl">0.8</span>)</span>
<span id="cb45-50"><a href="#cb45-50" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb45-51"><a href="#cb45-51" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Annotate final error value</span></span>
<span id="cb45-52"><a href="#cb45-52" aria-hidden="true" tabindex="-1"></a>    final_error <span class="op">=</span> errors[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb45-53"><a href="#cb45-53" aria-hidden="true" tabindex="-1"></a>    ax.annotate(<span class="ss">f'</span><span class="sc">{</span>final_error<span class="sc">:.4f}</span><span class="ss">'</span>, </span>
<span id="cb45-54"><a href="#cb45-54" aria-hidden="true" tabindex="-1"></a>                xy<span class="op">=</span>(n_tree_values[<span class="op">-</span><span class="dv">1</span>], final_error),</span>
<span id="cb45-55"><a href="#cb45-55" aria-hidden="true" tabindex="-1"></a>                xytext<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">0</span>), </span>
<span id="cb45-56"><a href="#cb45-56" aria-hidden="true" tabindex="-1"></a>                textcoords<span class="op">=</span><span class="st">'offset points'</span>,</span>
<span id="cb45-57"><a href="#cb45-57" aria-hidden="true" tabindex="-1"></a>                fontsize<span class="op">=</span><span class="dv">9</span>,</span>
<span id="cb45-58"><a href="#cb45-58" aria-hidden="true" tabindex="-1"></a>                fontweight<span class="op">=</span><span class="st">'bold'</span>,</span>
<span id="cb45-59"><a href="#cb45-59" aria-hidden="true" tabindex="-1"></a>                color<span class="op">=</span>colors_line[idx])</span>
<span id="cb45-60"><a href="#cb45-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-61"><a href="#cb45-61" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">'Number of Trees'</span>, fontsize<span class="op">=</span><span class="dv">13</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb45-62"><a href="#cb45-62" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">'Test Classification Error'</span>, fontsize<span class="op">=</span><span class="dv">13</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb45-63"><a href="#cb45-63" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">'Random Forest: Test Error vs Number of Trees</span><span class="ch">\n</span><span class="st">for Different m Values'</span>, </span>
<span id="cb45-64"><a href="#cb45-64" aria-hidden="true" tabindex="-1"></a>             fontsize<span class="op">=</span><span class="dv">15</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>, pad<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb45-65"><a href="#cb45-65" aria-hidden="true" tabindex="-1"></a>ax.legend(fontsize<span class="op">=</span><span class="dv">11</span>, loc<span class="op">=</span><span class="st">'upper right'</span>, framealpha<span class="op">=</span><span class="fl">0.9</span>)</span>
<span id="cb45-66"><a href="#cb45-66" aria-hidden="true" tabindex="-1"></a>ax.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>, linestyle<span class="op">=</span><span class="st">'--'</span>)</span>
<span id="cb45-67"><a href="#cb45-67" aria-hidden="true" tabindex="-1"></a>ax.set_xlim([<span class="dv">0</span>, <span class="dv">520</span>])</span>
<span id="cb45-68"><a href="#cb45-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-69"><a href="#cb45-69" aria-hidden="true" tabindex="-1"></a><span class="co"># Add horizontal line at each model's final error</span></span>
<span id="cb45-70"><a href="#cb45-70" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> idx, (name, errors) <span class="kw">in</span> <span class="bu">enumerate</span>(error_progression.items()):</span>
<span id="cb45-71"><a href="#cb45-71" aria-hidden="true" tabindex="-1"></a>    ax.axhline(y<span class="op">=</span>errors[<span class="op">-</span><span class="dv">1</span>], color<span class="op">=</span>colors_line[idx], linestyle<span class="op">=</span><span class="st">':'</span>, alpha<span class="op">=</span><span class="fl">0.3</span>, linewidth<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb45-72"><a href="#cb45-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-73"><a href="#cb45-73" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb45-74"><a href="#cb45-74" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb45-75"><a href="#cb45-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-76"><a href="#cb45-76" aria-hidden="true" tabindex="-1"></a><span class="co"># Print summary table</span></span>
<span id="cb45-77"><a href="#cb45-77" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb45-78"><a href="#cb45-78" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"TEST ERROR PROGRESSION SUMMARY"</span>)</span>
<span id="cb45-79"><a href="#cb45-79" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb45-80"><a href="#cb45-80" aria-hidden="true" tabindex="-1"></a>summary_data <span class="op">=</span> []</span>
<span id="cb45-81"><a href="#cb45-81" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name, errors <span class="kw">in</span> error_progression.items():</span>
<span id="cb45-82"><a href="#cb45-82" aria-hidden="true" tabindex="-1"></a>    summary_data.append({</span>
<span id="cb45-83"><a href="#cb45-83" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Model'</span>: name,</span>
<span id="cb45-84"><a href="#cb45-84" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Error @10 trees'</span>: <span class="ss">f'</span><span class="sc">{</span>errors[<span class="dv">0</span>]<span class="sc">:.4f}</span><span class="ss">'</span>,</span>
<span id="cb45-85"><a href="#cb45-85" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Error @100 trees'</span>: <span class="ss">f'</span><span class="sc">{</span>errors[<span class="dv">3</span>]<span class="sc">:.4f}</span><span class="ss">'</span>,</span>
<span id="cb45-86"><a href="#cb45-86" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Error @500 trees'</span>: <span class="ss">f'</span><span class="sc">{</span>errors[<span class="op">-</span><span class="dv">1</span>]<span class="sc">:.4f}</span><span class="ss">'</span>,</span>
<span id="cb45-87"><a href="#cb45-87" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Improvement'</span>: <span class="ss">f'</span><span class="sc">{</span>(errors[<span class="dv">0</span>] <span class="op">-</span> errors[<span class="op">-</span><span class="dv">1</span>])<span class="op">*</span><span class="dv">100</span><span class="sc">:.2f}</span><span class="ss">%'</span></span>
<span id="cb45-88"><a href="#cb45-88" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb45-89"><a href="#cb45-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-90"><a href="#cb45-90" aria-hidden="true" tabindex="-1"></a>summary_df <span class="op">=</span> pd.DataFrame(summary_data)</span>
<span id="cb45-91"><a href="#cb45-91" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(summary_df.to_string(index<span class="op">=</span><span class="va">False</span>))</span>
<span id="cb45-92"><a href="#cb45-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-93"><a href="#cb45-93" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb45-94"><a href="#cb45-94" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"KEY OBSERVATIONS:"</span>)</span>
<span id="cb45-95"><a href="#cb45-95" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb45-96"><a href="#cb45-96" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"- Error decreases as number of trees increases (diminishing returns)"</span>)</span>
<span id="cb45-97"><a href="#cb45-97" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"- Most improvement occurs in first 100-200 trees"</span>)</span>
<span id="cb45-98"><a href="#cb45-98" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"- All models stabilize around 300-400 trees"</span>)</span>
<span id="cb45-99"><a href="#cb45-99" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"- Different m values show different convergence patterns"</span>)</span>
<span id="cb45-100"><a href="#cb45-100" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>================================================================================
RANDOM FOREST: TEST ERROR vs NUMBER OF TREES
================================================================================

Training Random Forest models with varying tree counts...
This may take a moment...

Training with 10 trees... 
Training with 25 trees... 
Training with 25 trees... 
Training with 50 trees... 
Training with 50 trees... 
Training with 100 trees... 
Training with 100 trees... 
Training with 150 trees... 
Training with 150 trees... 
Training with 200 trees... 
Training with 200 trees... 
Training with 250 trees... 
Training with 250 trees... 
Training with 300 trees... 
Training with 300 trees... 
Training with 350 trees... 
Training with 350 trees... 
Training with 400 trees... 
Training with 400 trees... 
Training with 450 trees... 
Training with 450 trees... 
Training with 500 trees... 
Training with 500 trees... 

Training complete!


Training complete!</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="random_forest_files/figure-html/cell-25-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
================================================================================
TEST ERROR PROGRESSION SUMMARY
================================================================================
          Model Error @10 trees Error @100 trees Error @500 trees Improvement
    m = sqrt(p)          0.1520           0.1480           0.1480       0.40%
        m = p/2          0.1520           0.1480           0.1480       0.40%
m = p (Bagging)          0.1565           0.1480           0.1480       0.85%

================================================================================
KEY OBSERVATIONS:
================================================================================
- Error decreases as number of trees increases (diminishing returns)
- Most improvement occurs in first 100-200 trees
- All models stabilize around 300-400 trees
- Different m values show different convergence patterns
================================================================================</code></pre>
</div>
</div>
</section>
<section id="gradient-boosting-with-different-tree-depths" class="level2">
<h2 class="anchored" data-anchor-id="gradient-boosting-with-different-tree-depths">6. Gradient Boosting with Different Tree Depths</h2>
<div id="a1b33458" class="cell" data-execution_count="32">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Train Gradient Boosting models with different max_depth values</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Focusing on depths 1, 2</span></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>depths <span class="op">=</span> [<span class="dv">1</span>, <span class="dv">2</span>]</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>gb_results <span class="op">=</span> {}</span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"TRAINING GRADIENT BOOSTING MODELS WITH DIFFERENT DEPTHS"</span>)</span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> depth <span class="kw">in</span> depths:</span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">80</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Training Gradient Boosting with max_depth = </span><span class="sc">{</span>depth<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">80</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb48-15"><a href="#cb48-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Train Gradient Boosting</span></span>
<span id="cb48-16"><a href="#cb48-16" aria-hidden="true" tabindex="-1"></a>    gb_model <span class="op">=</span> GradientBoostingClassifier(</span>
<span id="cb48-17"><a href="#cb48-17" aria-hidden="true" tabindex="-1"></a>        n_estimators<span class="op">=</span><span class="dv">500</span>,</span>
<span id="cb48-18"><a href="#cb48-18" aria-hidden="true" tabindex="-1"></a>        max_depth<span class="op">=</span>depth,</span>
<span id="cb48-19"><a href="#cb48-19" aria-hidden="true" tabindex="-1"></a>        learning_rate<span class="op">=</span><span class="fl">0.1</span>,</span>
<span id="cb48-20"><a href="#cb48-20" aria-hidden="true" tabindex="-1"></a>        random_state<span class="op">=</span><span class="dv">42</span>,</span>
<span id="cb48-21"><a href="#cb48-21" aria-hidden="true" tabindex="-1"></a>        subsample<span class="op">=</span><span class="fl">0.8</span>,</span>
<span id="cb48-22"><a href="#cb48-22" aria-hidden="true" tabindex="-1"></a>        min_samples_split<span class="op">=</span><span class="dv">5</span>,</span>
<span id="cb48-23"><a href="#cb48-23" aria-hidden="true" tabindex="-1"></a>        min_samples_leaf<span class="op">=</span><span class="dv">2</span></span>
<span id="cb48-24"><a href="#cb48-24" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb48-25"><a href="#cb48-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb48-26"><a href="#cb48-26" aria-hidden="true" tabindex="-1"></a>    gb_model.fit(X_train, y_train)</span>
<span id="cb48-27"><a href="#cb48-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb48-28"><a href="#cb48-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Predictions</span></span>
<span id="cb48-29"><a href="#cb48-29" aria-hidden="true" tabindex="-1"></a>    y_train_pred <span class="op">=</span> gb_model.predict(X_train)</span>
<span id="cb48-30"><a href="#cb48-30" aria-hidden="true" tabindex="-1"></a>    y_test_pred <span class="op">=</span> gb_model.predict(X_test)</span>
<span id="cb48-31"><a href="#cb48-31" aria-hidden="true" tabindex="-1"></a>    y_test_proba <span class="op">=</span> gb_model.predict_proba(X_test)[:, <span class="dv">1</span>]</span>
<span id="cb48-32"><a href="#cb48-32" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb48-33"><a href="#cb48-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate metrics</span></span>
<span id="cb48-34"><a href="#cb48-34" aria-hidden="true" tabindex="-1"></a>    train_accuracy <span class="op">=</span> accuracy_score(y_train, y_train_pred)</span>
<span id="cb48-35"><a href="#cb48-35" aria-hidden="true" tabindex="-1"></a>    test_accuracy <span class="op">=</span> accuracy_score(y_test, y_test_pred)</span>
<span id="cb48-36"><a href="#cb48-36" aria-hidden="true" tabindex="-1"></a>    train_error <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> train_accuracy</span>
<span id="cb48-37"><a href="#cb48-37" aria-hidden="true" tabindex="-1"></a>    test_error <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> test_accuracy</span>
<span id="cb48-38"><a href="#cb48-38" aria-hidden="true" tabindex="-1"></a>    auc_score <span class="op">=</span> roc_auc_score(y_test, y_test_proba)</span>
<span id="cb48-39"><a href="#cb48-39" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb48-40"><a href="#cb48-40" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Store results</span></span>
<span id="cb48-41"><a href="#cb48-41" aria-hidden="true" tabindex="-1"></a>    gb_results[depth] <span class="op">=</span> {</span>
<span id="cb48-42"><a href="#cb48-42" aria-hidden="true" tabindex="-1"></a>        <span class="st">'model'</span>: gb_model,</span>
<span id="cb48-43"><a href="#cb48-43" aria-hidden="true" tabindex="-1"></a>        <span class="st">'train_accuracy'</span>: train_accuracy,</span>
<span id="cb48-44"><a href="#cb48-44" aria-hidden="true" tabindex="-1"></a>        <span class="st">'test_accuracy'</span>: test_accuracy,</span>
<span id="cb48-45"><a href="#cb48-45" aria-hidden="true" tabindex="-1"></a>        <span class="st">'train_error'</span>: train_error,</span>
<span id="cb48-46"><a href="#cb48-46" aria-hidden="true" tabindex="-1"></a>        <span class="st">'test_error'</span>: test_error,</span>
<span id="cb48-47"><a href="#cb48-47" aria-hidden="true" tabindex="-1"></a>        <span class="st">'auc'</span>: auc_score,</span>
<span id="cb48-48"><a href="#cb48-48" aria-hidden="true" tabindex="-1"></a>        <span class="st">'predictions'</span>: y_test_pred,</span>
<span id="cb48-49"><a href="#cb48-49" aria-hidden="true" tabindex="-1"></a>        <span class="st">'probabilities'</span>: y_test_proba,</span>
<span id="cb48-50"><a href="#cb48-50" aria-hidden="true" tabindex="-1"></a>        <span class="st">'confusion_matrix'</span>: confusion_matrix(y_test, y_test_pred)</span>
<span id="cb48-51"><a href="#cb48-51" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb48-52"><a href="#cb48-52" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb48-53"><a href="#cb48-53" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Results:"</span>)</span>
<span id="cb48-54"><a href="#cb48-54" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Training Accuracy: </span><span class="sc">{</span>train_accuracy<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb48-55"><a href="#cb48-55" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Training Error:    </span><span class="sc">{</span>train_error<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb48-56"><a href="#cb48-56" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Test Accuracy:     </span><span class="sc">{</span>test_accuracy<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb48-57"><a href="#cb48-57" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Test Error:        </span><span class="sc">{</span>test_error<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb48-58"><a href="#cb48-58" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  AUC Score:         </span><span class="sc">{</span>auc_score<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb48-59"><a href="#cb48-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-60"><a href="#cb48-60" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">80</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb48-61"><a href="#cb48-61" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"All Gradient Boosting models trained successfully!"</span>)</span>
<span id="cb48-62"><a href="#cb48-62" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">80</span><span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>================================================================================
TRAINING GRADIENT BOOSTING MODELS WITH DIFFERENT DEPTHS
================================================================================

================================================================================
Training Gradient Boosting with max_depth = 1
================================================================================

Results:
  Training Accuracy: 0.8524
  Training Error:    0.1476
  Test Accuracy:     0.8520
  Test Error:        0.1480
  AUC Score:         0.4885

================================================================================
Training Gradient Boosting with max_depth = 2
================================================================================

Results:
  Training Accuracy: 0.8524
  Training Error:    0.1476
  Test Accuracy:     0.8520
  Test Error:        0.1480
  AUC Score:         0.4885

================================================================================
Training Gradient Boosting with max_depth = 2
================================================================================

Results:
  Training Accuracy: 0.8578
  Training Error:    0.1422
  Test Accuracy:     0.8495
  Test Error:        0.1505
  AUC Score:         0.4708

================================================================================
All Gradient Boosting models trained successfully!
================================================================================

Results:
  Training Accuracy: 0.8578
  Training Error:    0.1422
  Test Accuracy:     0.8495
  Test Error:        0.1505
  AUC Score:         0.4708

================================================================================
All Gradient Boosting models trained successfully!
================================================================================</code></pre>
</div>
</div>
<div id="9c69c664" class="cell" data-execution_count="33">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare Gradient Boosting models</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>gb_comparison_df <span class="op">=</span> pd.DataFrame({</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Max_Depth'</span>: <span class="bu">list</span>(gb_results.keys()),</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Train_Accuracy'</span>: [gb_results[k][<span class="st">'train_accuracy'</span>] <span class="cf">for</span> k <span class="kw">in</span> gb_results.keys()],</span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Test_Accuracy'</span>: [gb_results[k][<span class="st">'test_accuracy'</span>] <span class="cf">for</span> k <span class="kw">in</span> gb_results.keys()],</span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Train_Error'</span>: [gb_results[k][<span class="st">'train_error'</span>] <span class="cf">for</span> k <span class="kw">in</span> gb_results.keys()],</span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Test_Error'</span>: [gb_results[k][<span class="st">'test_error'</span>] <span class="cf">for</span> k <span class="kw">in</span> gb_results.keys()],</span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">'AUC'</span>: [gb_results[k][<span class="st">'auc'</span>] <span class="cf">for</span> k <span class="kw">in</span> gb_results.keys()]</span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"GRADIENT BOOSTING MODEL COMPARISON"</span>)</span>
<span id="cb50-13"><a href="#cb50-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb50-14"><a href="#cb50-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(gb_comparison_df.to_string(index<span class="op">=</span><span class="va">False</span>))</span>
<span id="cb50-15"><a href="#cb50-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-16"><a href="#cb50-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Find best model</span></span>
<span id="cb50-17"><a href="#cb50-17" aria-hidden="true" tabindex="-1"></a>best_depth <span class="op">=</span> gb_comparison_df.loc[gb_comparison_df[<span class="st">'Test_Error'</span>].idxmin(), <span class="st">'Max_Depth'</span>]</span>
<span id="cb50-18"><a href="#cb50-18" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">80</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb50-19"><a href="#cb50-19" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Best Gradient Boosting Model: max_depth = </span><span class="sc">{</span>best_depth<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb50-20"><a href="#cb50-20" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Test Error: </span><span class="sc">{</span>gb_results[best_depth][<span class="st">'test_error'</span>]<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb50-21"><a href="#cb50-21" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Test Accuracy: </span><span class="sc">{</span>gb_results[best_depth][<span class="st">'test_accuracy'</span>]<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb50-22"><a href="#cb50-22" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  AUC: </span><span class="sc">{</span>gb_results[best_depth][<span class="st">'auc'</span>]<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb50-23"><a href="#cb50-23" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">80</span><span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>================================================================================
GRADIENT BOOSTING MODEL COMPARISON
================================================================================
 Max_Depth  Train_Accuracy  Test_Accuracy  Train_Error  Test_Error      AUC
         1        0.852375         0.8520     0.147625      0.1480 0.488527
         2        0.857750         0.8495     0.142250      0.1505 0.470818

================================================================================
Best Gradient Boosting Model: max_depth = 1
  Test Error: 0.1480
  Test Accuracy: 0.8520
  AUC: 0.4885
================================================================================</code></pre>
</div>
</div>
<div id="6d51a09e" class="cell" data-execution_count="42">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize Gradient Boosting comparison</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">15</span>, <span class="dv">6</span>))</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Confusion Matrix for Depth = 1</span></span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> axes[<span class="dv">0</span>]</span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>cm <span class="op">=</span> gb_results[<span class="dv">1</span>][<span class="st">'confusion_matrix'</span>]</span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>sns.heatmap(cm, annot<span class="op">=</span><span class="va">True</span>, fmt<span class="op">=</span><span class="st">'d'</span>, cmap<span class="op">=</span><span class="st">'Blues'</span>, ax<span class="op">=</span>ax, cbar<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a>            annot_kws<span class="op">=</span>{<span class="st">'fontsize'</span>: <span class="dv">14</span>, <span class="st">'fontweight'</span>: <span class="st">'bold'</span>})</span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">'Predicted'</span>, fontsize<span class="op">=</span><span class="dv">12</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">'Actual'</span>, fontsize<span class="op">=</span><span class="dv">12</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="ss">f'Confusion Matrix: Depth = 1 (Stumps)</span><span class="ch">\n</span><span class="ss">Test Error: </span><span class="sc">{</span>gb_results[<span class="dv">1</span>][<span class="st">"test_error"</span>]<span class="sc">:.4f}</span><span class="ss">'</span>, </span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a>             fontsize<span class="op">=</span><span class="dv">14</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb52-13"><a href="#cb52-13" aria-hidden="true" tabindex="-1"></a>ax.set_xticklabels([<span class="st">'Inactive'</span>, <span class="st">'Active'</span>], fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb52-14"><a href="#cb52-14" aria-hidden="true" tabindex="-1"></a>ax.set_yticklabels([<span class="st">'Inactive'</span>, <span class="st">'Active'</span>], fontsize<span class="op">=</span><span class="dv">11</span>, rotation<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb52-15"><a href="#cb52-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-16"><a href="#cb52-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Confusion Matrix for Depth = 2</span></span>
<span id="cb52-17"><a href="#cb52-17" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> axes[<span class="dv">1</span>]</span>
<span id="cb52-18"><a href="#cb52-18" aria-hidden="true" tabindex="-1"></a>cm <span class="op">=</span> gb_results[<span class="dv">2</span>][<span class="st">'confusion_matrix'</span>]</span>
<span id="cb52-19"><a href="#cb52-19" aria-hidden="true" tabindex="-1"></a>sns.heatmap(cm, annot<span class="op">=</span><span class="va">True</span>, fmt<span class="op">=</span><span class="st">'d'</span>, cmap<span class="op">=</span><span class="st">'Greens'</span>, ax<span class="op">=</span>ax, cbar<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb52-20"><a href="#cb52-20" aria-hidden="true" tabindex="-1"></a>            annot_kws<span class="op">=</span>{<span class="st">'fontsize'</span>: <span class="dv">14</span>, <span class="st">'fontweight'</span>: <span class="st">'bold'</span>})</span>
<span id="cb52-21"><a href="#cb52-21" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">'Predicted'</span>, fontsize<span class="op">=</span><span class="dv">12</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb52-22"><a href="#cb52-22" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">'Actual'</span>, fontsize<span class="op">=</span><span class="dv">12</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb52-23"><a href="#cb52-23" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="ss">f'Confusion Matrix: Depth = 2</span><span class="ch">\n</span><span class="ss">Test Error: </span><span class="sc">{</span>gb_results[<span class="dv">2</span>][<span class="st">"test_error"</span>]<span class="sc">:.4f}</span><span class="ss">'</span>, </span>
<span id="cb52-24"><a href="#cb52-24" aria-hidden="true" tabindex="-1"></a>             fontsize<span class="op">=</span><span class="dv">14</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb52-25"><a href="#cb52-25" aria-hidden="true" tabindex="-1"></a>ax.set_xticklabels([<span class="st">'Inactive'</span>, <span class="st">'Active'</span>], fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb52-26"><a href="#cb52-26" aria-hidden="true" tabindex="-1"></a>ax.set_yticklabels([<span class="st">'Inactive'</span>, <span class="st">'Active'</span>], fontsize<span class="op">=</span><span class="dv">11</span>, rotation<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb52-27"><a href="#cb52-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-28"><a href="#cb52-28" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb52-29"><a href="#cb52-29" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="random_forest_files/figure-html/cell-28-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<section id="gradient-boosting-with-different-shrinkage-factors-learning-rates" class="level3">
<h3 class="anchored" data-anchor-id="gradient-boosting-with-different-shrinkage-factors-learning-rates">Gradient Boosting with Different Shrinkage Factors (Learning Rates)</h3>
<p>Now lets explore the effect of different shrinkage factors on Gradient Boosting performance. Well use depth=2 (a good baseline) and vary the learning rate.</p>
<div id="73764101" class="cell" data-execution_count="45">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Train Gradient Boosting with different shrinkage factors (learning rates)</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>learning_rates <span class="op">=</span> [<span class="fl">0.01</span>, <span class="fl">0.05</span>, <span class="fl">0.1</span>]</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>gb_shrinkage_results <span class="op">=</span> {}</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"GRADIENT BOOSTING WITH DIFFERENT SHRINKAGE FACTORS"</span>)</span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Using max_depth=2, varying learning rate"</span>)</span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> lr <span class="kw">in</span> learning_rates:</span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">80</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Training Gradient Boosting with learning_rate = </span><span class="sc">{</span>lr<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb53-13"><a href="#cb53-13" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">80</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb53-14"><a href="#cb53-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb53-15"><a href="#cb53-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Train Gradient Boosting , depth = 1</span></span>
<span id="cb53-16"><a href="#cb53-16" aria-hidden="true" tabindex="-1"></a>    gb_model <span class="op">=</span> GradientBoostingClassifier(</span>
<span id="cb53-17"><a href="#cb53-17" aria-hidden="true" tabindex="-1"></a>        n_estimators<span class="op">=</span><span class="dv">500</span>,</span>
<span id="cb53-18"><a href="#cb53-18" aria-hidden="true" tabindex="-1"></a>        max_depth<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb53-19"><a href="#cb53-19" aria-hidden="true" tabindex="-1"></a>        learning_rate<span class="op">=</span>lr,</span>
<span id="cb53-20"><a href="#cb53-20" aria-hidden="true" tabindex="-1"></a>        random_state<span class="op">=</span><span class="dv">42</span>,</span>
<span id="cb53-21"><a href="#cb53-21" aria-hidden="true" tabindex="-1"></a>        subsample<span class="op">=</span><span class="fl">0.8</span>,</span>
<span id="cb53-22"><a href="#cb53-22" aria-hidden="true" tabindex="-1"></a>        min_samples_split<span class="op">=</span><span class="dv">5</span>,</span>
<span id="cb53-23"><a href="#cb53-23" aria-hidden="true" tabindex="-1"></a>        min_samples_leaf<span class="op">=</span><span class="dv">2</span></span>
<span id="cb53-24"><a href="#cb53-24" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb53-25"><a href="#cb53-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb53-26"><a href="#cb53-26" aria-hidden="true" tabindex="-1"></a>    gb_model.fit(X_train, y_train)</span>
<span id="cb53-27"><a href="#cb53-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb53-28"><a href="#cb53-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Predictions</span></span>
<span id="cb53-29"><a href="#cb53-29" aria-hidden="true" tabindex="-1"></a>    y_train_pred <span class="op">=</span> gb_model.predict(X_train)</span>
<span id="cb53-30"><a href="#cb53-30" aria-hidden="true" tabindex="-1"></a>    y_test_pred <span class="op">=</span> gb_model.predict(X_test)</span>
<span id="cb53-31"><a href="#cb53-31" aria-hidden="true" tabindex="-1"></a>    y_test_proba <span class="op">=</span> gb_model.predict_proba(X_test)[:, <span class="dv">1</span>]</span>
<span id="cb53-32"><a href="#cb53-32" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb53-33"><a href="#cb53-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate metrics</span></span>
<span id="cb53-34"><a href="#cb53-34" aria-hidden="true" tabindex="-1"></a>    train_accuracy <span class="op">=</span> accuracy_score(y_train, y_train_pred)</span>
<span id="cb53-35"><a href="#cb53-35" aria-hidden="true" tabindex="-1"></a>    test_accuracy <span class="op">=</span> accuracy_score(y_test, y_test_pred)</span>
<span id="cb53-36"><a href="#cb53-36" aria-hidden="true" tabindex="-1"></a>    train_error <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> train_accuracy</span>
<span id="cb53-37"><a href="#cb53-37" aria-hidden="true" tabindex="-1"></a>    test_error <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> test_accuracy</span>
<span id="cb53-38"><a href="#cb53-38" aria-hidden="true" tabindex="-1"></a>    auc_score <span class="op">=</span> roc_auc_score(y_test, y_test_proba)</span>
<span id="cb53-39"><a href="#cb53-39" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb53-40"><a href="#cb53-40" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Store results</span></span>
<span id="cb53-41"><a href="#cb53-41" aria-hidden="true" tabindex="-1"></a>    gb_shrinkage_results[lr] <span class="op">=</span> {</span>
<span id="cb53-42"><a href="#cb53-42" aria-hidden="true" tabindex="-1"></a>        <span class="st">'model'</span>: gb_model,</span>
<span id="cb53-43"><a href="#cb53-43" aria-hidden="true" tabindex="-1"></a>        <span class="st">'train_accuracy'</span>: train_accuracy,</span>
<span id="cb53-44"><a href="#cb53-44" aria-hidden="true" tabindex="-1"></a>        <span class="st">'test_accuracy'</span>: test_accuracy,</span>
<span id="cb53-45"><a href="#cb53-45" aria-hidden="true" tabindex="-1"></a>        <span class="st">'train_error'</span>: train_error,</span>
<span id="cb53-46"><a href="#cb53-46" aria-hidden="true" tabindex="-1"></a>        <span class="st">'test_error'</span>: test_error,</span>
<span id="cb53-47"><a href="#cb53-47" aria-hidden="true" tabindex="-1"></a>        <span class="st">'auc'</span>: auc_score,</span>
<span id="cb53-48"><a href="#cb53-48" aria-hidden="true" tabindex="-1"></a>        <span class="st">'predictions'</span>: y_test_pred,</span>
<span id="cb53-49"><a href="#cb53-49" aria-hidden="true" tabindex="-1"></a>        <span class="st">'probabilities'</span>: y_test_proba,</span>
<span id="cb53-50"><a href="#cb53-50" aria-hidden="true" tabindex="-1"></a>        <span class="st">'confusion_matrix'</span>: confusion_matrix(y_test, y_test_pred)</span>
<span id="cb53-51"><a href="#cb53-51" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb53-52"><a href="#cb53-52" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb53-53"><a href="#cb53-53" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Results:"</span>)</span>
<span id="cb53-54"><a href="#cb53-54" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Training Accuracy: </span><span class="sc">{</span>train_accuracy<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb53-55"><a href="#cb53-55" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Training Error:    </span><span class="sc">{</span>train_error<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb53-56"><a href="#cb53-56" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Test Accuracy:     </span><span class="sc">{</span>test_accuracy<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb53-57"><a href="#cb53-57" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Test Error:        </span><span class="sc">{</span>test_error<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb53-58"><a href="#cb53-58" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  AUC Score:         </span><span class="sc">{</span>auc_score<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb53-59"><a href="#cb53-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-60"><a href="#cb53-60" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">80</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb53-61"><a href="#cb53-61" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"All shrinkage factor models trained successfully!"</span>)</span>
<span id="cb53-62"><a href="#cb53-62" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">80</span><span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>================================================================================
GRADIENT BOOSTING WITH DIFFERENT SHRINKAGE FACTORS
Using max_depth=2, varying learning rate
================================================================================

================================================================================
Training Gradient Boosting with learning_rate = 0.01
================================================================================

Results:
  Training Accuracy: 0.8519
  Training Error:    0.1481
  Test Accuracy:     0.8520
  Test Error:        0.1480
  AUC Score:         0.4871

================================================================================
Training Gradient Boosting with learning_rate = 0.05
================================================================================

Results:
  Training Accuracy: 0.8519
  Training Error:    0.1481
  Test Accuracy:     0.8520
  Test Error:        0.1480
  AUC Score:         0.4871

================================================================================
Training Gradient Boosting with learning_rate = 0.05
================================================================================

Results:
  Training Accuracy: 0.8518
  Training Error:    0.1482
  Test Accuracy:     0.8520
  Test Error:        0.1480
  AUC Score:         0.4846

================================================================================
Training Gradient Boosting with learning_rate = 0.1
================================================================================

Results:
  Training Accuracy: 0.8518
  Training Error:    0.1482
  Test Accuracy:     0.8520
  Test Error:        0.1480
  AUC Score:         0.4846

================================================================================
Training Gradient Boosting with learning_rate = 0.1
================================================================================

Results:
  Training Accuracy: 0.8524
  Training Error:    0.1476
  Test Accuracy:     0.8520
  Test Error:        0.1480
  AUC Score:         0.4885

================================================================================
All shrinkage factor models trained successfully!
================================================================================

Results:
  Training Accuracy: 0.8524
  Training Error:    0.1476
  Test Accuracy:     0.8520
  Test Error:        0.1480
  AUC Score:         0.4885

================================================================================
All shrinkage factor models trained successfully!
================================================================================</code></pre>
</div>
</div>
<div id="eabb5f53" class="cell" data-execution_count="46">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare shrinkage factor models</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>shrinkage_df <span class="op">=</span> pd.DataFrame({</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Learning_Rate'</span>: <span class="bu">list</span>(gb_shrinkage_results.keys()),</span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Train_Accuracy'</span>: [gb_shrinkage_results[k][<span class="st">'train_accuracy'</span>] <span class="cf">for</span> k <span class="kw">in</span> gb_shrinkage_results.keys()],</span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Test_Accuracy'</span>: [gb_shrinkage_results[k][<span class="st">'test_accuracy'</span>] <span class="cf">for</span> k <span class="kw">in</span> gb_shrinkage_results.keys()],</span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Train_Error'</span>: [gb_shrinkage_results[k][<span class="st">'train_error'</span>] <span class="cf">for</span> k <span class="kw">in</span> gb_shrinkage_results.keys()],</span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Test_Error'</span>: [gb_shrinkage_results[k][<span class="st">'test_error'</span>] <span class="cf">for</span> k <span class="kw">in</span> gb_shrinkage_results.keys()],</span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">'AUC'</span>: [gb_shrinkage_results[k][<span class="st">'auc'</span>] <span class="cf">for</span> k <span class="kw">in</span> gb_shrinkage_results.keys()]</span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-11"><a href="#cb55-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb55-12"><a href="#cb55-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"GRADIENT BOOSTING: SHRINKAGE FACTOR COMPARISON"</span>)</span>
<span id="cb55-13"><a href="#cb55-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb55-14"><a href="#cb55-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(shrinkage_df.to_string(index<span class="op">=</span><span class="va">False</span>))</span>
<span id="cb55-15"><a href="#cb55-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-16"><a href="#cb55-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Find best learning rate</span></span>
<span id="cb55-17"><a href="#cb55-17" aria-hidden="true" tabindex="-1"></a>best_lr <span class="op">=</span> shrinkage_df.loc[shrinkage_df[<span class="st">'Test_Error'</span>].idxmin(), <span class="st">'Learning_Rate'</span>]</span>
<span id="cb55-18"><a href="#cb55-18" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">80</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb55-19"><a href="#cb55-19" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Best Learning Rate: </span><span class="sc">{</span>best_lr<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb55-20"><a href="#cb55-20" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Test Error: </span><span class="sc">{</span>gb_shrinkage_results[best_lr][<span class="st">'test_error'</span>]<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb55-21"><a href="#cb55-21" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Test Accuracy: </span><span class="sc">{</span>gb_shrinkage_results[best_lr][<span class="st">'test_accuracy'</span>]<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb55-22"><a href="#cb55-22" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  AUC: </span><span class="sc">{</span>gb_shrinkage_results[best_lr][<span class="st">'auc'</span>]<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb55-23"><a href="#cb55-23" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">80</span><span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>================================================================================
GRADIENT BOOSTING: SHRINKAGE FACTOR COMPARISON
================================================================================
 Learning_Rate  Train_Accuracy  Test_Accuracy  Train_Error  Test_Error      AUC
          0.01        0.851875          0.852     0.148125       0.148 0.487091
          0.05        0.851750          0.852     0.148250       0.148 0.484587
          0.10        0.852375          0.852     0.147625       0.148 0.488527

================================================================================
Best Learning Rate: 0.01
  Test Error: 0.1480
  Test Accuracy: 0.8520
  AUC: 0.4871
================================================================================</code></pre>
</div>
</div>
<div id="b882d7f8" class="cell" data-execution_count="48">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize Shrinkage Factor Effect - Confusion Matrices for Different Learning Rates</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>n_rates <span class="op">=</span> <span class="bu">len</span>(learning_rates)</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, n_rates, figsize<span class="op">=</span>(<span class="dv">6</span><span class="op">*</span>n_rates, <span class="dv">5</span>))</span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>fig.suptitle(<span class="st">'Gradient Boosting: Confusion Matrices for Different Learning Rates</span><span class="ch">\n</span><span class="st">(depth=2, 500 trees)'</span>, </span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>             fontsize<span class="op">=</span><span class="dv">16</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>, y<span class="op">=</span><span class="fl">1.02</span>)</span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>colors_maps <span class="op">=</span> [<span class="st">'Blues'</span>, <span class="st">'Greens'</span>, <span class="st">'Oranges'</span>]</span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> idx, lr <span class="kw">in</span> <span class="bu">enumerate</span>(learning_rates):</span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a>    ax <span class="op">=</span> axes[idx]</span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a>    cm <span class="op">=</span> gb_shrinkage_results[lr][<span class="st">'confusion_matrix'</span>]</span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb57-13"><a href="#cb57-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create heatmap</span></span>
<span id="cb57-14"><a href="#cb57-14" aria-hidden="true" tabindex="-1"></a>    sns.heatmap(cm, annot<span class="op">=</span><span class="va">True</span>, fmt<span class="op">=</span><span class="st">'d'</span>, cmap<span class="op">=</span>colors_maps[idx], ax<span class="op">=</span>ax, cbar<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb57-15"><a href="#cb57-15" aria-hidden="true" tabindex="-1"></a>                annot_kws<span class="op">=</span>{<span class="st">'fontsize'</span>: <span class="dv">14</span>, <span class="st">'fontweight'</span>: <span class="st">'bold'</span>})</span>
<span id="cb57-16"><a href="#cb57-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb57-17"><a href="#cb57-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Labels and title</span></span>
<span id="cb57-18"><a href="#cb57-18" aria-hidden="true" tabindex="-1"></a>    ax.set_xlabel(<span class="st">'Predicted'</span>, fontsize<span class="op">=</span><span class="dv">12</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb57-19"><a href="#cb57-19" aria-hidden="true" tabindex="-1"></a>    ax.set_ylabel(<span class="st">'Actual'</span>, fontsize<span class="op">=</span><span class="dv">12</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb57-20"><a href="#cb57-20" aria-hidden="true" tabindex="-1"></a>    ax.set_title(<span class="ss">f'Learning Rate = </span><span class="sc">{</span>lr<span class="sc">}</span><span class="ch">\n</span><span class="ss">Test Error: </span><span class="sc">{</span>gb_shrinkage_results[lr][<span class="st">"test_error"</span>]<span class="sc">:.4f}</span><span class="ss"> | AUC: </span><span class="sc">{</span>gb_shrinkage_results[lr][<span class="st">"auc"</span>]<span class="sc">:.4f}</span><span class="ss">'</span>, </span>
<span id="cb57-21"><a href="#cb57-21" aria-hidden="true" tabindex="-1"></a>                fontsize<span class="op">=</span><span class="dv">13</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>, pad<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb57-22"><a href="#cb57-22" aria-hidden="true" tabindex="-1"></a>    ax.set_xticklabels([<span class="st">'Inactive'</span>, <span class="st">'Active'</span>], fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb57-23"><a href="#cb57-23" aria-hidden="true" tabindex="-1"></a>    ax.set_yticklabels([<span class="st">'Inactive'</span>, <span class="st">'Active'</span>], fontsize<span class="op">=</span><span class="dv">11</span>, rotation<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb57-24"><a href="#cb57-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb57-25"><a href="#cb57-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate and display accuracy metrics</span></span>
<span id="cb57-26"><a href="#cb57-26" aria-hidden="true" tabindex="-1"></a>    tn, fp, fn, tp <span class="op">=</span> cm.ravel()</span>
<span id="cb57-27"><a href="#cb57-27" aria-hidden="true" tabindex="-1"></a>    accuracy <span class="op">=</span> (tp <span class="op">+</span> tn) <span class="op">/</span> (tp <span class="op">+</span> tn <span class="op">+</span> fp <span class="op">+</span> fn)</span>
<span id="cb57-28"><a href="#cb57-28" aria-hidden="true" tabindex="-1"></a>    precision <span class="op">=</span> tp <span class="op">/</span> (tp <span class="op">+</span> fp) <span class="cf">if</span> (tp <span class="op">+</span> fp) <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb57-29"><a href="#cb57-29" aria-hidden="true" tabindex="-1"></a>    recall <span class="op">=</span> tp <span class="op">/</span> (tp <span class="op">+</span> fn) <span class="cf">if</span> (tp <span class="op">+</span> fn) <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb57-30"><a href="#cb57-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb57-31"><a href="#cb57-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add text box with metrics</span></span>
<span id="cb57-32"><a href="#cb57-32" aria-hidden="true" tabindex="-1"></a>    textstr <span class="op">=</span> <span class="ss">f'Accuracy: </span><span class="sc">{</span>accuracy<span class="sc">:.4f}</span><span class="ch">\n</span><span class="ss">Precision: </span><span class="sc">{</span>precision<span class="sc">:.4f}</span><span class="ch">\n</span><span class="ss">Recall: </span><span class="sc">{</span>recall<span class="sc">:.4f}</span><span class="ss">'</span></span>
<span id="cb57-33"><a href="#cb57-33" aria-hidden="true" tabindex="-1"></a>    props <span class="op">=</span> <span class="bu">dict</span>(boxstyle<span class="op">=</span><span class="st">'round'</span>, facecolor<span class="op">=</span><span class="st">'white'</span>, alpha<span class="op">=</span><span class="fl">0.8</span>, edgecolor<span class="op">=</span><span class="st">'gray'</span>)</span>
<span id="cb57-34"><a href="#cb57-34" aria-hidden="true" tabindex="-1"></a>    ax.text(<span class="fl">0.02</span>, <span class="fl">0.98</span>, textstr, transform<span class="op">=</span>ax.transAxes, fontsize<span class="op">=</span><span class="dv">9</span>,</span>
<span id="cb57-35"><a href="#cb57-35" aria-hidden="true" tabindex="-1"></a>            verticalalignment<span class="op">=</span><span class="st">'top'</span>, bbox<span class="op">=</span>props)</span>
<span id="cb57-36"><a href="#cb57-36" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb57-37"><a href="#cb57-37" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Highlight best model</span></span>
<span id="cb57-38"><a href="#cb57-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> lr <span class="op">==</span> best_lr:</span>
<span id="cb57-39"><a href="#cb57-39" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> spine <span class="kw">in</span> ax.spines.values():</span>
<span id="cb57-40"><a href="#cb57-40" aria-hidden="true" tabindex="-1"></a>            spine.set_edgecolor(<span class="st">'gold'</span>)</span>
<span id="cb57-41"><a href="#cb57-41" aria-hidden="true" tabindex="-1"></a>            spine.set_linewidth(<span class="dv">3</span>)</span>
<span id="cb57-42"><a href="#cb57-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-43"><a href="#cb57-43" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb57-44"><a href="#cb57-44" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb57-45"><a href="#cb57-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-46"><a href="#cb57-46" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb57-47"><a href="#cb57-47" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"SHRINKAGE FACTOR ANALYSIS SUMMARY"</span>)</span>
<span id="cb57-48"><a href="#cb57-48" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb57-49"><a href="#cb57-49" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Best Learning Rate: </span><span class="sc">{</span>best_lr<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb57-50"><a href="#cb57-50" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  - Lower learning rates (e.g., 0.01) require more trees but may generalize better"</span>)</span>
<span id="cb57-51"><a href="#cb57-51" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  - Higher learning rates (e.g., 0.1+) converge faster but may overfit"</span>)</span>
<span id="cb57-52"><a href="#cb57-52" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  - The optimal learning rate balances convergence speed and model performance"</span>)</span>
<span id="cb57-53"><a href="#cb57-53" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="random_forest_files/figure-html/cell-31-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
================================================================================
SHRINKAGE FACTOR ANALYSIS SUMMARY
================================================================================
Best Learning Rate: 0.01
  - Lower learning rates (e.g., 0.01) require more trees but may generalize better
  - Higher learning rates (e.g., 0.1+) converge faster but may overfit
  - The optimal learning rate balances convergence speed and model performance
================================================================================</code></pre>
</div>
</div>
</section>
<section id="test-error-vs-number-of-trees-comparison" class="level3">
<h3 class="anchored" data-anchor-id="test-error-vs-number-of-trees-comparison">Test Error vs Number of Trees Comparison</h3>
<p>Compare how test classification error changes with the number of trees for different models: - <strong>GB depth=1, lr=0.1</strong> - <strong>GB depth=2, lr=0.1</strong> - <strong>GB depth=1, lr=0.01</strong> - <strong>GB depth=1, lr=0.05</strong> - <strong>RF m=sqrt(p)=5</strong></p>
<div id="8cb0e7f3" class="cell" data-execution_count="50">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Train models with varying number of trees for comparison</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>n_trees_list <span class="op">=</span> [<span class="dv">10</span>, <span class="dv">25</span>, <span class="dv">50</span>, <span class="dv">100</span>, <span class="dv">150</span>, <span class="dv">200</span>, <span class="dv">250</span>, <span class="dv">300</span>, <span class="dv">350</span>, <span class="dv">400</span>, <span class="dv">450</span>, <span class="dv">500</span>]</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>error_comparison <span class="op">=</span> {}</span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"TRAINING MODELS WITH VARYING NUMBER OF TREES"</span>)</span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Random Forest m = sqrt(p) = 5</span></span>
<span id="cb59-10"><a href="#cb59-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb59-11"><a href="#cb59-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Training Random Forest (m = sqrt(p) = 5) with varying trees..."</span>)</span>
<span id="cb59-12"><a href="#cb59-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb59-13"><a href="#cb59-13" aria-hidden="true" tabindex="-1"></a>rf_errors <span class="op">=</span> []</span>
<span id="cb59-14"><a href="#cb59-14" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> n_trees <span class="kw">in</span> n_trees_list:</span>
<span id="cb59-15"><a href="#cb59-15" aria-hidden="true" tabindex="-1"></a>    rf_temp <span class="op">=</span> RandomForestClassifier(</span>
<span id="cb59-16"><a href="#cb59-16" aria-hidden="true" tabindex="-1"></a>        n_estimators<span class="op">=</span>n_trees,</span>
<span id="cb59-17"><a href="#cb59-17" aria-hidden="true" tabindex="-1"></a>        max_features<span class="op">=</span><span class="bu">int</span>(np.sqrt(n_features)),</span>
<span id="cb59-18"><a href="#cb59-18" aria-hidden="true" tabindex="-1"></a>        random_state<span class="op">=</span><span class="dv">42</span>,</span>
<span id="cb59-19"><a href="#cb59-19" aria-hidden="true" tabindex="-1"></a>        n_jobs<span class="op">=-</span><span class="dv">1</span>,</span>
<span id="cb59-20"><a href="#cb59-20" aria-hidden="true" tabindex="-1"></a>        min_samples_split<span class="op">=</span><span class="dv">5</span>,</span>
<span id="cb59-21"><a href="#cb59-21" aria-hidden="true" tabindex="-1"></a>        min_samples_leaf<span class="op">=</span><span class="dv">2</span></span>
<span id="cb59-22"><a href="#cb59-22" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb59-23"><a href="#cb59-23" aria-hidden="true" tabindex="-1"></a>    rf_temp.fit(X_train, y_train)</span>
<span id="cb59-24"><a href="#cb59-24" aria-hidden="true" tabindex="-1"></a>    y_pred <span class="op">=</span> rf_temp.predict(X_test)</span>
<span id="cb59-25"><a href="#cb59-25" aria-hidden="true" tabindex="-1"></a>    test_error <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> accuracy_score(y_test, y_pred)</span>
<span id="cb59-26"><a href="#cb59-26" aria-hidden="true" tabindex="-1"></a>    rf_errors.append(test_error)</span>
<span id="cb59-27"><a href="#cb59-27" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Trees: </span><span class="sc">{</span>n_trees<span class="sc">:3d}</span><span class="ss"> | Test Error: </span><span class="sc">{</span>test_error<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb59-28"><a href="#cb59-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-29"><a href="#cb59-29" aria-hidden="true" tabindex="-1"></a>error_comparison[<span class="st">'RF m=sqrt(p)=5'</span>] <span class="op">=</span> rf_errors</span>
<span id="cb59-30"><a href="#cb59-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-31"><a href="#cb59-31" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. GB depth=1, lr=0.1</span></span>
<span id="cb59-32"><a href="#cb59-32" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb59-33"><a href="#cb59-33" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Training GB (depth=1, lr=0.1) with varying trees..."</span>)</span>
<span id="cb59-34"><a href="#cb59-34" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb59-35"><a href="#cb59-35" aria-hidden="true" tabindex="-1"></a>gb_d1_lr01_errors <span class="op">=</span> []</span>
<span id="cb59-36"><a href="#cb59-36" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> n_trees <span class="kw">in</span> n_trees_list:</span>
<span id="cb59-37"><a href="#cb59-37" aria-hidden="true" tabindex="-1"></a>    gb_temp <span class="op">=</span> GradientBoostingClassifier(</span>
<span id="cb59-38"><a href="#cb59-38" aria-hidden="true" tabindex="-1"></a>        n_estimators<span class="op">=</span>n_trees,</span>
<span id="cb59-39"><a href="#cb59-39" aria-hidden="true" tabindex="-1"></a>        max_depth<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb59-40"><a href="#cb59-40" aria-hidden="true" tabindex="-1"></a>        learning_rate<span class="op">=</span><span class="fl">0.1</span>,</span>
<span id="cb59-41"><a href="#cb59-41" aria-hidden="true" tabindex="-1"></a>        random_state<span class="op">=</span><span class="dv">42</span>,</span>
<span id="cb59-42"><a href="#cb59-42" aria-hidden="true" tabindex="-1"></a>        subsample<span class="op">=</span><span class="fl">0.8</span>,</span>
<span id="cb59-43"><a href="#cb59-43" aria-hidden="true" tabindex="-1"></a>        min_samples_split<span class="op">=</span><span class="dv">5</span>,</span>
<span id="cb59-44"><a href="#cb59-44" aria-hidden="true" tabindex="-1"></a>        min_samples_leaf<span class="op">=</span><span class="dv">2</span></span>
<span id="cb59-45"><a href="#cb59-45" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb59-46"><a href="#cb59-46" aria-hidden="true" tabindex="-1"></a>    gb_temp.fit(X_train, y_train)</span>
<span id="cb59-47"><a href="#cb59-47" aria-hidden="true" tabindex="-1"></a>    y_pred <span class="op">=</span> gb_temp.predict(X_test)</span>
<span id="cb59-48"><a href="#cb59-48" aria-hidden="true" tabindex="-1"></a>    test_error <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> accuracy_score(y_test, y_pred)</span>
<span id="cb59-49"><a href="#cb59-49" aria-hidden="true" tabindex="-1"></a>    gb_d1_lr01_errors.append(test_error)</span>
<span id="cb59-50"><a href="#cb59-50" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Trees: </span><span class="sc">{</span>n_trees<span class="sc">:3d}</span><span class="ss"> | Test Error: </span><span class="sc">{</span>test_error<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb59-51"><a href="#cb59-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-52"><a href="#cb59-52" aria-hidden="true" tabindex="-1"></a>error_comparison[<span class="st">'GB depth=1, lr=0.1'</span>] <span class="op">=</span> gb_d1_lr01_errors</span>
<span id="cb59-53"><a href="#cb59-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-54"><a href="#cb59-54" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. GB depth=2, lr=0.1</span></span>
<span id="cb59-55"><a href="#cb59-55" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb59-56"><a href="#cb59-56" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Training GB (depth=2, lr=0.1) with varying trees..."</span>)</span>
<span id="cb59-57"><a href="#cb59-57" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb59-58"><a href="#cb59-58" aria-hidden="true" tabindex="-1"></a>gb_d2_lr01_errors <span class="op">=</span> []</span>
<span id="cb59-59"><a href="#cb59-59" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> n_trees <span class="kw">in</span> n_trees_list:</span>
<span id="cb59-60"><a href="#cb59-60" aria-hidden="true" tabindex="-1"></a>    gb_temp <span class="op">=</span> GradientBoostingClassifier(</span>
<span id="cb59-61"><a href="#cb59-61" aria-hidden="true" tabindex="-1"></a>        n_estimators<span class="op">=</span>n_trees,</span>
<span id="cb59-62"><a href="#cb59-62" aria-hidden="true" tabindex="-1"></a>        max_depth<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb59-63"><a href="#cb59-63" aria-hidden="true" tabindex="-1"></a>        learning_rate<span class="op">=</span><span class="fl">0.1</span>,</span>
<span id="cb59-64"><a href="#cb59-64" aria-hidden="true" tabindex="-1"></a>        random_state<span class="op">=</span><span class="dv">42</span>,</span>
<span id="cb59-65"><a href="#cb59-65" aria-hidden="true" tabindex="-1"></a>        subsample<span class="op">=</span><span class="fl">0.8</span>,</span>
<span id="cb59-66"><a href="#cb59-66" aria-hidden="true" tabindex="-1"></a>        min_samples_split<span class="op">=</span><span class="dv">5</span>,</span>
<span id="cb59-67"><a href="#cb59-67" aria-hidden="true" tabindex="-1"></a>        min_samples_leaf<span class="op">=</span><span class="dv">2</span></span>
<span id="cb59-68"><a href="#cb59-68" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb59-69"><a href="#cb59-69" aria-hidden="true" tabindex="-1"></a>    gb_temp.fit(X_train, y_train)</span>
<span id="cb59-70"><a href="#cb59-70" aria-hidden="true" tabindex="-1"></a>    y_pred <span class="op">=</span> gb_temp.predict(X_test)</span>
<span id="cb59-71"><a href="#cb59-71" aria-hidden="true" tabindex="-1"></a>    test_error <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> accuracy_score(y_test, y_pred)</span>
<span id="cb59-72"><a href="#cb59-72" aria-hidden="true" tabindex="-1"></a>    gb_d2_lr01_errors.append(test_error)</span>
<span id="cb59-73"><a href="#cb59-73" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Trees: </span><span class="sc">{</span>n_trees<span class="sc">:3d}</span><span class="ss"> | Test Error: </span><span class="sc">{</span>test_error<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb59-74"><a href="#cb59-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-75"><a href="#cb59-75" aria-hidden="true" tabindex="-1"></a>error_comparison[<span class="st">'GB depth=2, lr=0.1'</span>] <span class="op">=</span> gb_d2_lr01_errors</span>
<span id="cb59-76"><a href="#cb59-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-77"><a href="#cb59-77" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. GB depth=1, lr=0.01</span></span>
<span id="cb59-78"><a href="#cb59-78" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb59-79"><a href="#cb59-79" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Training GB (depth=1, lr=0.01) with varying trees..."</span>)</span>
<span id="cb59-80"><a href="#cb59-80" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb59-81"><a href="#cb59-81" aria-hidden="true" tabindex="-1"></a>gb_d1_lr001_errors <span class="op">=</span> []</span>
<span id="cb59-82"><a href="#cb59-82" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> n_trees <span class="kw">in</span> n_trees_list:</span>
<span id="cb59-83"><a href="#cb59-83" aria-hidden="true" tabindex="-1"></a>    gb_temp <span class="op">=</span> GradientBoostingClassifier(</span>
<span id="cb59-84"><a href="#cb59-84" aria-hidden="true" tabindex="-1"></a>        n_estimators<span class="op">=</span>n_trees,</span>
<span id="cb59-85"><a href="#cb59-85" aria-hidden="true" tabindex="-1"></a>        max_depth<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb59-86"><a href="#cb59-86" aria-hidden="true" tabindex="-1"></a>        learning_rate<span class="op">=</span><span class="fl">0.01</span>,</span>
<span id="cb59-87"><a href="#cb59-87" aria-hidden="true" tabindex="-1"></a>        random_state<span class="op">=</span><span class="dv">42</span>,</span>
<span id="cb59-88"><a href="#cb59-88" aria-hidden="true" tabindex="-1"></a>        subsample<span class="op">=</span><span class="fl">0.8</span>,</span>
<span id="cb59-89"><a href="#cb59-89" aria-hidden="true" tabindex="-1"></a>        min_samples_split<span class="op">=</span><span class="dv">5</span>,</span>
<span id="cb59-90"><a href="#cb59-90" aria-hidden="true" tabindex="-1"></a>        min_samples_leaf<span class="op">=</span><span class="dv">2</span></span>
<span id="cb59-91"><a href="#cb59-91" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb59-92"><a href="#cb59-92" aria-hidden="true" tabindex="-1"></a>    gb_temp.fit(X_train, y_train)</span>
<span id="cb59-93"><a href="#cb59-93" aria-hidden="true" tabindex="-1"></a>    y_pred <span class="op">=</span> gb_temp.predict(X_test)</span>
<span id="cb59-94"><a href="#cb59-94" aria-hidden="true" tabindex="-1"></a>    test_error <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> accuracy_score(y_test, y_pred)</span>
<span id="cb59-95"><a href="#cb59-95" aria-hidden="true" tabindex="-1"></a>    gb_d1_lr001_errors.append(test_error)</span>
<span id="cb59-96"><a href="#cb59-96" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Trees: </span><span class="sc">{</span>n_trees<span class="sc">:3d}</span><span class="ss"> | Test Error: </span><span class="sc">{</span>test_error<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb59-97"><a href="#cb59-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-98"><a href="#cb59-98" aria-hidden="true" tabindex="-1"></a>error_comparison[<span class="st">'GB depth=1, lr=0.01'</span>] <span class="op">=</span> gb_d1_lr001_errors</span>
<span id="cb59-99"><a href="#cb59-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-100"><a href="#cb59-100" aria-hidden="true" tabindex="-1"></a><span class="co"># 5. GB depth=1, lr=0.05</span></span>
<span id="cb59-101"><a href="#cb59-101" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb59-102"><a href="#cb59-102" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Training GB (depth=1, lr=0.05) with varying trees..."</span>)</span>
<span id="cb59-103"><a href="#cb59-103" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb59-104"><a href="#cb59-104" aria-hidden="true" tabindex="-1"></a>gb_d1_lr005_errors <span class="op">=</span> []</span>
<span id="cb59-105"><a href="#cb59-105" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> n_trees <span class="kw">in</span> n_trees_list:</span>
<span id="cb59-106"><a href="#cb59-106" aria-hidden="true" tabindex="-1"></a>    gb_temp <span class="op">=</span> GradientBoostingClassifier(</span>
<span id="cb59-107"><a href="#cb59-107" aria-hidden="true" tabindex="-1"></a>        n_estimators<span class="op">=</span>n_trees,</span>
<span id="cb59-108"><a href="#cb59-108" aria-hidden="true" tabindex="-1"></a>        max_depth<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb59-109"><a href="#cb59-109" aria-hidden="true" tabindex="-1"></a>        learning_rate<span class="op">=</span><span class="fl">0.05</span>,</span>
<span id="cb59-110"><a href="#cb59-110" aria-hidden="true" tabindex="-1"></a>        random_state<span class="op">=</span><span class="dv">42</span>,</span>
<span id="cb59-111"><a href="#cb59-111" aria-hidden="true" tabindex="-1"></a>        subsample<span class="op">=</span><span class="fl">0.8</span>,</span>
<span id="cb59-112"><a href="#cb59-112" aria-hidden="true" tabindex="-1"></a>        min_samples_split<span class="op">=</span><span class="dv">5</span>,</span>
<span id="cb59-113"><a href="#cb59-113" aria-hidden="true" tabindex="-1"></a>        min_samples_leaf<span class="op">=</span><span class="dv">2</span></span>
<span id="cb59-114"><a href="#cb59-114" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb59-115"><a href="#cb59-115" aria-hidden="true" tabindex="-1"></a>    gb_temp.fit(X_train, y_train)</span>
<span id="cb59-116"><a href="#cb59-116" aria-hidden="true" tabindex="-1"></a>    y_pred <span class="op">=</span> gb_temp.predict(X_test)</span>
<span id="cb59-117"><a href="#cb59-117" aria-hidden="true" tabindex="-1"></a>    test_error <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> accuracy_score(y_test, y_pred)</span>
<span id="cb59-118"><a href="#cb59-118" aria-hidden="true" tabindex="-1"></a>    gb_d1_lr005_errors.append(test_error)</span>
<span id="cb59-119"><a href="#cb59-119" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Trees: </span><span class="sc">{</span>n_trees<span class="sc">:3d}</span><span class="ss"> | Test Error: </span><span class="sc">{</span>test_error<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb59-120"><a href="#cb59-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-121"><a href="#cb59-121" aria-hidden="true" tabindex="-1"></a>error_comparison[<span class="st">'GB depth=1, lr=0.05'</span>] <span class="op">=</span> gb_d1_lr005_errors</span>
<span id="cb59-122"><a href="#cb59-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-123"><a href="#cb59-123" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb59-124"><a href="#cb59-124" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"All models trained successfully!"</span>)</span>
<span id="cb59-125"><a href="#cb59-125" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>================================================================================
TRAINING MODELS WITH VARYING NUMBER OF TREES
================================================================================

================================================================================
Training Random Forest (m = sqrt(p) = 5) with varying trees...
================================================================================
  Trees:  10 | Test Error: 0.1520
  Trees:  25 | Test Error: 0.1480
  Trees:  50 | Test Error: 0.1480
  Trees:  50 | Test Error: 0.1480
  Trees: 100 | Test Error: 0.1480
  Trees: 100 | Test Error: 0.1480
  Trees: 150 | Test Error: 0.1480
  Trees: 150 | Test Error: 0.1480
  Trees: 200 | Test Error: 0.1480
  Trees: 200 | Test Error: 0.1480
  Trees: 250 | Test Error: 0.1480
  Trees: 250 | Test Error: 0.1480
  Trees: 300 | Test Error: 0.1480
  Trees: 300 | Test Error: 0.1480
  Trees: 350 | Test Error: 0.1480
  Trees: 350 | Test Error: 0.1480
  Trees: 400 | Test Error: 0.1480
  Trees: 400 | Test Error: 0.1480
  Trees: 450 | Test Error: 0.1480
  Trees: 450 | Test Error: 0.1480
  Trees: 500 | Test Error: 0.1480

================================================================================
Training GB (depth=1, lr=0.1) with varying trees...
================================================================================
  Trees:  10 | Test Error: 0.1480
  Trees: 500 | Test Error: 0.1480

================================================================================
Training GB (depth=1, lr=0.1) with varying trees...
================================================================================
  Trees:  10 | Test Error: 0.1480
  Trees:  25 | Test Error: 0.1480
  Trees:  25 | Test Error: 0.1480
  Trees:  50 | Test Error: 0.1480
  Trees:  50 | Test Error: 0.1480
  Trees: 100 | Test Error: 0.1480
  Trees: 100 | Test Error: 0.1480
  Trees: 150 | Test Error: 0.1480
  Trees: 150 | Test Error: 0.1480
  Trees: 200 | Test Error: 0.1480
  Trees: 200 | Test Error: 0.1480
  Trees: 250 | Test Error: 0.1480
  Trees: 250 | Test Error: 0.1480
  Trees: 300 | Test Error: 0.1480
  Trees: 300 | Test Error: 0.1480
  Trees: 350 | Test Error: 0.1480
  Trees: 350 | Test Error: 0.1480
  Trees: 400 | Test Error: 0.1480
  Trees: 400 | Test Error: 0.1480
  Trees: 450 | Test Error: 0.1480
  Trees: 450 | Test Error: 0.1480
  Trees: 500 | Test Error: 0.1480

================================================================================
Training GB (depth=2, lr=0.1) with varying trees...
================================================================================
  Trees:  10 | Test Error: 0.1480
  Trees: 500 | Test Error: 0.1480

================================================================================
Training GB (depth=2, lr=0.1) with varying trees...
================================================================================
  Trees:  10 | Test Error: 0.1480
  Trees:  25 | Test Error: 0.1480
  Trees:  25 | Test Error: 0.1480
  Trees:  50 | Test Error: 0.1480
  Trees:  50 | Test Error: 0.1480
  Trees: 100 | Test Error: 0.1475
  Trees: 100 | Test Error: 0.1475
  Trees: 150 | Test Error: 0.1480
  Trees: 150 | Test Error: 0.1480
  Trees: 200 | Test Error: 0.1490
  Trees: 200 | Test Error: 0.1490
  Trees: 250 | Test Error: 0.1480
  Trees: 250 | Test Error: 0.1480
  Trees: 300 | Test Error: 0.1495
  Trees: 300 | Test Error: 0.1495
  Trees: 350 | Test Error: 0.1500
  Trees: 350 | Test Error: 0.1500
  Trees: 400 | Test Error: 0.1500
  Trees: 400 | Test Error: 0.1500
  Trees: 450 | Test Error: 0.1500
  Trees: 450 | Test Error: 0.1500
  Trees: 500 | Test Error: 0.1505

================================================================================
Training GB (depth=1, lr=0.01) with varying trees...
================================================================================
  Trees:  10 | Test Error: 0.1480
  Trees: 500 | Test Error: 0.1505

================================================================================
Training GB (depth=1, lr=0.01) with varying trees...
================================================================================
  Trees:  10 | Test Error: 0.1480
  Trees:  25 | Test Error: 0.1480
  Trees:  25 | Test Error: 0.1480
  Trees:  50 | Test Error: 0.1480
  Trees:  50 | Test Error: 0.1480
  Trees: 100 | Test Error: 0.1480
  Trees: 100 | Test Error: 0.1480
  Trees: 150 | Test Error: 0.1480
  Trees: 150 | Test Error: 0.1480
  Trees: 200 | Test Error: 0.1480
  Trees: 200 | Test Error: 0.1480
  Trees: 250 | Test Error: 0.1480
  Trees: 250 | Test Error: 0.1480
  Trees: 300 | Test Error: 0.1480
  Trees: 300 | Test Error: 0.1480
  Trees: 350 | Test Error: 0.1480
  Trees: 350 | Test Error: 0.1480
  Trees: 400 | Test Error: 0.1480
  Trees: 400 | Test Error: 0.1480
  Trees: 450 | Test Error: 0.1480
  Trees: 450 | Test Error: 0.1480
  Trees: 500 | Test Error: 0.1480

================================================================================
Training GB (depth=1, lr=0.05) with varying trees...
================================================================================
  Trees:  10 | Test Error: 0.1480
  Trees: 500 | Test Error: 0.1480

================================================================================
Training GB (depth=1, lr=0.05) with varying trees...
================================================================================
  Trees:  10 | Test Error: 0.1480
  Trees:  25 | Test Error: 0.1480
  Trees:  25 | Test Error: 0.1480
  Trees:  50 | Test Error: 0.1480
  Trees:  50 | Test Error: 0.1480
  Trees: 100 | Test Error: 0.1480
  Trees: 100 | Test Error: 0.1480
  Trees: 150 | Test Error: 0.1480
  Trees: 150 | Test Error: 0.1480
  Trees: 200 | Test Error: 0.1480
  Trees: 200 | Test Error: 0.1480
  Trees: 250 | Test Error: 0.1480
  Trees: 250 | Test Error: 0.1480
  Trees: 300 | Test Error: 0.1480
  Trees: 300 | Test Error: 0.1480
  Trees: 350 | Test Error: 0.1480
  Trees: 350 | Test Error: 0.1480
  Trees: 400 | Test Error: 0.1480
  Trees: 400 | Test Error: 0.1480
  Trees: 450 | Test Error: 0.1480
  Trees: 450 | Test Error: 0.1480
  Trees: 500 | Test Error: 0.1480

================================================================================
All models trained successfully!
================================================================================
  Trees: 500 | Test Error: 0.1480

================================================================================
All models trained successfully!
================================================================================</code></pre>
</div>
</div>
<div id="a80c985d" class="cell" data-execution_count="51">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot Test Error vs Number of Trees</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="dv">8</span>))</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>colors <span class="op">=</span> [<span class="st">'steelblue'</span>, <span class="st">'coral'</span>, <span class="st">'forestgreen'</span>, <span class="st">'purple'</span>, <span class="st">'orange'</span>]</span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>markers <span class="op">=</span> [<span class="st">'o'</span>, <span class="st">'s'</span>, <span class="st">'^'</span>, <span class="st">'D'</span>, <span class="st">'v'</span>]</span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a>linestyles <span class="op">=</span> [<span class="st">'-'</span>, <span class="st">'-'</span>, <span class="st">'-'</span>, <span class="st">'--'</span>, <span class="st">'--'</span>]</span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> idx, (model_name, errors) <span class="kw">in</span> <span class="bu">enumerate</span>(error_comparison.items()):</span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a>    plt.plot(n_trees_list, errors, </span>
<span id="cb61-10"><a href="#cb61-10" aria-hidden="true" tabindex="-1"></a>             marker<span class="op">=</span>markers[idx], </span>
<span id="cb61-11"><a href="#cb61-11" aria-hidden="true" tabindex="-1"></a>             linewidth<span class="op">=</span><span class="fl">2.5</span>, </span>
<span id="cb61-12"><a href="#cb61-12" aria-hidden="true" tabindex="-1"></a>             markersize<span class="op">=</span><span class="dv">8</span>,</span>
<span id="cb61-13"><a href="#cb61-13" aria-hidden="true" tabindex="-1"></a>             color<span class="op">=</span>colors[idx],</span>
<span id="cb61-14"><a href="#cb61-14" aria-hidden="true" tabindex="-1"></a>             linestyle<span class="op">=</span>linestyles[idx],</span>
<span id="cb61-15"><a href="#cb61-15" aria-hidden="true" tabindex="-1"></a>             label<span class="op">=</span>model_name,</span>
<span id="cb61-16"><a href="#cb61-16" aria-hidden="true" tabindex="-1"></a>             alpha<span class="op">=</span><span class="fl">0.8</span>)</span>
<span id="cb61-17"><a href="#cb61-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-18"><a href="#cb61-18" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Number of Trees'</span>, fontsize<span class="op">=</span><span class="dv">14</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb61-19"><a href="#cb61-19" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Test Classification Error'</span>, fontsize<span class="op">=</span><span class="dv">14</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb61-20"><a href="#cb61-20" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Test Error vs Number of Trees: Model Comparison'</span>, fontsize<span class="op">=</span><span class="dv">16</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb61-21"><a href="#cb61-21" aria-hidden="true" tabindex="-1"></a>plt.legend(fontsize<span class="op">=</span><span class="dv">11</span>, loc<span class="op">=</span><span class="st">'upper right'</span>)</span>
<span id="cb61-22"><a href="#cb61-22" aria-hidden="true" tabindex="-1"></a>plt.grid(alpha<span class="op">=</span><span class="fl">0.3</span>, linestyle<span class="op">=</span><span class="st">'--'</span>)</span>
<span id="cb61-23"><a href="#cb61-23" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb61-24"><a href="#cb61-24" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb61-25"><a href="#cb61-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-26"><a href="#cb61-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Print summary statistics</span></span>
<span id="cb61-27"><a href="#cb61-27" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb61-28"><a href="#cb61-28" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"SUMMARY: Final Test Errors at 500 Trees"</span>)</span>
<span id="cb61-29"><a href="#cb61-29" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb61-30"><a href="#cb61-30" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> model_name, errors <span class="kw">in</span> error_comparison.items():</span>
<span id="cb61-31"><a href="#cb61-31" aria-hidden="true" tabindex="-1"></a>    final_error <span class="op">=</span> errors[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb61-32"><a href="#cb61-32" aria-hidden="true" tabindex="-1"></a>    initial_error <span class="op">=</span> errors[<span class="dv">0</span>]</span>
<span id="cb61-33"><a href="#cb61-33" aria-hidden="true" tabindex="-1"></a>    improvement <span class="op">=</span> (initial_error <span class="op">-</span> final_error) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb61-34"><a href="#cb61-34" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>model_name<span class="sc">:30s}</span><span class="ss"> | Final Error: </span><span class="sc">{</span>final_error<span class="sc">:.4f}</span><span class="ss"> | Improvement: </span><span class="sc">{</span>improvement<span class="sc">:.2f}</span><span class="ss">%"</span>)</span>
<span id="cb61-35"><a href="#cb61-35" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb61-36"><a href="#cb61-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-37"><a href="#cb61-37" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb61-38"><a href="#cb61-38" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"KEY INSIGHTS:"</span>)</span>
<span id="cb61-39"><a href="#cb61-39" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb61-40"><a href="#cb61-40" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"1. Learning Rate Effect (GB depth=1):"</span>)</span>
<span id="cb61-41"><a href="#cb61-41" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"   - lr=0.01: Slowest convergence, may need more trees"</span>)</span>
<span id="cb61-42"><a href="#cb61-42" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"   - lr=0.05: Moderate convergence"</span>)</span>
<span id="cb61-43"><a href="#cb61-43" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"   - lr=0.1:  Fastest convergence"</span>)</span>
<span id="cb61-44"><a href="#cb61-44" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">2. Depth Effect (GB with lr=0.1):"</span>)</span>
<span id="cb61-45"><a href="#cb61-45" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"   - depth=1 (stumps): Simple weak learners"</span>)</span>
<span id="cb61-46"><a href="#cb61-46" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"   - depth=2: Better performance, more complex trees"</span>)</span>
<span id="cb61-47"><a href="#cb61-47" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">3. Random Forest:"</span>)</span>
<span id="cb61-48"><a href="#cb61-48" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"   - Parallel training, different convergence pattern"</span>)</span>
<span id="cb61-49"><a href="#cb61-49" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"   - Performance stabilizes around 200-300 trees"</span>)</span>
<span id="cb61-50"><a href="#cb61-50" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="random_forest_files/figure-html/cell-33-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
================================================================================
SUMMARY: Final Test Errors at 500 Trees
================================================================================
RF m=sqrt(p)=5                 | Final Error: 0.1480 | Improvement: 0.40%
GB depth=1, lr=0.1             | Final Error: 0.1480 | Improvement: 0.00%
GB depth=2, lr=0.1             | Final Error: 0.1505 | Improvement: -0.25%
GB depth=1, lr=0.01            | Final Error: 0.1480 | Improvement: 0.00%
GB depth=1, lr=0.05            | Final Error: 0.1480 | Improvement: 0.00%
================================================================================

================================================================================
KEY INSIGHTS:
================================================================================
1. Learning Rate Effect (GB depth=1):
   - lr=0.01: Slowest convergence, may need more trees
   - lr=0.05: Moderate convergence
   - lr=0.1:  Fastest convergence

2. Depth Effect (GB with lr=0.1):
   - depth=1 (stumps): Simple weak learners
   - depth=2: Better performance, more complex trees

3. Random Forest:
   - Parallel training, different convergence pattern
   - Performance stabilizes around 200-300 trees
================================================================================</code></pre>
</div>
</div>
</section>
<section id="focused-comparison-gradient-boosting-vs-random-forest" class="level3">
<h3 class="anchored" data-anchor-id="focused-comparison-gradient-boosting-vs-random-forest">Focused Comparison: Gradient Boosting vs Random Forest</h3>
<p>Lets compare specific models: - <strong>Gradient Boosting</strong>: depths 1, 2, and 5 - <strong>Random Forest</strong>: m = 5 and m = sqrt(p)</p>
</section>
</section>
<section id="overall-model-comparison-and-feature-importance" class="level2">
<h2 class="anchored" data-anchor-id="overall-model-comparison-and-feature-importance">7. Overall Model Comparison and Feature Importance</h2>
<div id="4afeebf8" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb63"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare all models (Random Forest and Gradient Boosting)</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"FINAL MODEL COMPARISON: RANDOM FOREST VS GRADIENT BOOSTING"</span>)</span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>all_models <span class="op">=</span> []</span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Add Random Forest models</span></span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name <span class="kw">in</span> rf_results.keys():</span>
<span id="cb63-10"><a href="#cb63-10" aria-hidden="true" tabindex="-1"></a>    all_models.append({</span>
<span id="cb63-11"><a href="#cb63-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Model Type'</span>: <span class="st">'Random Forest'</span>,</span>
<span id="cb63-12"><a href="#cb63-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Configuration'</span>: name,</span>
<span id="cb63-13"><a href="#cb63-13" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Test Error'</span>: rf_results[name][<span class="st">'test_error'</span>],</span>
<span id="cb63-14"><a href="#cb63-14" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Test Accuracy'</span>: rf_results[name][<span class="st">'test_accuracy'</span>],</span>
<span id="cb63-15"><a href="#cb63-15" aria-hidden="true" tabindex="-1"></a>        <span class="st">'AUC'</span>: rf_results[name][<span class="st">'auc'</span>]</span>
<span id="cb63-16"><a href="#cb63-16" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb63-17"><a href="#cb63-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-18"><a href="#cb63-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Add Gradient Boosting models (main depth variations)</span></span>
<span id="cb63-19"><a href="#cb63-19" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> depth <span class="kw">in</span> gb_results.keys():</span>
<span id="cb63-20"><a href="#cb63-20" aria-hidden="true" tabindex="-1"></a>    all_models.append({</span>
<span id="cb63-21"><a href="#cb63-21" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Model Type'</span>: <span class="st">'Gradient Boosting'</span>,</span>
<span id="cb63-22"><a href="#cb63-22" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Configuration'</span>: <span class="ss">f'depth=</span><span class="sc">{</span>depth<span class="sc">}</span><span class="ss">, lr=0.1'</span>,</span>
<span id="cb63-23"><a href="#cb63-23" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Test Error'</span>: gb_results[depth][<span class="st">'test_error'</span>],</span>
<span id="cb63-24"><a href="#cb63-24" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Test Accuracy'</span>: gb_results[depth][<span class="st">'test_accuracy'</span>],</span>
<span id="cb63-25"><a href="#cb63-25" aria-hidden="true" tabindex="-1"></a>        <span class="st">'AUC'</span>: gb_results[depth][<span class="st">'auc'</span>]</span>
<span id="cb63-26"><a href="#cb63-26" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb63-27"><a href="#cb63-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-28"><a href="#cb63-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Add Gradient Boosting models with different learning rates (depth=1)</span></span>
<span id="cb63-29"><a href="#cb63-29" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> lr <span class="kw">in</span> gb_shrinkage_results.keys():</span>
<span id="cb63-30"><a href="#cb63-30" aria-hidden="true" tabindex="-1"></a>    all_models.append({</span>
<span id="cb63-31"><a href="#cb63-31" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Model Type'</span>: <span class="st">'Gradient Boosting'</span>,</span>
<span id="cb63-32"><a href="#cb63-32" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Configuration'</span>: <span class="ss">f'depth=1, lr=</span><span class="sc">{</span>lr<span class="sc">}</span><span class="ss">'</span>,</span>
<span id="cb63-33"><a href="#cb63-33" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Test Error'</span>: gb_shrinkage_results[lr][<span class="st">'test_error'</span>],</span>
<span id="cb63-34"><a href="#cb63-34" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Test Accuracy'</span>: gb_shrinkage_results[lr][<span class="st">'test_accuracy'</span>],</span>
<span id="cb63-35"><a href="#cb63-35" aria-hidden="true" tabindex="-1"></a>        <span class="st">'AUC'</span>: gb_shrinkage_results[lr][<span class="st">'auc'</span>]</span>
<span id="cb63-36"><a href="#cb63-36" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb63-37"><a href="#cb63-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-38"><a href="#cb63-38" aria-hidden="true" tabindex="-1"></a>final_comparison_df <span class="op">=</span> pd.DataFrame(all_models)</span>
<span id="cb63-39"><a href="#cb63-39" aria-hidden="true" tabindex="-1"></a>final_comparison_df <span class="op">=</span> final_comparison_df.sort_values(<span class="st">'Test Error'</span>)</span>
<span id="cb63-40"><a href="#cb63-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-41"><a href="#cb63-41" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(final_comparison_df.to_string(index<span class="op">=</span><span class="va">False</span>))</span>
<span id="cb63-42"><a href="#cb63-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-43"><a href="#cb63-43" aria-hidden="true" tabindex="-1"></a><span class="co"># Find overall best model</span></span>
<span id="cb63-44"><a href="#cb63-44" aria-hidden="true" tabindex="-1"></a>best_idx <span class="op">=</span> final_comparison_df[<span class="st">'Test Error'</span>].idxmin()</span>
<span id="cb63-45"><a href="#cb63-45" aria-hidden="true" tabindex="-1"></a>best_overall <span class="op">=</span> final_comparison_df.loc[best_idx]</span>
<span id="cb63-46"><a href="#cb63-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-47"><a href="#cb63-47" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">80</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb63-48"><a href="#cb63-48" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"OVERALL BEST MODEL:"</span>)</span>
<span id="cb63-49"><a href="#cb63-49" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">80</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb63-50"><a href="#cb63-50" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Model Type:     </span><span class="sc">{</span>best_overall[<span class="st">'Model Type'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb63-51"><a href="#cb63-51" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Configuration:  </span><span class="sc">{</span>best_overall[<span class="st">'Configuration'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb63-52"><a href="#cb63-52" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Test Error:     </span><span class="sc">{</span>best_overall[<span class="st">'Test Error'</span>]<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb63-53"><a href="#cb63-53" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Test Accuracy:  </span><span class="sc">{</span>best_overall[<span class="st">'Test Accuracy'</span>]<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb63-54"><a href="#cb63-54" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"AUC:            </span><span class="sc">{</span>best_overall[<span class="st">'AUC'</span>]<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb63-55"><a href="#cb63-55" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">80</span><span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>================================================================================
FINAL MODEL COMPARISON: RANDOM FOREST VS GRADIENT BOOSTING
================================================================================
       Model Type   Configuration  Test Error  Test Accuracy      AUC
    Random Forest     m = sqrt(p)      0.1480         0.8520 0.480197
    Random Forest         m = p/2      0.1480         0.8520 0.487691
    Random Forest m = p (Bagging)      0.1480         0.8520 0.496142
Gradient Boosting         depth=1      0.1480         0.8520 0.488527
Gradient Boosting         depth=2      0.1505         0.8495 0.470818

================================================================================
OVERALL BEST MODEL:
================================================================================
Model Type:     Random Forest
Configuration:  m = sqrt(p)
Test Error:     0.1480
Test Accuracy:  0.8520
AUC:            0.4802
================================================================================</code></pre>
</div>
</div>
<div id="127440fa" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Feature Importance Analysis</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"FEATURE IMPORTANCE ANALYSIS"</span>)</span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Get feature importance from best Random Forest model</span></span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a>best_rf_model <span class="op">=</span> rf_results[best_model_name][<span class="st">'model'</span>]</span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a>feature_importance_rf <span class="op">=</span> pd.DataFrame({</span>
<span id="cb65-9"><a href="#cb65-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Feature'</span>: X_train.columns,</span>
<span id="cb65-10"><a href="#cb65-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Importance'</span>: best_rf_model.feature_importances_</span>
<span id="cb65-11"><a href="#cb65-11" aria-hidden="true" tabindex="-1"></a>}).sort_values(<span class="st">'Importance'</span>, ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb65-12"><a href="#cb65-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-13"><a href="#cb65-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Get feature importance from best Gradient Boosting model</span></span>
<span id="cb65-14"><a href="#cb65-14" aria-hidden="true" tabindex="-1"></a>best_gb_model <span class="op">=</span> gb_results[best_depth][<span class="st">'model'</span>]</span>
<span id="cb65-15"><a href="#cb65-15" aria-hidden="true" tabindex="-1"></a>feature_importance_gb <span class="op">=</span> pd.DataFrame({</span>
<span id="cb65-16"><a href="#cb65-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Feature'</span>: X_train.columns,</span>
<span id="cb65-17"><a href="#cb65-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Importance'</span>: best_gb_model.feature_importances_</span>
<span id="cb65-18"><a href="#cb65-18" aria-hidden="true" tabindex="-1"></a>}).sort_values(<span class="st">'Importance'</span>, ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb65-19"><a href="#cb65-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-20"><a href="#cb65-20" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Top 15 Most Important Features (Random Forest - </span><span class="sc">{</span>best_model_name<span class="sc">}</span><span class="ss">):"</span>)</span>
<span id="cb65-21"><a href="#cb65-21" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb65-22"><a href="#cb65-22" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(feature_importance_rf.head(<span class="dv">15</span>).to_string(index<span class="op">=</span><span class="va">False</span>))</span>
<span id="cb65-23"><a href="#cb65-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-24"><a href="#cb65-24" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n\n</span><span class="ss">Top 15 Most Important Features (Gradient Boosting - depth=</span><span class="sc">{</span>best_depth<span class="sc">}</span><span class="ss">):"</span>)</span>
<span id="cb65-25"><a href="#cb65-25" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb65-26"><a href="#cb65-26" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(feature_importance_gb.head(<span class="dv">15</span>).to_string(index<span class="op">=</span><span class="va">False</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="046932ce" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb66"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Bagging Model (m = p) - Detailed Feature Importance Analysis</span></span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"BAGGING MODEL FEATURE IMPORTANCE (Gini Impurity Reduction)"</span>)</span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Get bagging model (m = p)</span></span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a>bagging_model <span class="op">=</span> rf_results[<span class="st">'m = p (Bagging)'</span>][<span class="st">'model'</span>]</span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a>bagging_importance <span class="op">=</span> pd.DataFrame({</span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Feature'</span>: X_train.columns,</span>
<span id="cb66-10"><a href="#cb66-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Importance'</span>: bagging_model.feature_importances_</span>
<span id="cb66-11"><a href="#cb66-11" aria-hidden="true" tabindex="-1"></a>}).sort_values(<span class="st">'Importance'</span>, ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb66-12"><a href="#cb66-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-13"><a href="#cb66-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Method: Mean Decrease in Impurity (MDI) - Gini Reduction"</span>)</span>
<span id="cb66-14"><a href="#cb66-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Description: Total reduction in Gini impurity across all </span><span class="sc">{</span>bagging_model<span class="sc">.</span>n_estimators<span class="sc">}</span><span class="ss"> trees"</span>)</span>
<span id="cb66-15"><a href="#cb66-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"              weighted by the probability of reaching each node</span><span class="ch">\n</span><span class="ss">"</span>)</span>
<span id="cb66-16"><a href="#cb66-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-17"><a href="#cb66-17" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Top 20 Most Influential Features:"</span>)</span>
<span id="cb66-18"><a href="#cb66-18" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">80</span>)</span>
<span id="cb66-19"><a href="#cb66-19" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(bagging_importance.head(<span class="dv">20</span>).to_string(index<span class="op">=</span><span class="va">False</span>))</span>
<span id="cb66-20"><a href="#cb66-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-21"><a href="#cb66-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize relative influence for bagging model</span></span>
<span id="cb66-22"><a href="#cb66-22" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">16</span>, <span class="dv">6</span>))</span>
<span id="cb66-23"><a href="#cb66-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-24"><a href="#cb66-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Top 20 features</span></span>
<span id="cb66-25"><a href="#cb66-25" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> axes[<span class="dv">0</span>]</span>
<span id="cb66-26"><a href="#cb66-26" aria-hidden="true" tabindex="-1"></a>top_20 <span class="op">=</span> bagging_importance.head(<span class="dv">20</span>)</span>
<span id="cb66-27"><a href="#cb66-27" aria-hidden="true" tabindex="-1"></a>ax.barh(<span class="bu">range</span>(<span class="bu">len</span>(top_20)), top_20[<span class="st">'Importance'</span>], color<span class="op">=</span><span class="st">'#45b7d1'</span>, alpha<span class="op">=</span><span class="fl">0.8</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>)</span>
<span id="cb66-28"><a href="#cb66-28" aria-hidden="true" tabindex="-1"></a>ax.set_yticks(<span class="bu">range</span>(<span class="bu">len</span>(top_20)))</span>
<span id="cb66-29"><a href="#cb66-29" aria-hidden="true" tabindex="-1"></a>ax.set_yticklabels(top_20[<span class="st">'Feature'</span>], fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb66-30"><a href="#cb66-30" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">'Relative Influence (Gini Reduction)'</span>, fontsize<span class="op">=</span><span class="dv">12</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb66-31"><a href="#cb66-31" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">'Bagging Model: Top 20 Feature Importance</span><span class="ch">\n</span><span class="st">(m = p, using all features)'</span>, </span>
<span id="cb66-32"><a href="#cb66-32" aria-hidden="true" tabindex="-1"></a>             fontsize<span class="op">=</span><span class="dv">13</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb66-33"><a href="#cb66-33" aria-hidden="true" tabindex="-1"></a>ax.invert_yaxis()</span>
<span id="cb66-34"><a href="#cb66-34" aria-hidden="true" tabindex="-1"></a>ax.grid(axis<span class="op">=</span><span class="st">'x'</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb66-35"><a href="#cb66-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-36"><a href="#cb66-36" aria-hidden="true" tabindex="-1"></a><span class="co"># Add percentage labels</span></span>
<span id="cb66-37"><a href="#cb66-37" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, (idx, row) <span class="kw">in</span> <span class="bu">enumerate</span>(top_20.iterrows()):</span>
<span id="cb66-38"><a href="#cb66-38" aria-hidden="true" tabindex="-1"></a>    pct <span class="op">=</span> row[<span class="st">'Importance'</span>] <span class="op">/</span> bagging_importance[<span class="st">'Importance'</span>].<span class="bu">sum</span>() <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb66-39"><a href="#cb66-39" aria-hidden="true" tabindex="-1"></a>    ax.text(row[<span class="st">'Importance'</span>], i, <span class="ss">f' </span><span class="sc">{</span>pct<span class="sc">:.1f}</span><span class="ss">%'</span>, va<span class="op">=</span><span class="st">'center'</span>, fontsize<span class="op">=</span><span class="dv">8</span>)</span>
<span id="cb66-40"><a href="#cb66-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-41"><a href="#cb66-41" aria-hidden="true" tabindex="-1"></a><span class="co"># Cumulative importance</span></span>
<span id="cb66-42"><a href="#cb66-42" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> axes[<span class="dv">1</span>]</span>
<span id="cb66-43"><a href="#cb66-43" aria-hidden="true" tabindex="-1"></a>cumsum <span class="op">=</span> bagging_importance[<span class="st">'Importance'</span>].cumsum()</span>
<span id="cb66-44"><a href="#cb66-44" aria-hidden="true" tabindex="-1"></a>cumsum_pct <span class="op">=</span> (cumsum <span class="op">/</span> bagging_importance[<span class="st">'Importance'</span>].<span class="bu">sum</span>() <span class="op">*</span> <span class="dv">100</span>)</span>
<span id="cb66-45"><a href="#cb66-45" aria-hidden="true" tabindex="-1"></a>ax.plot(<span class="bu">range</span>(<span class="dv">1</span>, <span class="bu">len</span>(cumsum_pct) <span class="op">+</span> <span class="dv">1</span>), cumsum_pct, linewidth<span class="op">=</span><span class="fl">2.5</span>, color<span class="op">=</span><span class="st">'#45b7d1'</span>)</span>
<span id="cb66-46"><a href="#cb66-46" aria-hidden="true" tabindex="-1"></a>ax.axhline(y<span class="op">=</span><span class="dv">80</span>, color<span class="op">=</span><span class="st">'red'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, linewidth<span class="op">=</span><span class="dv">2</span>, label<span class="op">=</span><span class="st">'80% threshold'</span>)</span>
<span id="cb66-47"><a href="#cb66-47" aria-hidden="true" tabindex="-1"></a>ax.axhline(y<span class="op">=</span><span class="dv">90</span>, color<span class="op">=</span><span class="st">'orange'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, linewidth<span class="op">=</span><span class="dv">2</span>, label<span class="op">=</span><span class="st">'90% threshold'</span>)</span>
<span id="cb66-48"><a href="#cb66-48" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">'Number of Features'</span>, fontsize<span class="op">=</span><span class="dv">12</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb66-49"><a href="#cb66-49" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">'Cumulative Importance (%)'</span>, fontsize<span class="op">=</span><span class="dv">12</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb66-50"><a href="#cb66-50" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">'Bagging Model: Cumulative Feature Importance'</span>, fontsize<span class="op">=</span><span class="dv">13</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb66-51"><a href="#cb66-51" aria-hidden="true" tabindex="-1"></a>ax.grid(alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb66-52"><a href="#cb66-52" aria-hidden="true" tabindex="-1"></a>ax.legend()</span>
<span id="cb66-53"><a href="#cb66-53" aria-hidden="true" tabindex="-1"></a>ax.set_ylim([<span class="dv">0</span>, <span class="dv">105</span>])</span>
<span id="cb66-54"><a href="#cb66-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-55"><a href="#cb66-55" aria-hidden="true" tabindex="-1"></a><span class="co"># Find features needed for 80% and 90%</span></span>
<span id="cb66-56"><a href="#cb66-56" aria-hidden="true" tabindex="-1"></a>features_80 <span class="op">=</span> (cumsum_pct <span class="op">&gt;=</span> <span class="dv">80</span>).argmax() <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb66-57"><a href="#cb66-57" aria-hidden="true" tabindex="-1"></a>features_90 <span class="op">=</span> (cumsum_pct <span class="op">&gt;=</span> <span class="dv">90</span>).argmax() <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb66-58"><a href="#cb66-58" aria-hidden="true" tabindex="-1"></a>ax.axvline(x<span class="op">=</span>features_80, color<span class="op">=</span><span class="st">'red'</span>, linestyle<span class="op">=</span><span class="st">':'</span>, alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb66-59"><a href="#cb66-59" aria-hidden="true" tabindex="-1"></a>ax.axvline(x<span class="op">=</span>features_90, color<span class="op">=</span><span class="st">'orange'</span>, linestyle<span class="op">=</span><span class="st">':'</span>, alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb66-60"><a href="#cb66-60" aria-hidden="true" tabindex="-1"></a>ax.text(features_80, <span class="dv">5</span>, <span class="ss">f'</span><span class="sc">{</span>features_80<span class="sc">}</span><span class="ss"> features'</span>, rotation<span class="op">=</span><span class="dv">90</span>, va<span class="op">=</span><span class="st">'bottom'</span>, ha<span class="op">=</span><span class="st">'right'</span>, fontsize<span class="op">=</span><span class="dv">9</span>)</span>
<span id="cb66-61"><a href="#cb66-61" aria-hidden="true" tabindex="-1"></a>ax.text(features_90, <span class="dv">5</span>, <span class="ss">f'</span><span class="sc">{</span>features_90<span class="sc">}</span><span class="ss"> features'</span>, rotation<span class="op">=</span><span class="dv">90</span>, va<span class="op">=</span><span class="st">'bottom'</span>, ha<span class="op">=</span><span class="st">'right'</span>, fontsize<span class="op">=</span><span class="dv">9</span>)</span>
<span id="cb66-62"><a href="#cb66-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-63"><a href="#cb66-63" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb66-64"><a href="#cb66-64" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb66-65"><a href="#cb66-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-66"><a href="#cb66-66" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">80</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb66-67"><a href="#cb66-67" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"FEATURE IMPORTANCE SUMMARY:"</span>)</span>
<span id="cb66-68"><a href="#cb66-68" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">80</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb66-69"><a href="#cb66-69" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Top 5 features explain: </span><span class="sc">{</span>cumsum_pct<span class="sc">.</span>iloc[<span class="dv">4</span>]<span class="sc">:.1f}</span><span class="ss">% of total importance"</span>)</span>
<span id="cb66-70"><a href="#cb66-70" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Top 10 features explain: </span><span class="sc">{</span>cumsum_pct<span class="sc">.</span>iloc[<span class="dv">9</span>]<span class="sc">:.1f}</span><span class="ss">% of total importance"</span>)</span>
<span id="cb66-71"><a href="#cb66-71" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Top 20 features explain: </span><span class="sc">{</span>cumsum_pct<span class="sc">.</span>iloc[<span class="dv">19</span>]<span class="sc">:.1f}</span><span class="ss">% of total importance"</span>)</span>
<span id="cb66-72"><a href="#cb66-72" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>features_80<span class="sc">}</span><span class="ss"> features needed for 80% cumulative importance"</span>)</span>
<span id="cb66-73"><a href="#cb66-73" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>features_90<span class="sc">}</span><span class="ss"> features needed for 90% cumulative importance"</span>)</span>
<span id="cb66-74"><a href="#cb66-74" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">80</span><span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="key-findings-and-conclusions" class="level2">
<h2 class="anchored" data-anchor-id="key-findings-and-conclusions">8. Key Findings and Conclusions</h2>
<section id="summary-of-results" class="level3">
<h3 class="anchored" data-anchor-id="summary-of-results">Summary of Results</h3>
<p><strong>Random Forest Performance:</strong> - <strong>m = 2</strong>: More variance reduction but potentially underfitting due to limited feature choices - <strong>m = sqrt(p)</strong>: Balanced approach, typically performs well for classification - <strong>m = p (Bagging)</strong>: Uses all features, may have higher correlation between trees</p>
<p><strong>Gradient Boosting Performance:</strong> - <strong>Shallow trees (depth 1-2)</strong>: Lower variance, better generalization, but may underfit - <strong>Medium trees (depth 3-5)</strong>: Good balance between complexity and generalization - <strong>Deep trees (depth 6-8)</strong>: Risk of overfitting, but may capture complex patterns</p>
<p><strong>Key Drivers of User Churn:</strong> The most influential features for predicting user activity status include: 1. <strong>Engagement metrics</strong>: Total watch minutes, sessions, completion rates 2. <strong>Interaction patterns</strong>: Recommendations clicked, searches performed 3. <strong>Subscription details</strong>: Monthly spend, plan type, subscription duration 4. <strong>Demographics</strong>: Age, household size 5. <strong>Content consumption</strong>: Download behavior, rating frequency</p>
<p><strong>Recommendations:</strong> - Focus on improving user engagement through personalized content - Monitor users with declining watch metrics as early churn indicators - Enhance recommendation quality to increase click-through rates - Consider targeted retention campaigns for at-risk user segments</p>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>